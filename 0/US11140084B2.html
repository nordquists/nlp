
    <html>
        <body>
            <search-app>
                <article class="result" itemscope="" itemtype="http://schema.org/ScholarlyArticle">
    <h1 itemprop="pageTitle">US11140084B2 - TCP/UDP acceleration 
        - Google Patents</h1><section itemprop="abstract" itemscope="">
<h2>Abstract</h2>
<div html="" itemprop="content"><abstract lang="EN" load-source="patent-office" mxw-id="PA465447047">
<div class="abstract" id="p-0001" num="0000">A method for accelerating TCP/UDP packet switching. The method involves determining whether exception processing is necessary; if not, the packet is forwarded to a special stack for expedited processing. Packets requiring exception processing are forwarded to the conventional stack.</div>
</abstract>
</div>
</section><section itemprop="description" itemscope="">
<h2>Description</h2>
<div html="" itemprop="content"><div class="description" lang="EN" load-source="patent-office" mxw-id="PDES304081091">
<heading id="h-0001">CROSS REFERENCE TO RELATED APPLICATIONS</heading>
<div class="description-paragraph" id="p-0002" num="0001">This application is a continuation of U.S. Ser. No. 14/459,539, entitled “TCP/UDP ACCELERATION,” and filed on Aug. 14, 2014, which is a divisional of U.S. Ser. No. 10/415,330, entitled “TCP/UDP ACCELERATION,” and filed on Sep. 3, 2003, which is the National Stage of International Application No. PCT/US2001/045772, entitled “TCP/UDP ACCELERATION,” and filed on Nov. 2, 2001, which claims priority to each of U.S. Ser. No. 60/301,378, entitled “TCP/UDP ACCELERATION METHODS AND SYSTEM,” and filed on Jun. 27, 2001, and U.S. Ser. No. 60/245,295, entitled “STORAGE SYSTEM,” and filed on Nov. 2, 2000; each of the above applications is incorporated herein in full as if set forth in its entirety.</div>
<heading id="h-0002">FIELD OF THE INVENTION</heading>
<div class="description-paragraph" id="p-0003" num="0002">The present invention relates to digital information processing, and particularly to methods, systems and protocols for managing storage in digital networks.</div>
<heading id="h-0003">BACKGROUND OF THE INVENTION</heading>
<div class="description-paragraph" id="p-0004" num="0003">The rapid growth of the Internet and other networked systems has accelerated the need for processing, transferring and managing data in and across networks.</div>
<div class="description-paragraph" id="p-0005" num="0004">In order to meet these demands, enterprise storage architectures have been developed, which typically provide access to a physical storage pool through multiple independent SCSI channels interconnected with storage via multiple front-end and back-end processors/controllers. Moreover, in data networks based on IP/Ethernet technology, standards have been developed to facilitate network management. These standards include Ethernet, Internet Protocol (IP), Internet Control Message Protocol (ICMP), Management Information Block (MIB) and Simple Network Management Protocol (SNMP). Network Management Systems (NMSs) such as HP Open View utilize these standards to discover and monitor network devices. Examples of networked architectures are disclosed in the following patent documents, the disclosures of which are incorporated herein by reference:</div>
<div class="description-paragraph" id="p-0006" num="0005">U.S. Pat. No. 5,941, 972 Crossroads Systems, Inc.</div>
<div class="description-paragraph" id="p-0007" num="0006">U.S. Pat. No. 6,000,020 Gadzoox Network, Inc.</div>
<div class="description-paragraph" id="p-0008" num="0007">U.S. Pat. No. 6,041,381 Crossroads Systems, Inc.</div>
<div class="description-paragraph" id="p-0009" num="0008">U.S. Pat. No. 6,061,358 McData Corporation</div>
<div class="description-paragraph" id="p-0010" num="0009">U.S. Pat. No. 6,067,545 Hewlett-Packard Company</div>
<div class="description-paragraph" id="p-0011" num="0010">U.S. Pat. No. 6,118,776 Vixel Corporation</div>
<div class="description-paragraph" id="p-0012" num="0011">U.S. Pat. No. 6,128,656 Cisco Technology, Inc.</div>
<div class="description-paragraph" id="p-0013" num="0012">U.S. Pat. No. 6,138,161 Crossroads Systems, Inc.</div>
<div class="description-paragraph" id="p-0014" num="0013">U.S. Pat. No. 6,148,421 Crossroads Systems, Inc.</div>
<div class="description-paragraph" id="p-0015" num="0014">U.S. Pat. No. 6,151,331 Crossroads Systems, Inc.</div>
<div class="description-paragraph" id="p-0016" num="0015">U.S. Pat. No. 6,199,112 Crossroads Systems, Inc.</div>
<div class="description-paragraph" id="p-0017" num="0016">U.S. Pat. No. 6,205,141 Crossroads Systems, Inc.</div>
<div class="description-paragraph" id="p-0018" num="0017">U.S. Pat. No. 6,247,060 Alacritech, Inc.</div>
<div class="description-paragraph" id="p-0019" num="0018">WO 01/59966 Nishan Systems, Inc.</div>
<div class="description-paragraph" id="p-0020" num="0019">Conventional systems, however, do not enable seamless connection and interoperability among disparate storage platforms and protocols. Storage Area Networks (SANs) typically use a completely different set of technology based on Fibre Channel (FC) to build and manage storage networks. This has led to a “re-inventing of the wheel” in many cases. Users are often require to deal with multiple suppliers of routers, switches, host bus adapters and other components, some of which are not well-adapted to communicate with one another. Vendors and standards bodies continue to determine the protocols to be used to interface devices in SANs and NAS configurations; and SAN devices do not integrate well with existing IP-based management systems.</div>
<div class="description-paragraph" id="p-0021" num="0020">Still further, the storage devices (Disks, RAID Arrays, and the like), which are Fibre Channel attached to the SAN devices, typically do not support IP (and the SAN devices have limited IP support) and the storage devices cannot be discovered/managed by IP-based management systems. There are 2 essentially two sets of management products-one for the IP devices and one for the storage devices.</div>
<div class="description-paragraph" id="p-0022" num="0021">Accordingly, it is desirable to enable servers, storage and network-attached storage (NAS) devices, IP and Fibre Channel switches on storage-area networks (SAN), WANs or LANs to interoperate to provide improved storage data transmission across enterprise networks.</div>
<div class="description-paragraph" id="p-0023" num="0022">In addition, among the most widely used protocols for communications within and among networks, TCP/IP (TCP/internet Protocol) is the suite of communications protocols used to connect hosts on the Internet. TCP provides reliable, virtual circuit, end-to-end connections for transporting data packets between nodes in a network. Implementation examples are set forth in the following patent and other publications, the disclosures of which are incorporated herein by reference:</div>
<div class="description-paragraph" id="p-0024" num="0023">U.S. Pat. No. 5,260,942 IBM</div>
<div class="description-paragraph" id="p-0025" num="0024">U.S. Pat. No. 5,442,637 ATT</div>
<div class="description-paragraph" id="p-0026" num="0025">U.S. Pat. No. 5,566,170 Storage Technology Corporation</div>
<div class="description-paragraph" id="p-0027" num="0026">U.S. Pat. No. 5,598,410 Storage Technology Corporation</div>
<div class="description-paragraph" id="p-0028" num="0027">U.S. Pat. No. 5,598,410 Storage Technology Corporation</div>
<div class="description-paragraph" id="p-0029" num="0028">U.S. Pat. No. 6,006,259 Network Alchemy, Inc.</div>
<div class="description-paragraph" id="p-0030" num="0029">U.S. Pat. No. 6,018,530 Sham Chakravorty</div>
<div class="description-paragraph" id="p-0031" num="0030">U.S. Pat. No. 6,122,670 TSI Telsys, Inc.</div>
<div class="description-paragraph" id="p-0032" num="0031">U.S. Pat. No. 6,163, 812 IBM</div>
<div class="description-paragraph" id="p-0033" num="0032">U.S. Pat. No. 6,178,448 IBM</div>
<div class="description-paragraph" id="p-0034" num="0033">“TCP/IP Illustrated Volume 2”, Wright, Stevens;</div>
<div class="description-paragraph" id="p-0035" num="0034">“SCSI over TCP”, IETF draft, IBM, CISCO, Sangate, February 2000;</div>
<div class="description-paragraph" id="p-0036" num="0035">“The SCSI Encapsulation Protocol (SEP)”, IETF draft, Adaptec Inc., May 2000;</div>
<div class="description-paragraph" id="p-0037" num="0036">RFC <b>793</b> “Transmission Control Protocol”, September 1981.</div>
<div class="description-paragraph" id="p-0038" num="0037">Although TCP is useful, it requires substantial processing by the system CPU, thus limiting throughput and system performance. Designers have attempted to avoid this limitation through various inter-processor communications techniques, some of which are described in the above-cited publications. For example, some have offloaded TCP processing tasks to an auxiliary CPU, which can reside on an intelligent network interface or similar device, thereby reducing load on the system CPU. However, this approach does not eliminate the problem, but merely moves it elsewhere in the system, where it remains a single chokepoint of performance limitation.</div>
<div class="description-paragraph" id="p-0039" num="0038">Others have identified separable components of TCP processing and implemented them in specialized hardware. These can include calculation or verification of TCP checksums over the data being transmitted, and the appending or removing of fixed protocol headers to or from such data. These approaches are relatively simple to implement in hardware to the extent they perform only simple, condition-invariant manipulations, and do not themselves cause a change to be applied to any persistent TCP state variables. However, while these approaches somewhat reduce system CPU load, they have not been observed to provide substantial performance gains.</div>
<div class="description-paragraph" id="p-0040" num="0039">Some required components of TCP, such as retransmission of a TCP segment following a timeout, are difficult to implement in hardware, because of their complex and condition-dependent behavior. For this reason, systems designed to perform substantial TCP processing in hardware often include a dedicated CPU capable of handling these exception conditions. Alternatively, such systems may decline to handle TCP segment retransmission or other complex events and instead defer their processing to the system CPU.</div>
<div class="description-paragraph" id="p-0041" num="0040">However, a major difficulty in implementing such “fast path/slow path” solutions is ensuring that the internal state of the TCP connections, which can be modified as a result of performing these operations, is consistently maintained, whether the operations are performed by the “fast path” hardware or by the “slow path” system CPU.</div>
<div class="description-paragraph" id="p-0042" num="0041">It is therefore desirable to provide methods, devices and systems that simplify and improve these operations.</div>
<div class="description-paragraph" id="p-0043" num="0042">It is also desirable to provide methods, devices and systems that simplify management of storage in digital networks, and enable flexible deployment of NAS, SAN and other storage systems, and Fibre Channel (FC), IP/Ethernet and other protocols, with storage subsystem and location independence.</div>
<heading id="h-0004">SUMMARY OF THE INVENTION</heading>
<div class="description-paragraph" id="p-0044" num="0043">The invention addresses the noted problems typical of prior art systems, and in one aspect, provides a switch system having a first configurable set of processor elements to process storage resource connection requests, a second configurable set of processor elements capable of communications with the first configurable set of processor elements to receive, from the first configurable set of processor elements, storage connection requests representative of client requests, and to route the requests to at least one of the storage elements, and a configurable switching fabric interconnected between the first and second sets of processor elements, for receiving at least a first storage connection request from one of the first set of processor elements, determining an appropriate one of the second set of processors for processing the storage connection request, automatically configuring the storage connection request in accordance with a protocol utilized by the selected one of the second set of processors, and forwarding the storage connection request to the selected one of the second set of processors for routing to at least one of the storage elements.</div>
<div class="description-paragraph" id="p-0045" num="0044">Another aspect of the invention provides methods, systems and devices for enabling data replication under NFS servers.</div>
<div class="description-paragraph" id="p-0046" num="0045">A further aspect of the invention provides mirroring of NFS servers using a multicast function.</div>
<div class="description-paragraph" id="p-0047" num="0046">Yet another aspect of the invention provides dynamic content replication under NFS servers.</div>
<div class="description-paragraph" id="p-0048" num="0047">In another aspect, the invention provides load balanced NAS using a hashing or similar function, and dynamic data grooming and NFS load balancing across NFS servers.</div>
<div class="description-paragraph" id="p-0049" num="0048">The invention also provides, in a further aspect, domain sharing across multiple FC switches, and secure virtual storage domains (SVSD).</div>
<div class="description-paragraph" id="p-0050" num="0049">Still another aspect of the invention provides TCP/UDP acceleration, with IP stack bypass using a network processors (NP). The present invention simultaneously maintaining TCP state information in both the fast path and the slow path. Control messages are exchanged between the fast path and slow path processing engines to maintain state synchronization, and to hand off control from one processing engine to another. These control messages can be optimized to require minimal processing in the slow path engines (e.g., system CPU) while enabling efficient implementation in the fast path hardware.</div>
<div class="description-paragraph" id="p-0051" num="0050">This distributed synchronization approach significantly accelerates TCP processing, but also provides additional benefits, in that it permits the creation of more robust systems.</div>
<div class="description-paragraph" id="p-0052" num="0051">The invention, in another aspect, also enables automatic discovery of SCSI devices over an IP network, and mapping of SNMP requests to SCSI.</div>
<div class="description-paragraph" id="p-0053" num="0052">In addition, the invention also provides WAN mediation caching on local devices.</div>
<div class="description-paragraph" id="p-0054" num="0053">Each of these aspects will next be described in detail, with reference to the attached drawing figures.</div>
<description-of-drawings>
<heading id="h-0005">BRIEF DESCRIPTION OF THE DRAWINGS</heading>
<div class="description-paragraph" id="p-0055" num="0054"> <figref idrefs="DRAWINGS">FIG. 1</figref> depicts a hardware architecture of one embodiment of the switch system aspect of the invention.</div>
<div class="description-paragraph" id="p-0056" num="0055"> <figref idrefs="DRAWINGS">FIG. 2</figref> depicts interconnect architecture useful in the embodiment of <figref idrefs="DRAWINGS">FIG. 1</figref>.</div>
<div class="description-paragraph" id="p-0057" num="0056"> <figref idrefs="DRAWINGS">FIG. 3</figref> depicts processing and switching modules.</div>
<div class="description-paragraph" id="p-0058" num="0057"> <figref idrefs="DRAWINGS">FIG. 4</figref> depicts software architecture in accordance with one embodiment of the invention.</div>
<div class="description-paragraph" id="p-0059" num="0058"> <figref idrefs="DRAWINGS">FIG. 5</figref> depicts detail of the client abstraction layer.</div>
<div class="description-paragraph" id="p-0060" num="0059"> <figref idrefs="DRAWINGS">FIG. 6</figref> depicts the storage abstraction layer.</div>
<div class="description-paragraph" id="p-0061" num="0060"> <figref idrefs="DRAWINGS">FIG. 7</figref> depicts saleable NAS.</div>
<div class="description-paragraph" id="p-0062" num="0061"> <figref idrefs="DRAWINGS">FIG. 8</figref> depicts replicated local/remote storage.</div>
<div class="description-paragraph" id="p-0063" num="0062"> <figref idrefs="DRAWINGS">FIG. 9</figref> depicts a software structure useful in one embodiment of the invention.</div>
<div class="description-paragraph" id="p-0064" num="0063"> <figref idrefs="DRAWINGS">FIG. 9<i>a </i> </figref>depicts the MIC and MLAN components of <figref idrefs="DRAWINGS">FIG. 9</figref> </div>
<div class="description-paragraph" id="p-0065" num="0064"> <figref idrefs="DRAWINGS">FIG. 9<i>b </i> </figref>depicts the MLAN, LIC and SRC-NAS and fabric components of <figref idrefs="DRAWINGS">FIG. 9</figref> </div>
<div class="description-paragraph" id="p-0066" num="0065"> <figref idrefs="DRAWINGS">FIG. 9<i>c </i> </figref>depicts the SRC-Mediator component and fabric of <figref idrefs="DRAWINGS">FIG. 9</figref> </div>
<div class="description-paragraph" id="p-0067" num="0066"> <figref idrefs="DRAWINGS">FIG. 10</figref> depicts system services.</div>
<div class="description-paragraph" id="p-0068" num="0067"> <figref idrefs="DRAWINGS">FIG. 11</figref> depicts a management software overview.</div>
<div class="description-paragraph" id="p-0069" num="0068"> <figref idrefs="DRAWINGS">FIG. 12</figref> depicts a virtual storage domain.</div>
<div class="description-paragraph" id="p-0070" num="0069"> <figref idrefs="DRAWINGS">FIG. 13</figref> depicts another virtual storage domain.</div>
<div class="description-paragraph" id="p-0071" num="0070"> <figref idrefs="DRAWINGS">FIG. 14</figref> depicts configuration processing boot-up sequence.</div>
<div class="description-paragraph" id="p-0072" num="0071"> <figref idrefs="DRAWINGS">FIG. 15</figref> depicts a further virtual storage domain example.</div>
<div class="description-paragraph" id="p-0073" num="0072"> <figref idrefs="DRAWINGS">FIG. 16</figref> is a flow chart of NFS mirroring and related functions.</div>
<div class="description-paragraph" id="p-0074" num="0073"> <figref idrefs="DRAWINGS">FIG. 17</figref> depicts interface module software.</div>
<div class="description-paragraph" id="p-0075" num="0074"> <figref idrefs="DRAWINGS">FIG. 18</figref> depicts an flow control example.</div>
<div class="description-paragraph" id="p-0076" num="0075"> <figref idrefs="DRAWINGS">FIG. 19</figref> depicts hardware in an SRC.</div>
<div class="description-paragraph" id="p-0077" num="0076"> <figref idrefs="DRAWINGS">FIG. 20</figref> depicts SRC NAS software modules.</div>
<div class="description-paragraph" id="p-0078" num="0077"> <figref idrefs="DRAWINGS">FIG. 21</figref> depicts SCSI/UDP operation.</div>
<div class="description-paragraph" id="p-0079" num="0078"> <figref idrefs="DRAWINGS">FIG. 22</figref> depicts SRC software storage components.</div>
<div class="description-paragraph" id="p-0080" num="0079"> <figref idrefs="DRAWINGS">FIG. 23</figref> depicts FC originator/FC target operation.</div>
<div class="description-paragraph" id="p-0081" num="0080"> <figref idrefs="DRAWINGS">FIG. 24</figref> depicts load balancing NFS client requests between NFS servers.</div>
<div class="description-paragraph" id="p-0082" num="0081"> <figref idrefs="DRAWINGS">FIG. 25</figref> depicts NFS receive micro-code flow.</div>
<div class="description-paragraph" id="p-0083" num="0082"> <figref idrefs="DRAWINGS">FIG. 25A</figref> depicts one portion of the NFS receive micro-code flow of <figref idrefs="DRAWINGS">FIG. 25</figref>.</div>
<div class="description-paragraph" id="p-0084" num="0083"> <figref idrefs="DRAWINGS">FIG. 25B</figref> depicts another portion of the NFS receive micro-code flow of <figref idrefs="DRAWINGS">FIG. 25</figref>.</div>
<div class="description-paragraph" id="p-0085" num="0084"> <figref idrefs="DRAWINGS">FIG. 26</figref> depicts NFS transmit micro-code flow.</div>
<div class="description-paragraph" id="p-0086" num="0085"> <figref idrefs="DRAWINGS">FIG. 27</figref> depicts file handle entry into multiple server lists.</div>
<div class="description-paragraph" id="p-0087" num="0086"> <figref idrefs="DRAWINGS">FIG. 28</figref> depicts a sample network configuration in another embodiment of the invention.</div>
<div class="description-paragraph" id="p-0088" num="0087"> <figref idrefs="DRAWINGS">FIG. 29</figref> depicts an example of a virtual domain configuration.</div>
<div class="description-paragraph" id="p-0089" num="0088"> <figref idrefs="DRAWINGS">FIG. 30</figref> depicts an example of a VLAN configuration.</div>
<div class="description-paragraph" id="p-0090" num="0089"> <figref idrefs="DRAWINGS">FIG. 31</figref> depicts a mega-proxy example.</div>
<div class="description-paragraph" id="p-0091" num="0090"> <figref idrefs="DRAWINGS">FIG. 32</figref> depicts device discovery in accordance with another aspect of the invention.</div>
<div class="description-paragraph" id="p-0092" num="0091"> <figref idrefs="DRAWINGS">FIG. 33</figref> depicts SNMP/SCSI mapping.</div>
<div class="description-paragraph" id="p-0093" num="0092"> <figref idrefs="DRAWINGS">FIG. 34</figref> SCSI response/SNMP trap mapping.</div>
<div class="description-paragraph" id="p-0094" num="0093"> <figref idrefs="DRAWINGS">FIG. 35</figref> depicts data structures useful in another aspect of the invention.</div>
<div class="description-paragraph" id="p-0095" num="0094"> <figref idrefs="DRAWINGS">FIG. 36</figref> depicts mirroring and load balancing operation.</div>
<div class="description-paragraph" id="p-0096" num="0095"> <figref idrefs="DRAWINGS">FIG. 37</figref> depicts server classes.</div>
<div class="description-paragraph" id="p-0097" num="0096"> <figref idrefs="DRAWINGS">FIGS. 38A, 38B, 38C</figref> depict mediation configurations in accordance with another aspect of the invention.</div>
<div class="description-paragraph" id="p-0098" num="0097"> <figref idrefs="DRAWINGS">FIG. 39</figref> depicts operation of mediation protocol engines.</div>
<div class="description-paragraph" id="p-0099" num="0098"> <figref idrefs="DRAWINGS">FIG. 40</figref> depicts configuration of storage by the volume manager in accordance with another aspect of the invention.</div>
<div class="description-paragraph" id="p-0100" num="0099"> <figref idrefs="DRAWINGS">FIG. 41</figref> depicts data structures for keeping track of virtual devices and sessions.</div>
<div class="description-paragraph" id="p-0101" num="0100"> <figref idrefs="DRAWINGS">FIG. 42</figref> depicts mediation manager operation in accordance with another aspect of the invention.</div>
<div class="description-paragraph" id="p-0102" num="0101"> <figref idrefs="DRAWINGS">FIG. 43</figref> depicts mediation in accordance with one practice of the invention.</div>
<div class="description-paragraph" id="p-0103" num="0102"> <figref idrefs="DRAWINGS">FIG. 44</figref> depicts mediation in accordance with another practice of the invention.</div>
<div class="description-paragraph" id="p-0104" num="0103"> <figref idrefs="DRAWINGS">FIG. 45</figref> depicts fast-path architecture in accordance with the invention.</div>
<div class="description-paragraph" id="p-0105" num="0104"> <figref idrefs="DRAWINGS">FIG. 46</figref> depicts IXP packet receive processing for mediation.</div>
</description-of-drawings>
<heading id="h-0006">DETAILED DESCRIPTION</heading>
<div class="description-paragraph" id="h-0007" num="0000">I. Overview</div>
<div class="description-paragraph" id="p-0106" num="0105"> <figref idrefs="DRAWINGS">FIG. 1</figref> depicts the hardware architecture of one embodiment of a switch system according to the invention. As shown therein, the switch system <b>100</b> is operable to interconnect clients and storage. As discussed in detail below, storage processor elements <b>104</b> (SPs) connect to storage; IP processor elements <b>102</b> (IP) connect to clients or other devices; and a high speed switch fabric <b>106</b> interconnects the IP and SP elements, under the control of control elements <b>103</b>.</div>
<div class="description-paragraph" id="p-0107" num="0106">The IP processors provide content-aware switching, load balancing, mediation, TCP/UDP hardware acceleration, and fast forwarding, all as discussed in greater detail below. In one embodiment, the high speed fabric comprises redundant control processors and a redundant switching fabric, provides salable port density and is media-independent. As described below, the switch fabric enables media-independent module interconnection, and supports low-latency Fibre Channel (F/C) switching. In an embodiment of the invention commercially available from the assignee of this application, the fabric maintains QoS for Ethernet traffic, is salable from 16 to 256 Gbps, and can be provisioned as fully redundant switching fabric with fully redundant control processors, ready for 10 Gb Ethernet, InfiniBand and the like. The SPs support NAS (NFS/CIFS), mediation, volume management, Fibre Channel (F/C) switching, SCSI and RAID services.</div>
<div class="description-paragraph" id="p-0108" num="0107"> <figref idrefs="DRAWINGS">FIG. 2</figref> depicts an interconnect architecture adapted for use in the switching system <b>100</b> of <figref idrefs="DRAWINGS">FIG. 1</figref>. As shown therein, the architecture includes multiple processors interconnected by dual paths <b>110</b>,<b>120</b>. Path <b>110</b> is a management and control path adapted for operation in accordance with switched Ethernet. Path <b>120</b> is a high speed switching fabric, supporting a point to point serial interconnect. Also as shown in <figref idrefs="DRAWINGS">FIG. 2</figref>, front-end processors include SFCs <b>130</b>, LAN Resource Cards (LRCs) <b>132</b>, and Storage Resource Cards (SRCs) <b>134</b>, which collectively provide processing power for the functions described below. Rear-end processors include MICs <b>136</b>, LIOs <b>138</b> and Slows <b>140</b>, which collectively provide wiring and control for the functions described below.</div>
<div class="description-paragraph" id="p-0109" num="0108">In particular, the LRCs provide interfaces to external LANs, servers, WANs and the like (such as by 4 × Gigabit Ethernet or 32×10/100 Base-T Ethernet interface adapters); perform load balancing, content-aware switching of internal services; implement storage mediation protocols; and provide TCP hardware acceleration.</div>
<div class="description-paragraph" id="p-0110" num="0109">The SRCs interface to external storage or other devices (such as via Fibre Channel, 1 or 2 Gbps, FC-AL or FC-N) As shown in <figref idrefs="DRAWINGS">FIG. 3</figref>, LRCs and LIOs are network processors providing LAN-related functions. They can include GBICs and RJ45 processors. MlCs provide control and management. As discussed below, the switching system utilizes redundant MICs and redundant fabrics. The FlOs shown in <figref idrefs="DRAWINGS">FIG. 3</figref> provide F/C switching. These modules can be commercially available ASIC- based F/C switch elements, and collectively enable low cost, high-speed SAN using the methods described below.</div>
<div class="description-paragraph" id="p-0111" num="0110"> <figref idrefs="DRAWINGS">FIG. 4</figref> depicts a software architecture adapted for use in an embodiment of switching system <b>100</b>, wherein a management layer <b>402</b> interconnects with client services <b>404</b>, mediation services <b>406</b>, storage services <b>408</b>, a client abstraction layer <b>410</b>, and a storage abstraction layer <b>412</b>. In turn, the client abstraction layer interconnects with client interfaces (LAN, SAN or other) <b>414</b>, and the storage abstraction layer interconnects with storage devices or storage interfaces (LAN, SAN or other) <b>416</b>.</div>
<div class="description-paragraph" id="p-0112" num="0111">The client abstraction layer isolates, secures, and protects internal resources; enforces external group isolation and user authentication; provides firewall access security; supports redundant network access with fault failover, and integrates IP routing and multiport LAN switching. It addition, it presents external clients with virtual service“ abstraction of internal services, so that there is no need to reconfigure clients when services are changed. Further, it provides internal services a consistent network interface, wherein service configuration is independent of network connectivity, and there is no impact from VLAN topology, multihoming or peering.</div>
<div class="description-paragraph" id="p-0113" num="0112"> <figref idrefs="DRAWINGS">FIG. 5</figref> provides detail of the client abstraction layer. As shown therein, it can include TCP acceleration function <b>502</b> (which, among other activities, offloads processing reliable data streams); load balancing function <b>504</b> (which distributes requests among equivalent resources); content-aware switching <b>506</b> (which directs requests to an appropriate resource based on the contents of the requests/packets); virtualization function <b>508</b> (which provides isolation and increased security); 802.1 switching and IP routing function <b>510</b> (which supports link/path redundancy), and physical I/F support functions <b>512</b> (which can support 10/100 Base-T, Gigabit Ethernet, Fibre Channel and the like).</div>
<div class="description-paragraph" id="p-0114" num="0113">In addition, an internal services layer provides protocol mediation, supports NAS and switching and routing. In particular, in FISCS) applications the internal services layer uses TCP/IP or the like to provide LAN-attached servers with access to block-oriented storage; in FC/IP it interconnects Fibre Channel SAN“islands” across an Internet backbone; and in IP/FC applications it extends IP connectivity across Fibre Channel. Among NAS functions, the internal services layer includes support for NFS (industry-standard Network File Service, provided over UDP/IP (LAN) or TCP/IP (WAN); and CIFS (compatible with Microsoft Windows File Services, also known as SMB. Among switching and routing functions, the internal services layer supports Ethernet, Fibre Channel and the like.</div>
<div class="description-paragraph" id="p-0115" num="0114">The storage abstraction layer shown in <figref idrefs="DRAWINGS">FIG. 6</figref> includes file system <b>602</b>, volume management <b>604</b>, RAID function <b>606</b>, storage access processing <b>608</b>, transport processing <b>610</b> an physical I/F support <b>612</b>. File system layer <b>602</b> supports multiple file systems; the volume management layer creates and manages logical storage partitions; the RAID layer enables optional data replication; the storage access processing layer supports SCSI or similar protocols, and the transport layer is adapted for Fibre Channel or SCSI support. The storage abstraction layer consolidates external disk drives, storage arrays and the like into a sharable, pooled resource; and provides volume management that allows dynamically resizeable storage partitions to be created within the pool; RAID service that enables volume replication for data redundancy, improved performance; and file service that allows creation of distributed, sharable file systems on any storage partition.</div>
<div class="description-paragraph" id="p-0116" num="0115">A technical advantage of this configuration is that a single storage system can be used for both file and block storage access (NAS and SAN).</div>
<div class="description-paragraph" id="p-0117" num="0116"> <figref idrefs="DRAWINGS">FIGS. 7 and 8</figref> depict examples of data flows through the switching system <b>100</b>. (It will be noted that these configurations are provided solely by way of example, and that other configurations are possible.) In particular, as will be discussed in greater detail below, <figref idrefs="DRAWINGS">FIG. 7</figref> depicts a saleable NAS example, while <figref idrefs="DRAWINGS">FIG. 8</figref> depicts a replicated local/remote storage example. As shown in <figref idrefs="DRAWINGS">FIG. 7</figref>, the switch system <b>100</b> includes secure virtual storage domain (SVSD) management layer <b>702</b>, NFS servers collectively referred to by numeral <b>704</b>, and modules <b>706</b> and <b>708</b>.</div>
<div class="description-paragraph" id="p-0118" num="0117">Gigabit module <b>706</b> contains TCP <b>710</b>, load balancing <b>712</b>, content-aware switching <b>714</b>, virtualization <b>716</b>,<b>802</b>. <b>1</b> switching and IP routing <b>718</b>, and Gigabit (GV) optics collectively referred to by numeral <b>720</b>.</div>
<div class="description-paragraph" id="p-0119" num="0118">FC module <b>708</b> contains file system <b>722</b>, volume management <b>724</b>, RAID <b>726</b>, SCSI <b>728</b>, Fibre Channel <b>730</b>, and FC optics collectively referred to by numeral <b>731</b>.</div>
<div class="description-paragraph" id="p-0120" num="0119">As shown in the saleable NAS example of <figref idrefs="DRAWINGS">FIG. 7</figref>, the switch system <b>100</b> connects clients on multiple Gigabit Ethernet LANs <b>732</b> (or similar) to (1) unique content on separate storage <b>734</b> and replicated filesystems for commonly accessed files <b>736</b>. The data pathways depicted run from the clients, through the GB optics, <b>802</b>.<b>1</b> switching and IP routing, virtualization, content-aware switching, load balancing and TCP, into the NFS servers (under the control/configuration of SVSD management), and into the file system, volume management, RAID, SCSCI, Fibre Channel, and FC optics to the unique content (which bypasses RAID), and replicated filesystems (which flows through RAID).</div>
<div class="description-paragraph" id="p-0121" num="0120">Similar structures are shown in the replicated local/remote storage example of <figref idrefs="DRAWINGS">FIG. 8</figref>. However, in this case, the interconnection is between clients on Gigagbit Ethernet LAN (or similar) <b>832</b>, secondary storage at an offsite location via a TCP/IP network <b>834</b>, and locally attached primary storage <b>836</b>. In this instance, the flow is from the clients, through the GB optics, <b>802</b>.<b>1</b> switching and IP routing, virtualization, content-aware switching, load: balancing and TCP, then through FISCS) mediation services <b>804</b> (under the control/configuration of SVSD management <b>802</b>), then through volume management <b>824</b>, and RAID <b>826</b>. Then, one flow is from RAID <b>826</b> through SCSI <b>828</b>, Fibre Channel <b>830</b> and FC Optics <b>831</b> to the locally attached storage <b>836</b>; while another flow is from RAID <b>826</b> back to TCP <b>810</b>, load balancing <b>812</b>, content-aware switching <b>814</b>, virtualization <b>816</b>,<b>802</b>. <b>1</b> switching and IP routing <b>818</b> and GB optics <b>820</b> to secondary storage at an offsite location via a TCP/IP network <b>834</b>.</div>
<div class="description-paragraph" id="h-0008" num="0000">II. Hardware/Software Architecture</div>
<div class="description-paragraph" id="p-0122" num="0121">This section provides an overview of the structure and function of the invention (alternatively referred to hereinafter as the “Pirus box”). In one embodiment, the Pirus box is a 6 slot, carrier class, high performance, multi-layer switch, architected to be the core of the data storage infrastructure. The Pirus box will be useful for ASPs (Application Storage Providers), SSPs (Storage Service Providers) and large enterprise networks. One embodiment of the Pirus box will support Network Attached Storage (NAS) in the form of NFS attached disks off of Fibre Channel ports. These attached disks are accessible via 10/100/1000 switched Ethernet ports. The Pirus box will also support standard layer 2 and Layer 3 switching with port-based VLAN support, and layer 3 routing (on unlearned addresses). RIP will be one routing protocol supported, with OSPF and others also to be supported. The Pirus box will also initiate and terminate a wide range of SCSI mediation protocols, allowing access to the storage media either via Ethernet or SCSI/FC. The box is manageable via a CLI, SNMP or an HTTP interface.</div>
<div class="description-paragraph" id="p-0123" num="0122">1. Software Architecture Overview</div>
<div class="description-paragraph" id="p-0124" num="0123"> <figref idrefs="DRAWINGS">FIG. 9</figref> is a block diagram illustrating the software modules used in the Pirus box (the terms of which are defined in the glossary set forth below). As shown in <figref idrefs="DRAWINGS">FIG. 9</figref>, the software structures correspond to MIC <b>902</b>, LIC <b>904</b>, SRC-NAS <b>908</b> and SRC-Mediator <b>910</b>, interconnected by MLAN <b>905</b> and fabric <b>906</b>. The operation of each of the components shown in the drawing is discussed below.</div>
<div class="description-paragraph" id="p-0125" num="0124">1.1 System Services</div>
<div class="description-paragraph" id="p-0126" num="0125">The term System Service is used herein to denote a significant function that is provided on every processor in every slot. It is contemplated that many such services will be provided; and that they can be segmented into 2 categories: 1) abstracted hardware services and 2) client/server services. The attached <figref idrefs="DRAWINGS">FIG. 10</figref> is a diagram of some of the exemplary interfaces. As shown in <figref idrefs="DRAWINGS">FIG. 10</figref>, the system services correspond to IPCs <b>1002</b> and <b>1004</b> associated with fabric and control channel <b>1006</b>, and with services SCSI <b>1008</b>, RSS <b>1010</b>, NPCS <b>1012</b>, AM <b>1014</b>, Log/Event <b>1016</b>, Cache/Bypass <b>1018</b>, TCP/IP <b>1020</b>, and SM <b>1022</b>.</div>
<div class="description-paragraph" id="p-0127" num="0126">1.1.1 SanStreaM (SSM) System Services (S2)</div>
<div class="description-paragraph" id="p-0128" num="0127">SSM system service can be defined as a service that provides a software API layer to application software while“hiding” the underlying hardware control. These services may add value to the process by adding protocol layering or robustness to the standard hardware functionality.</div>
<div class="description-paragraph" id="p-0129" num="0128">System services that are provided include:</div>
<div class="description-paragraph" id="p-0130" num="0129">Card Processor Control Manager (CPCM). This service provides a mechanism to detect and manage the issues involved in controlling a Network Engine Card (NEC) and its associated Network Processors (NP). They include insertion and removal, temperature control, crash management, loader, watchdog, failures etc.</div>
<div class="description-paragraph" id="p-0131" num="0130">Local Hardware Control (LHC). This controls the hardware local to the board itself. It includes LEDS, fans, and power.</div>
<div class="description-paragraph" id="p-0132" num="0131">Inter-Processor Communication (IPC). This includes control bus and fabric services, and remote UART.</div>
<div class="description-paragraph" id="p-0133" num="0132">1.1.2 SSM Application Service (AS)</div>
<div class="description-paragraph" id="p-0134" num="0133">Application services provide an API on top of SSM system services. They are useful for executing functionality remotely. Application Services include:</div>
<div class="description-paragraph" id="p-0135" num="0134">Remote Shell Service (RSS)-includes redirection of debug and other valuable info to any pipe in the system.</div>
<div class="description-paragraph" id="p-0136" num="0135">Statistics Provider-providers register with the stats consumer to provide the needed information such as mib read only attributes.</div>
<div class="description-paragraph" id="p-0137" num="0136">Network Processor Config Service (NPCS)-used to receive and process configuration requests.</div>
<div class="description-paragraph" id="p-0138" num="0137">Action Manager-used to send and receive requests to execute remote functionality such as rebooting, clearing stats and re-syncing with a file system.</div>
<div class="description-paragraph" id="p-0139" num="0138">Logging Service-used to send and receive event logging information.</div>
<div class="description-paragraph" id="p-0140" num="0139">Buffer Management-used as a fast and useful mechanism for allocating, typing, chaining and freeing message buffers in the system.</div>
<div class="description-paragraph" id="p-0141" num="0140">HTTP Caching/Bypass service-sub-system to supply an API and functional service for HTTP file caching and bypass. It will make the determination to cache a file, retrieve a cached file (on board or off), and bypass a file (on board or not). In addition this service will keep track of local cached files and their associated TTL, as well as statistics on file bypassing. It will also keep a database of known files and their caching and bypassing status. Multicast services-A service to register, send and receive multicast packets across the MLAN.</div>
<div class="description-paragraph" id="p-0142" num="0141">2. Management Interface Card</div>
<div class="description-paragraph" id="p-0143" num="0142">The Management Interface Card (MIC) of the Pirus box has a single high performance microprocessor and multiple 10/100 Ethernet interfaces for administration of the SANStream management subsystem. This card also has a PCMCIA device for bootstrap image and configuration storage.</div>
<div class="description-paragraph" id="p-0144" num="0143">In the illustrated embodiments, the Management Interface Card will not participate in any routing protocol or forwarding path decisions. The IP stack and services of VxWorks will be used as the underlying IP facilities for all processes on the MIC. The MIC card will also have a flash based, DOS file system.</div>
<div class="description-paragraph" id="p-0145" num="0144">The MIC will not be connected to the backplane fabric but will be connected to the MLAN (Management LAN) in order to send/receive data to/from the other cards in the system. The MLAN is used for all MIC g g“other cards” communications.</div>
<div class="description-paragraph" id="p-0146" num="0145">2.1. Management Software</div>
<div class="description-paragraph" id="p-0147" num="0146">Management software is a collection of components responsible for configuration, reporting (status, statistics, etc), notification (events) and billing data (accounting information). The management software may also include components that implement services needed by the other modules in the system.</div>
<div class="description-paragraph" id="p-0148" num="0147">Some of the management software components can exist on any processor in the system, such as the logging server. Other components reside only on the MIC, such as the WEB Server providing the WEB user interface.</div>
<div class="description-paragraph" id="p-0149" num="0148">The strategy and subsequent architecture must be flexible enough to provide a long-term solution for the product family. In other words, the 1.0 implementation must not preclude the inclusion of additional management features in subsequent releases of the product.</div>
<div class="description-paragraph" id="p-0150" num="0149">The management software components that can run on either the MIC or NEC need to meet the requirement of being able to“run anywhere” in the system.</div>
<div class="description-paragraph" id="p-0151" num="0150">2.2 Management Software Overview</div>
<div class="description-paragraph" id="p-0152" num="0151">In the illustrated embodiments the management software decomposes into the following high-level functions, shown in <figref idrefs="DRAWINGS">FIG. 11</figref>. As shown in the example of FIG. <b>11</b> (other configurations are also possible and within the scope of the invention), management software can be organized into User Interfaces (Uls) <b>1102</b>, rapid control backplane (RCB) data dictionary <b>1104</b>, system abstraction model (SAM) <b>1106</b>, configuration &amp; statistics manager (CSM) <b>1108</b>, and logging/billing APIs <b>1110</b>, on module <b>1101</b>. This module can communicate across system services (S<b>2</b>) <b>1112</b> and hardware elements <b>1114</b> with configuration &amp; statistics agent (CSA) <b>1116</b> and applications <b>1118</b>.</div>
<div class="description-paragraph" id="p-0153" num="0152">The major components of the management software include the following:</div>
<div class="description-paragraph" id="p-0154" num="0153">2.2.1 User Interfaces (Uls)</div>
<div class="description-paragraph" id="p-0155" num="0154">These components are the user interfaces that allow the user access to the system via a CLI, HTTP Client or SNMP Agent.</div>
<div class="description-paragraph" id="p-0156" num="0155">2.2.2 Rapid Control Backplane (RCB)</div>
<div class="description-paragraph" id="p-0157" num="0156">These components make up the database or data dictionary of settable/gettable objects in the system. The Uls use “Rapid Marks” (keys) to reference the data contained within the database. The actual location of the data specified by a Rapid Mark may be on or off the MIC.</div>
<div class="description-paragraph" id="p-0158" num="0157">2.2.3 System Abstraction Model (SAM)</div>
<div class="description-paragraph" id="p-0159" num="0158">These components provide a software abstraction of the physical components in the system. The SAM works in conjunction with the RCB to get/set data for the Uls. The SAM determines where the data resides and if necessary interacts with the CSM to get/set the data.</div>
<div class="description-paragraph" id="p-0160" num="0159">2.2.4 Configuration &amp; Statistics Manager (CSM)</div>
<div class="description-paragraph" id="p-0161" num="0160">These components are responsible for communicating with the other cards in the system to get/set data. For example the CSM sends configuration data to a card/processor when a Ul initiates a change and receives statistics from a card/processor when a Ul requests some data.</div>
<div class="description-paragraph" id="p-0162" num="0161">2.2.5 Logging/Billing APIs These components interface with the logging and event servers provided by System Services and are responsible for sending logging/billing data to the desired location and generating SNMP traps/alerts when needed.</div>
<div class="description-paragraph" id="p-0163" num="0162">2.2.6 Configuration &amp; Statistics Agent (CSA)</div>
<div class="description-paragraph" id="p-0164" num="0163">These components interface with the CSM on the MIC and responds to CSM messages for configuration/statistics data.</div>
<div class="description-paragraph" id="p-0165" num="0164">2.3 Dynamic Configuration</div>
<div class="description-paragraph" id="p-0166" num="0165">The SANStream management system will support dynamic configuration updates. A significant advantage is that it will be unnecessary to reboot the entire chassis when an NP's configuration is modified. The bootstrap configuration can follow similar dynamic guidelines. Bootstrap configuration is merely dynamic configuration of an NP that is in the reset state.</div>
<div class="description-paragraph" id="p-0167" num="0166">Both soft and hard configuration will be supported. Soft configuration allows dynamic modification of current system settings.</div>
<div class="description-paragraph" id="p-0168" num="0167">Hard configuration modifies bootstrap or start-up parameters. A hard configuration is accomplished by saving a soft configuration. A hard configuration change can also be made by (T) FTP of a configuration file. The MIC will not support local editing of configuration files.</div>
<div class="description-paragraph" id="p-0169" num="0168">In a preferred practice of the invention DNS services will be available and utilized by MIC management processes to resolve hostnames into IP addresses.</div>
<div class="description-paragraph" id="p-0170" num="0169">2.4 Management Applications</div>
<div class="description-paragraph" id="p-0171" num="0170">In addition to providing “rote” management of the system, the management software will be providing additional management applications/functions. The level of integration with the WEB Ul for these applications can be left to the implementer. For example the Zoning Manager could be either be folded into the HTML pages served by the embedded HTTP server OR the HTTP server could serve up a stand-alone JAVA Applet.</div>
<div class="description-paragraph" id="p-0172" num="0171">2.4.1 Volume Manager</div>
<div class="description-paragraph" id="p-0173" num="0172">A preferred practice of the invention will provide a volume manager function. Such a Volume Manager may support:</div>
<div class="description-paragraph" id="p-0174" num="0173">Raid 0-Striping</div>
<div class="description-paragraph" id="p-0175" num="0174">Raid 1-Mirroring 0</div>
<div class="description-paragraph" id="p-0176" num="0175">Hot Spares</div>
<div class="description-paragraph" id="p-0177" num="0176">Aggregating several disks into a large volume.</div>
<div class="description-paragraph" id="p-0178" num="0177">Partitioning a large disk into several smaller volumes.</div>
<div class="description-paragraph" id="p-0179" num="0178">2.4. 2 Load Balancer</div>
<div class="description-paragraph" id="p-0180" num="0179">This application configures the load balancing functionality. This involves configuring policies to guide traffic through the system to its ultimate destination. This application will also report status and usage statistics for the configured policies.</div>
<div class="description-paragraph" id="p-0181" num="0180">2.4.3 Server-less Backup (NDMP)</div>
<div class="description-paragraph" id="p-0182" num="0181">This application will support NDMP and allow for serverless back up.</div>
<div class="description-paragraph" id="p-0183" num="0182">This will allow users the ability to back up disk devices to tape devices without a server intervening.</div>
<div class="description-paragraph" id="p-0184" num="0183">2.4.4 IP-ized Storage Management</div>
<div class="description-paragraph" id="p-0185" num="0184">This application will “hide” storage and FC parameters from IP-centric administrators. For example, storage devices attached to FC ports will appear as IP devices in an HP-Open View network map. These devices will be “ping-able”, “discoverable” and support a limited scope of MIB variables.</div>
<div class="description-paragraph" id="p-0186" num="0185">In order to accomplish this IP addresses be assigned to the storage devices (either manually or automatically) and the MIC will have to be sent all IP Mgmt (exact list TBD) packets destined for one of the storage IP addresses.</div>
<div class="description-paragraph" id="p-0187" num="0186">The MIC will then mediate by converting the IP packet (request) to a similar FC/SCSI request and sending it to the device.</div>
<div class="description-paragraph" id="p-0188" num="0187">For example an IP Ping would become a SCSI Inquiry while a SNMP get of sysDescription would also be a SCSI Inquiry with some of the returned data (from the Inquiry) mapped into the MIB variable and returned to the requestor.</div>
<div class="description-paragraph" id="p-0189" num="0188">These features are discussed in greater detail in the IP Storage Management section below.</div>
<div class="description-paragraph" id="p-0190" num="0189">2.4.5 Mediation Manager</div>
<div class="description-paragraph" id="p-0191" num="0190">This application is responsible for configuring, monitoring and managing the mediation between storage and networking protocols. This includes session configurations, terminations, usage reports, etc. These features are discussed in greater detail in the Mediation Manager section below.</div>
<div class="description-paragraph" id="p-0192" num="0191">2.4.6 VLAN Manager</div>
<div class="description-paragraph" id="p-0193" num="0192">Port level VLANs will be supported. Ports can belong to more than one VLAN.</div>
<div class="description-paragraph" id="p-0194" num="0193">The VLAN Manager and Zoning Manager could be combined into a VDM (or some other name) Manager as a way of unifying the Ethernet and FC worlds.</div>
<div class="description-paragraph" id="p-0195" num="0194">2.4.7 File System Manager The majority of file system management will probably be to“accept the defaults”. There may be an exception if it is necessary to format disks when they are attached to a Pirus system or perform other disk operations.</div>
<div class="description-paragraph" id="p-0196" num="0195">2.5 Virtual Storage Domain (VSD) Virtual storage domains serve 2 purposes.
</div> <ul> <li id="ul0001-0001" num="0000"> <ul> <li id="ul0002-0001" num="0196">1. Logically group together a collection of resources.</li> <li id="ul0002-0002" num="0197">2. Logically group together and“hide” a collection of resources from the outside world.</li> <li id="ul0002-0003" num="0198">The 2 cases are very similar. The second case is used when we are load balancing among NAS servers.</li> </ul> </li> </ul>
<div class="description-paragraph" id="p-0197" num="0199"> <figref idrefs="DRAWINGS">FIG. 12</figref> illustrates the first example: In this example Server 1 <b>1226</b> is using SCSI/IP to communicate to Disks A and B at a remote site while Server 2 <b>1224</b> is using SCSI/IP to communicate with Disks C and D <b>1208</b> at the same remote site. For this configuration Disks A, B, C, and D must have valid IP addresses. Logically inside the PIRUS system <b>2</b> Virtual Domains are created, one for Disks A and B and one for Disks C and D. The IFF software doesn't need to know about the VSDs since the IP addresses for the disks are valid (exportable) it can simply forward the traffic to the correct destination. The VSD is configured for the management of the resources (disks).</div>
<div class="description-paragraph" id="p-0198" num="0200">The second usage of virtual domains is more interesting. In this case let's assume we want to load balance among 3 NAS servers. A VSD would be created and a Virtual IP Address (VIP) assigned to it. External entities would use this VIP to address the NAS and internally the PIRUS system would use NAT and policies to route the request to the correct NAS server. <figref idrefs="DRAWINGS">FIG. 13</figref> illustrates this.</div>
<div class="description-paragraph" id="p-0199" num="0201">In this example users of the NAS service would simple reference the VIP for Joe's ASP NAS LB service. Internally, through the combination of virtual storage domains and policies the Pirus system load balances the request among 3 internal NAS servers <b>1306</b>,<b>1308</b>, <b>1310</b>, thus providing a scalable, redundant NAS solution.</div>
<div class="description-paragraph" id="p-0200" num="0202">Virtual Domains can be use to virtualize the entire Pirus system.</div>
<div class="description-paragraph" id="p-0201" num="0203">Within VSDs the following entities are noteworthy:</div>
<div class="description-paragraph" id="p-0202" num="0204">2.5.1 Services</div>
<div class="description-paragraph" id="p-0203" num="0205">Services represent the physical resources. Examples of services are:</div>
<div class="description-paragraph" id="p-0204" num="0206">1. Storage Devices attached to FC or Ethernet ports. These devices can be simple disks, complex RAID arrays, FC-AL connections, tape devices, etc.</div>
<div class="description-paragraph" id="p-0205" num="0207">2. Router connections to the Internet.</div>
<div class="description-paragraph" id="p-0206" num="0208">3. NAS-Internally defined ones only.</div>
<div class="description-paragraph" id="p-0207" num="0209">2.5.2 Policies</div>
<div class="description-paragraph" id="p-0208" num="0210">A preferred practice of the invention can implement the following types of policies:</div>
<div class="description-paragraph" id="p-0209" num="0211">1. Configuration Policy-A policy to configure another policy or a feature. For example a NAS Server in a virtual domain will be configured as a “Service”. Another way to look at it is that a Configuration Policy is simply the collection of configurable parameters for an object.</div>
<div class="description-paragraph" id="p-0210" num="0212">2. Usage Policy-A policy to define how data is handled. In our case load balancing is an example of a “Usage Policy”. When a user configures load balancing they are defining a policy that specifies how to distribute client requests based on a set of criteria.</div>
<div class="description-paragraph" id="p-0211" num="0213">There are many ways to describe a policy or policies. For our purposes we will define a policy as composed of the following: 1. Policy Rules-1 or more rules describing “what to do”. A rule is made up of condition (s) and actions. Conditions can be as simple as “match anything” r as complex as if source IP address 1.1. 1.1 and it's 2: 05″.</div>
<div class="description-paragraph" id="p-0212" num="0214">Likewise, actions can be as simple as “send to 2.2. 2. 2” or complex as “ load balance using LRU between 3 NAS servers.) 2. Policy Domain-A collection of object (s) Policy Rules apply to. For example, suppose there was a policy that said “load balance using round robin”. The collection of NAS servers being load balanced is the policy domain for the policy.</div>
<div class="description-paragraph" id="p-0213" num="0215">Policies can be nested to form complex policies.</div>
<div class="description-paragraph" id="p-0214" num="0216">2.6 Boot Sequence and Configuration</div>
<div class="description-paragraph" id="p-0215" num="0217">The MIC and other cards coordinate their actions during boot up configuration processing via System Service's Notify Service. These actions need to be coordinated in order to prevent the passing of traffic before configuration file processing has completed.</div>
<div class="description-paragraph" id="p-0216" num="0218">The other cards need to initialize with default values and set the state of their ports to “hold down” and wait for a “Config Complete” event from the MIC.</div>
<div class="description-paragraph" id="p-0217" num="0219">Once this event is received the ports can be released and process traffic according to the current configuration. (Which may be default values if there were no configuration commands for the ports in the configuration file.) <figref idrefs="DRAWINGS">FIG. 14</figref> illustrates this part of the boot up sequence and interactions between the MIC, S<b>2</b> Notify and other cards.</div>
<div class="description-paragraph" id="p-0218" num="0220">There is an error condition in this sequence where the card never receives the “Config Complete” event. Assuming the software is working properly than this condition is caused by a hardware problem and the ports on the cards will be held in the “hold down” state. If CSM/CSA is working properly than the MIC Mgmt Software will show the ports down or CPCM might detect that the card is not responding and notify the MIC. In any case there are several ways to learn about and notify users about the failure.</div>
<div class="description-paragraph" id="p-0219" num="0221">3. LIC Software</div>
<div class="description-paragraph" id="p-0220" num="0222">The LIC (Lan Interface Card) consists of LAN Ethernet ports of 10/100/1000 Mbps variety. Behind the ports are 4 network engine processors.</div>
<div class="description-paragraph" id="p-0221" num="0223">Each port on a LIC will behave like a layer 2 and layer 3 switch. The functionality of switching and intelligent forwarding is referred to herein as IFF-Intelligent Forwarding and Filtering. The main purpose of the network engine processors is to forward packets based on Layer 2, 3, 4 or 5 information. The ports will look and act like router ports to hosts on the LAN. Only RIP will be supported in the first release, with OSPF to follow.</div>
<div class="description-paragraph" id="p-0222" num="0224">3.1 VLANs</div>
<div class="description-paragraph" id="p-0223" num="0225">The box will support port based VLANs. The division of the ports will be based on configuration and initially all ports will belong to the same VLAN. Alternative practices of the invention can include VLAN classification and tagging, including possibly <b>802</b>. <b>1</b> p and <b>802</b>. <b>1</b> Q support.</div>
<div class="description-paragraph" id="p-0224" num="0226">3.1.1 Intelligent Filtering and Forwarding (IFF)</div>
<div class="description-paragraph" id="p-0225" num="0227">The IFF features are discussed in greater detail below.</div>
<div class="description-paragraph" id="p-0226" num="0228">Layer 2 and layer 3 switching will take place inside the context of IFF. Forwarding table entries are populated by layer 2 and 3 address learning. If an entry is not known the packet is sent to the IP routing layer and it is routed at that level.</div>
<div class="description-paragraph" id="p-0227" num="0229">3.2 Load Balance Data Flow</div>
<div class="description-paragraph" id="p-0228" num="0230">NFS load balancing will be supported within a SANStream chassis. Load balancing based upon VIRUTAL IP addresses, content and flows are all possible.</div>
<div class="description-paragraph" id="p-0229" num="0231">The SANStream box will monitor the health of internal NFS servers that are configured as load balancing servers and will notify network management of detectable issues as well as notify a disk management layer so that recovery may take place. It will in these cases, stop sending requests to the troubled server, but continue to load balance across the remaining NFS servers in the virtual domain.</div>
<div class="description-paragraph" id="p-0230" num="0232">3.3 LIC-NAS Software</div>
<div class="description-paragraph" id="p-0231" num="0233">3.3.1 Virtual Storage Domains (VSD)</div>
<div class="description-paragraph" id="p-0232" num="0234"> <figref idrefs="DRAWINGS">FIG. 15</figref> provides another VSD example. The switch system of the invention is designed to support, in one embodiment, multiple NFS and CIFS servers in a single device that are exported to the user as a single NFS server (only NFS is supported on the first release). These servers are masked under a single IP address, known as a Virtual Storage Domain (VSD). Each VSD will have one to many connections to the network via a Network Processor (NP) and may also have a pool of Servers (will be referred to as “Server” throughout this document) connected to the VSD via the fabric on the SRC card.</div>
<div class="description-paragraph" id="p-0233" num="0235">Within a virtual domain there are policy domains. These sub-layers define the actions needed to categorize the frame and send it to the next hop in the tree. These polices can define a large range of attributes in a frame and then impose an action (implicit or otherwise). Common polices may include actions based on protocol type (NFS, CIFS, etc.) or source and destination IP or MAC address. Actions may include implicit actions like forwarding the frame on to the next policy for further processing, or explicit actions such as drop.</div>
<div class="description-paragraph" id="p-0234" num="0236"> <figref idrefs="DRAWINGS">FIG. 15</figref> diagrams a hypothetical virtual storage domain owned by Fred's ASP <b>1502</b>. In this example Fred has the configured address of 1.1. 1.1 that is returned by the domain name service when queried for the domain's IP address. The next level of configuration is the policy domain. When a packet arrives into the Pirus box from a router port it is classified as a member of Fred's virtual domain because of its destination IP address. Once the virtual domain has been determined its configuration is loaded in and a policy decision is made based on the configured policy. In the example above lets assume an NFS packet arrived. The packet will be associated with the NFS policy domain and a NAT (network address translation-described below) takes place, with the destination address that of the NFS policy domain. The packet now gets associated with the NFS policy domain for Yahoo. The process continues with the configuration of the NFS policy being loaded in and a decision being made based on the configured policy. In the example above the next decision to be made is whether or not the packet contains the gold, silver, or bronze service. Once that determination is made (let's assume the client was identified as a gold customer), a NAT is performed again to make the destination the IP address of the Gold policy domain. The packet now gets associated with the Gold policy domain. The process continues with the configuration for the Gold policy being loaded in and a decision being made based on the configured policy. At this point a load balancing decision is made to pick the best server to handle the request. Once the server is picked, NAT is again performed and the destination IP address of the server is set in the packet. Once the destination IP address of the packet becomes a device configured for load balancing, a switching operation is made and the packet is sent out of the box.</div>
<div class="description-paragraph" id="p-0235" num="0237">The implementation of the algorithm above lends itself to recursion and may or may not incur as many NAT steps as described. It is left to the implementer to short cut the number of NAT's while maintaining the overall integrity of the algorithm.</div>
<div class="description-paragraph" id="p-0236" num="0238"> <figref idrefs="DRAWINGS">FIG. 15</figref> also presents the concept of port groups <b>1512</b>,<b>1516</b>. Port groups are entities that have identical functionality and are members of the same virtual domain. Port group members provide a service. By definition, any member of a particular port group, when presented with a request, must be able to satisfy that request. Port groups may have routers, administrative entities, servers, caches, or other Pirus boxes off of them.</div>
<div class="description-paragraph" id="p-0237" num="0239">Virtual Storage Domains can reside across slots but not boxes. More than one Virtual Storage Domain can share a Router Interface.</div>
<div class="description-paragraph" id="p-0238" num="0240">3.3.2 Network Address Translation (NAT)</div>
<div class="description-paragraph" id="p-0239" num="0241">NAT translates from one IP Address to another IP Address. The reasons for doing NAT is for Load Balancing, to secure the identity of each Server from the Internet, to reduce the number of IP Addresses purchased, to reduce the number of Router ports needed, and the like.</div>
<div class="description-paragraph" id="p-0240" num="0242">Each Virtual Domain will have an IP Address that is advertised thru the network NP ports. The IP Address is the address of the Virtual Domain and NOT the NFS/CIFS Server IP Address. The IP Address is translated at the Pirus device in the Virtual Storage Domain to the Server's IP Address.</div>
<div class="description-paragraph" id="p-0241" num="0243">Depending on the Server chosen, the IP Address is translated to the terminating Server IP Address.</div>
<div class="description-paragraph" id="p-0242" num="0244">For example, in <figref idrefs="DRAWINGS">FIG. 15</figref>, IP Address 100.100. 100. 100 would translate to 1.1. 1.1, 1.1. 1.2 or 1.1. 1.3 depending on the terminating Server.</div>
<div class="description-paragraph" id="p-0243" num="0245">3.3.3 Local Load Balance (LLB)</div>
<div class="description-paragraph" id="p-0244" num="0246">Local load balancing defines an operation of balancing between devices (i.e. servers) that are connected directly or indirectly off the ports of a Pirus box without another load balancer getting involved. A lower-complexity implementation would, for example, support only the balancing of storage access protocols that reside in the Pirus box.</div>
<div class="description-paragraph" id="p-0245" num="0247">3.3.3.1 Load Balancing Order of Operations:</div>
<div class="description-paragraph" id="p-0246" num="0248">In the process of load balancing configuration it may be possible to define multiple load balancing algorithms for the same set of servers. The need then arises to apply an order of operations to the load balancing methods. They are as follows in the order they are applied: 1) Server loading info, Percentage of loading on the servers Ethernet, Percentage of loading on the servers FC port, SLA support, Ratio Weight rating 2) Round Trip Time, Response time, Packet Rate, Completion Rate 3) Round Robin, Least Connections, Random Load balancing methods in the same group are treated with the same weight in determining a servers loading. As the load balancing algorithms are applied, servers that have identical load characteristics (within a certain configured percentage) are moved to the next level in order to get a better determination of what server is best prepared to receive the request. The last load balancing methods that will be applied across the servers that have the identical load characteristics (again within a configured percentage) are round robin, least connection and random.</div>
<div class="description-paragraph" id="p-0247" num="0249">3.3.3.2 File System Server Load Balance (FSLB):</div>
<div class="description-paragraph" id="p-0248" num="0250">The system of the invention is intended to provide load balancing across at least two types of file system servers, NFS and CIFS. NFS is stateless and CIFS is stateful so there are differences to each method. The goal of file system load balancing is not only to pick the best identical server to handle the request, but to make a single virtual storage domain transparently hidden behind multiple servers.</div>
<div class="description-paragraph" id="p-0249" num="0251">3.3.3.3 NFS Server Load Balancing (NLB):</div>
<div class="description-paragraph" id="p-0250" num="0252">NFS is mostly stateless and idempotent (every operation returns the same result if it is repeated). This is qualified because operations such as READ are idempotent but operations such as REMOVE are not. Since there is little NFS server state as well as little NFS client state transferred from one server to the other, it is easy for one server to assume the other server's functions. The protocol will allow for a client to switch NFS requests from one server to another transparently. This means that the load balancer can more easily maintain an NFS session if a server fails. For example if in the middle of a request a server dies, the client will retry, the load balancer will pick another server and the request gets fulfilled (with possibly a file handle NAT), after only a retry. If the server dies between requests, then there isn't even a retry, the load balancer just picks a new server and fulfills the request (with possibly a file handle NAT).</div>
<div class="description-paragraph" id="p-0251" num="0253">When using NFS managers it will be possible to set up the load balancer to load across multiple NFS servers that have identical data, or managers can set up load balancing to segment the balancing across servers that have unique data. The latter requires virtual domain configuration based on file requested (location in the file system tree) and file type. The former requires a virtual domain and minimal other configuration (i.e., load balancing policy).</div>
<div class="description-paragraph" id="p-0252" num="0254">The function of Load Balance Data Flow is to distribute the processing of requests over multiple servers. Load Balance Data Flow is the same as the Traditional Data Flow but the NP statistically determines the load of each server that is part of the specified NFS request and forwards the request based on that server load. The load-balancing algorithm could be as simple as round robin or a more sophisticated administrator configured policy.</div>
<div class="description-paragraph" id="p-0253" num="0255">Server load balance decisions are made based upon IP destination address. For any server IP address, a routing NP may have a table of configured alternate server IP addresses that can process an HTTP transaction. Thus multiple redundant NFS servers are supported using this feature.</div>
<div class="description-paragraph" id="p-0254" num="0256">TCP based server load balance decisions are made within the NP on a per connection basis. Once a server is selected through the balancing algorithm all transactions on a persistent TCP connection will be made to the same originally targeted server. An incoming IP message's source IP address and IP source Port number are the only connection lookup keys used by a NP.</div>
<div class="description-paragraph" id="p-0255" num="0257">For example, suppose a URL request arrives for 192.32. 1.1. The Router NP processor's lookup determines that server 192.32. 1.1 is part of a Server Group (192.32. 1.1, 192.32. 1.2, etc.). The NP decides which Server Group to forward the request to via user-configured algorithm. Round-Robin, estimated actual load, and current connection count are all candidates for selection algorithms. If TCP is the transport protocol, the TCP session is then terminated at the specified SRC processor.</div>
<div class="description-paragraph" id="p-0256" num="0258">UDP protocols do not have an opening SYN exchange that must be absorbed and spoofed by the load balancing IXP. Instead each UDP packet can be viewed as a candidate for balancing. This is both good and bad. The lack of opening SYN simplifies part of the balance operation, but the effort of balancing each packet could add considerable latency to UDP transactions.</div>
<div class="description-paragraph" id="p-0257" num="0259">In some cases it will be best to make an initial balance decision and keep a flow mapped for a user configurable time period. Once the period has expired an updated balance decision can be made in the background and a new balanced NFS server target selected.</div>
<div class="description-paragraph" id="p-0258" num="0260">In many cases it will be most efficient to re-balance a flow during a relatively idle period. Many disk transactions result in forward looking actions on the server (people who read the 1st half of a file often want the 2nd half soon afterwards) and rebalancing during active disk transactions could actually hurt performance.</div>
<div class="description-paragraph" id="p-0259" num="0261">An amendment to the “time period” based flow balancing described above would be to arm the timer for an inactivity period and re-arm it whenever NFS client requests are received. A longer inactivity timer period could be used to determine when a flow should be deleted entirely rather than re-balanced.</div>
<div class="description-paragraph" id="p-0260" num="0262">3.3.3.4 TCP and UDP-Methods of balancing:</div>
<div class="description-paragraph" id="p-0261" num="0263">NFS can run over both TCP and UDP (UDP being more prevalent). When processing UDP NFS requests the method used for psuedo-proxy of TCP sessions does not need to be employed. During a UDP session, the information to make a rational load balancing decision can be made with the first packet.</div>
<div class="description-paragraph" id="p-0262" num="0264">Several methods of load balancing are possible. The first and simples to implement is load balancing based on source address-all requests are sent to the same server for a set period of time after a load balancing decision is made to pick the best server at the UDP request or the TCP SYN.</div>
<div class="description-paragraph" id="p-0263" num="0265">Another method is to load balance every request with no regard for the previous server the client was directed to. This will possibly require obtaining a new file handle from the new server and NATing so as to hide the file handle change from the client. This method also carries with it more overhead in processing (every request is load balanced) and more implementation effort, but does give a more balanced approach.</div>
<div class="description-paragraph" id="p-0264" num="0266">Yet another method for balancing NFS requests is to cache a “next balance” target based on previous experience. This avoids the overhead of extensive balance decision making in real time, and has the benefit of more even client load distribution. In order to reduce the processing of file handle differences between identical internal NFS servers, all disk modify operations will be strictly ordered. This will insure that the inode numbering is consistent across all identical disks.</div>
<div class="description-paragraph" id="p-0265" num="0267">Among the load balancing methods that can be used (others are possible) are: o Round Robin o Least Connections o Random (lower IP-bits, hashing) o Packet Rate (minimum throughput) o Ratio Weight rating o Server loading info and health as well as application health o Round Trip Time (TCP echo) o Response time 3.3. 3.5 Write Replication: NFS client read and status transactions can be freely balanced across a VLAN family of peer NFS servers. Any requests that result in disk content modification (file create, delete, set-attributes, data write, etc.) must be replicated to all NFS servers in a VLAN server peer group.</div>
<div class="description-paragraph" id="p-0266" num="0268">The Pirus Networks switch fabric interface (SFI) will be used to multicast NFS modifications to all NFS servers in a VLAN balancing peer group. All NFS client requests generate server replies and have a unique transaction ID. This innate characteristic of NFS can be used to verify and confirm the success of multicast requests.</div>
<div class="description-paragraph" id="p-0267" num="0269">At least two mechanisms can be used for replicated transaction confirmation. They are“first answer” and quorum. Using the “first answer” algorithm an IXP would keep minimal state for an outstanding NFS request, and return the first response it receives back to the client. The quorum system would require the IXP to wait for some percentage of the NFS peer servers to respond with identical messages before returning one to the client.</div>
<div class="description-paragraph" id="p-0268" num="0270">Using either method, unresponsive NFS servers are removed from the VLAN peer balancing group. When a server is removed from the group the Pirus NFS mirroring service must be notified so that recovery procedures can be initiated.</div>
<div class="description-paragraph" id="p-0269" num="0271">A method for coordinating NFS write replication is set forth in <figref idrefs="DRAWINGS">FIG. 16</figref>, including the following steps: check for NFS replication packet <b>1602</b>; if yes, multicast packet to entire VLAN NFS server peer group <b>1604</b>; wait for 15t NFS server reply with timeout <b>1608</b>; send 1st server reply to client <b>1610</b>; remove unresponsive servers from LB group and inform NFS mirroring service <b>1610</b>. If not an NFS replication packet, load balance and unicast to NFS server <b>1606</b>.</div>
<div class="description-paragraph" id="p-0270" num="0272">3.3.4 Load Balancer Failure Indication:</div>
<div class="description-paragraph" id="p-0271" num="0273">When a load balancer declares that a peer NFS server is being dropped from the group the NFS mirroring service is notified. A determination must be made as to whether the disk failure was soft or hard.</div>
<div class="description-paragraph" id="p-0272" num="0274">In the case of a soft failure a hot synchronization should be attempted to bring the failing NFS server back online. All NFS modify transactions must be recorded for playback to the failing NFS server when it returns to service.</div>
<div class="description-paragraph" id="p-0273" num="0275">When a hard failure has occurred an administrator must be notified and fresh disk will be brought online, formatted, and synchronized.</div>
<div class="description-paragraph" id="p-0274" num="0276">3.3.4.1 CIFS Server Load Balancing:</div>
<div class="description-paragraph" id="p-0275" num="0277">CIFS is stateful and as such there are fewer options available for load balancing. CIFS is a session-oriented protocol; a client is required to log on to a server using simple password authentication or a more secure cryptographic challenge. CIFS supports no recovery guarantees if the session is terminated through server or network outage. Therefore load balancing of CIFS requests must be done once at TCP SYN and persistence must be maintained throughout the session. If a disk fails and not the CIFS server, then a recovery mechanism can be employed to transfer state from one server to another and maintain the session. However if the server fails (hardware or software) and there is no way to transfer state from the failed server to the new server, then the TCP session must be brought down and the client must reestablish a new connection with a new server. This means relogging and recreating state in the new server.</div>
<div class="description-paragraph" id="p-0276" num="0278">Since CIFS is TCP based the balancing decision will be made at the TCP SYN. Since the TCP session will be terminated at the destination server, that server must be able to handle all requests that the client believes exists under that domain. Therefore all CIFS servers that are masked by a single virtual domain must have identical content on them. Secondly data that spans an NFS server file system must be represented as a separate virtual domain and accessed by the client as another CIFS server (i.e. another mount point).</div>
<div class="description-paragraph" id="p-0277" num="0279">Load balancing will support source address based persistence and send all requests to the same server based on a timeout since inactivity. Load balancing methods used will be: o Round Robin o Least Connections o Random (lower IP-bits, hashing) o Packet Rate (minimum throughput) o Ratio Weight rating o Server loading info and health as well as application health o Round Trip Time (TCP echo) o Response time</div>
<div class="description-paragraph" id="p-0278" num="0280">3.3.4.2 Content Load Balance:</div>
<div class="description-paragraph" id="p-0279" num="0281">Content load balancing is achieved by delving deeper into packet contents than simple destination IP address.</div>
<div class="description-paragraph" id="p-0280" num="0282">Through configuration and policy it will be possible to re-target NFS transactions to specific servers based upon NFS header information. For example a configuration policy may state that all files under a certain directory load balanced between the two specified NFS servers.</div>
<div class="description-paragraph" id="p-0281" num="0283">A hierarchy of load balancing rules may be established when Server Load Balancing is configured subordinate to Content Load Balancing.</div>
<div class="description-paragraph" id="p-0282" num="0284">3.4 LIC-SCSI/IP Software</div>
<div class="description-paragraph" id="p-0283" num="0285">3.5 Network Processor Functionality</div>
<div class="description-paragraph" id="p-0284" num="0286"> <figref idrefs="DRAWINGS">FIG. 17</figref> is a top-level block diagram of the software on an NP. Note that the implementation of a block may be split across the policy processor and the micro-engines. Note also that not all blocks may be present on all NPs. The white blocks are common (in concept and to some level of implementation) between all NPs, the lightly shaded blocks are present on NP that have load balancing and storage server health checking enabled on them.</div>
<div class="description-paragraph" id="p-0285" num="0287">3.5. 1 Flow Control</div>
<div class="description-paragraph" id="p-0286" num="0288">3.5.1.1 Flow Definition:</div>
<div class="description-paragraph" id="p-0287" num="0289">Flows are defined as source port, destination port, and source and destination IP address. Packets are tagged coming into the box and classified by protocol, destination port and destination IP address. Then based on policy and/or TOS bit a priority is assigned within the class. Classes are associated with a priority when compared to other classes. Within the same class priorities are assigned to packets based on the TOS bit setting and/or policy.</div>
<div class="description-paragraph" id="p-0288" num="0290">3.5.1.2 Flow Control Model:</div>
<div class="description-paragraph" id="p-0289" num="0291">Flow control will be provided within the SANStream product to the extent described in this section. Each of the egress Network Processors will perform flow control. There will be a queue High Watermark that when approached will cause flow control indications from egress Network Processor to offending Network Processors based on QoS policy. The offending Network Processor will narrow TCP windows (when present) to reduce traffic flow volumes. If the egress Network Processors exceeds a Hard Limit (something higher than the High Watermark), the egress Network Processor will perform intelligent dropping of packets based on class priority and policy. As the situation improves and the Low Watermark is approached, egress control messages back the offending network processors allow for resumption of normal TCP window sizes.</div>
<div class="description-paragraph" id="p-0290" num="0292">For example, in <figref idrefs="DRAWINGS">FIG. 18</figref>, the egress Network Processor is NP<b>1</b> <b>1802</b> and the offending Network Processors are NP<b>2</b> <b>1804</b> and NP<b>4</b> <b>1808</b>. NP<b>2</b> and NP<b>4</b> were determined to be offending NPs based the High Watermark and each of their policies. NP<b>1</b>, detecting the offending NPs, sends flow control messages to each of the processors. These offending processors should perform flow control as described previously. If the Hard Limit is reached in NP<b>1</b>, then packets received by NP<b>2</b> or NP<b>4</b> can be dropped intelligently (in a manner that can be determined by the implementer).</div>
<div class="description-paragraph" id="p-0291" num="0293">3.5. 2 Flow Thru Vs. Buffering</div>
<div class="description-paragraph" id="p-0292" num="0294">There will be a distinct differentiation in performance between the flow-thru and the other slower paths of processing.</div>
<div class="description-paragraph" id="p-0293" num="0295">3.5.2.1 Flow Thru:</div>
<div class="description-paragraph" id="p-0294" num="0296">Fast path processing will be defined as flow-thru. This path will not include buffering. Packets in this path must be designated as flow-thru within the first N bytes (Current thinking is M ports for the IXP-1200). These types of packets will be forwarded directly to the destination processor to then be forwarded out of the box. Packets that are eligible for flow-thru include flows that have a IFF table entry, Layer 2 switchable packets, packets from the servers to clients, and FC switchable frames.</div>
<div class="description-paragraph" id="p-0295" num="0297">3.5.2.2 Buffering:</div>
<div class="description-paragraph" id="p-0296" num="0298">Packets that require further processing will need to be buffered and will take one of 2 paths.</div>
<div class="description-paragraph" id="p-0297" num="0299">Buffered Fast Path First buffered path is taken on packets that require further looking into the frame. These frames will need to be buffered in order that more of the packet can be loaded into a micro-engine for processing. These include deep processing of layer 4-7 headers, load balancing and QoS processing.</div>
<div class="description-paragraph" id="p-0298" num="0300">Slow Path</div>
<div class="description-paragraph" id="p-0299" num="0301">The second buffered path occurs when, during processing in a micro-engine, a determination is made that more processing needs to occur that can't be done in a micro-engine. These packets require buffering and will be passed to the NP co-processor in that form. When this condition has been detected the goal will be to process as much as possible in the micro-engine before handing it up to the co-processor. This will take advantage of the performance that is inherent in a micro-engine design.</div>
<div class="description-paragraph" id="p-0300" num="0302">4. SRC NAS</div>
<div class="description-paragraph" id="p-0301" num="0303">The Pirus Networks 1st generation Storage Resource Card (SRC) is implemented with 4 occurrences of a high performance embedded computing kernel. A single instance of this kernel can contain the components shown in <figref idrefs="DRAWINGS">FIG. 19</figref>.</div>
<div class="description-paragraph" id="p-0302" num="0304">Software Features: The SRC Phase <b>1</b> NAS software load will provide NFS server capability.</div>
<div class="description-paragraph" id="p-0303" num="0305">Key requirements include:</div>
<div class="description-paragraph" id="p-0304" num="0306">High performance-no software copies on read data, caching El High availability-balancing, mirroring</div>
<div class="description-paragraph" id="p-0305" num="0307">4.1 SRC NAS Storage Features</div>
<div class="description-paragraph" id="p-0306" num="0308">4.1.1 Volume Manager</div>
<div class="description-paragraph" id="p-0307" num="0309">A preferred practice of the Pirus Volume Manager provides support for crash recovery and resynchronization after failure. This module will interact with the NFS mirroring service during resynchronization periods. Disk Mirroring (RAID-1), hot sparing, and striping (RAID-0) are also supported.</div>
<div class="description-paragraph" id="p-0308" num="0310">4.1.2 Disk Cache</div>
<div class="description-paragraph" id="p-0309" num="0311">Tightly coupled with the Volume Manager 2002, a Disk Cache module 2004 will utilize the large pool of buffer RAM to eliminate redundant disk accesses. Object based caching (rather than page-based) can be utilized.</div>
<div class="description-paragraph" id="p-0310" num="0312">Disk Cache replacement algorithms can be dynamically tuned based upon perceived role. Database operations (frequent writes) will benefit from a different cache model than html serving (frequent reads).</div>
<div class="description-paragraph" id="p-0311" num="0313">4.1.3 SCSI</div>
<div class="description-paragraph" id="p-0312" num="0314">Initiator mode support required in phase 1. This layer will be tightly coupled with the Fibre Channel controller device. Implementers will wish to verify the interoperability of this protocol with several current generation drives (IBM, Seagate), JBODs, and disk arrays.</div>
<div class="description-paragraph" id="p-0313" num="0315">4.1.4 Fibre Channel</div>
<div class="description-paragraph" id="p-0314" num="0316">The disclosed system will provide support for fabric node (N_PORT) and arbitrated loop (NL_PORT). The Fibre Channel interface device will provide support for SCSI initiator operations, with interoperability of this interface with current generation FC Fabric switches (such as those from Brocade, Ancor).</div>
<div class="description-paragraph" id="p-0315" num="0317">Point-to-Point mode can also be supported; and it is understood that the device will perform master mode DMA to minimize processor intervention. It is also to be understood that the invention will interface and provide support to systems using NFS, RPC (Remote Procedure Call), MNT, PCNFSD, NLM, MAP and other protocols.</div>
<div class="description-paragraph" id="p-0316" num="0318">4.1. 5 Switch Fabric Interface</div>
<div class="description-paragraph" id="p-0317" num="0319">A suitable switch fabric interface device driver is left to the implementer. Chained DMA can be used to minimize CPU overhead.</div>
<div class="description-paragraph" id="p-0318" num="0320">4.2 NAS Pirus System Features</div>
<div class="description-paragraph" id="p-0319" num="0321">4.2.1 Configuration/Statistics</div>
<div class="description-paragraph" id="p-0320" num="0322">The expected complement of parameters and information will be available through management interaction with the Pirus chassis MIC controller.</div>
<div class="description-paragraph" id="p-0321" num="0323">4.2. 2 NFS Load Balancing</div>
<div class="description-paragraph" id="p-0322" num="0324">The load balancing services of the LIC are also used to balance requests across multiple identical NFS servers within the Pirus chassis. NFS data read balancing is a straightforward extension to planned services when Pirus NFS servers are hidden behind a NAT barrier.</div>
<div class="description-paragraph" id="p-0323" num="0325">With regard to NFS data write balancing, when a LIC receives NFS create, write, or remove commands they must be multicast to all participating NFS SRC servers that are members of the load balancing group.</div>
<div class="description-paragraph" id="p-0324" num="0326">4.2.3 NFS Mirroring Service The NFS mirroring service is responsible for maintaining the integrity of replicated NFS servers within the Pirus chassis. It coordinates the initial mirrored status of peer NFS servers upon user configuration. This service also takes action when a load-balancer notifies it that a peer NFS server has fallen out of the group or when a new disk “checks in” to the chassis.</div>
<div class="description-paragraph" id="p-0325" num="0327">This service interacts with individual SRC Volume Manager modules to synchronize file system contents. It could run on a #9 processor associated with any SRC module or on the MIC.</div>
<div class="description-paragraph" id="p-0326" num="0328">5. SRC Mediation Storage</div>
<div class="description-paragraph" id="p-0327" num="0329">Mediation is the technology of bridging between storage mediums of different types. We will mediate between Fibre Channel target and initiators and IP based target and initiators. The disclosed embodiment will support numerous mediation techniques.</div>
<div class="description-paragraph" id="p-0328" num="0330">5.1 Supported Mediation Protocols</div>
<div class="description-paragraph" id="p-0329" num="0331">Mediation protocols that can be supported by the disclosed architecture will include Cisco's SCSI/TCP, Adaptec's SEP protocol, and the standard canonical SCSI/UDP encapsulation.</div>
<div class="description-paragraph" id="p-0330" num="0332">5.1.1 SCSIIUDP</div>
<div class="description-paragraph" id="p-0331" num="0333">SCSI/UDP has not been documented as a supported encapsulated technique by any hardware manufacturer. However UDP has some advantages in speed when comparing it to TCP. UDP however is not a reliable transport. Therefore it is proposed that we use</div>
<div class="description-paragraph" id="p-0332" num="0334">SCSI/UDP to extend the Fibre Channel fabric through our own internal fabric (see <figref idrefs="DRAWINGS">FIG. 21</figref> demonstrating SCSI/UDP operation with elements <b>100</b>, IBM 2102 and Disk Array <b>2104</b>). The benefit to UDP is lower processing and latency. Reliable UDP (Cisco protocol) may also be used in the future if we want to extend the protocol to the LAN or the WAN.</div>
<div class="description-paragraph" id="p-0333" num="0335">5.2 Storage Components</div>
<div class="description-paragraph" id="p-0334" num="0336">The following discussion refers to <figref idrefs="DRAWINGS">FIG. 22</figref>, which depicts software components for storage (2202 et seq.).</div>
<div class="description-paragraph" id="p-0335" num="0337">5.2.1 SCSI/IP Layer:</div>
<div class="description-paragraph" id="p-0336" num="0338">The SCSI/IP layer is a full TCP/IP stack and application software dedicated to the mediation protocols. This is the layer that will initiate and terminate SCSI/IP requests for initiators and targets respectively.</div>
<div class="description-paragraph" id="p-0337" num="0339">5.2 2 SCSI Mediator:</div>
<div class="description-paragraph" id="p-0338" num="0340">The SCSI mediator acts as a SCSI server to incoming IP payload. This thin module maps between IP addresses and SCSI devices and LUNs.</div>
<div class="description-paragraph" id="p-0339" num="0341">5.2.3 Volume Manager</div>
<div class="description-paragraph" id="p-0340" num="0342">The Pirus Volume Manager will provide support for disk formatting, mirroring (RAID-1) and hot spare synchronization. Striping (RAID-0) may also be available in the first release. The VM must be bulletproof in the HA environment. NVRAM can be utilized to increase performance by committing writes before they are actually delivered to disk.</div>
<div class="description-paragraph" id="p-0341" num="0343">When the Volume manager is enabled a logical volume view is presented to the SCSI mediator as a set of targetable LUNs. These logical volumes do not necessarily correspond to physical SCSI devices and LUNs.</div>
<div class="description-paragraph" id="p-0342" num="0344">5.2.4 SCSI Originator</div>
<div class="description-paragraph" id="p-0343" num="0345">In the disclosed architecture this layer will be tightly coupled with the Fibre Channel controller device, with interoperability of this protocol with several current generation drives (IBM, Seagate), JBODs, and disk arrays.</div>
<div class="description-paragraph" id="p-0344" num="0346">This module can be identical to its counterpart in the SRC NAS image.</div>
<div class="description-paragraph" id="p-0345" num="0347">5.2. 5 SCSI</div>
<div class="description-paragraph" id="p-0346" num="0348">Target SCSI target mode support will be required if external FC hosts are permitted to indirectly access remote SCSI disks via mediation (e.g. SCSI/FC-&gt;SCSI/FC via SCSI/TCP).</div>
<div class="description-paragraph" id="p-0347" num="0349">5.2. 6 Fibre Channel</div>
<div class="description-paragraph" id="p-0348" num="0350">In the disclosed embodiments, support will be provided for fabric node (N_PORT) and arbitrated loop (NL_PORT). The Fibre Channel interface device will provide support for SCSI initiator or target operations.</div>
<div class="description-paragraph" id="p-0349" num="0351">Interoperability of this interface with current generation FC Fabric switches (Brocade, Ancor) must be assured. Point-to-Point mode must also be supported. This module should be identical to its counterpart in the SRC NAS image.</div>
<div class="description-paragraph" id="p-0350" num="0352">5.3 Mediation Example</div>
<div class="description-paragraph" id="p-0351" num="0353"> <figref idrefs="DRAWINGS">FIG. 23</figref> depicts an FC originator communicating with an FC Target (elements <b>2302</b> et seq), as follows:</div>
<div class="description-paragraph" id="p-0352" num="0354">ORIGINATOR˜sends a SCSI Read Command to TARGET</div>
<div class="description-paragraph" id="p-0353" num="0355">1. Each Originator/Target pair complete their LIP Sequence. Each 750 is notified of the existence of the Originator˜/Target^.</div>
<div class="description-paragraph" id="p-0354" num="0356">2. 750˜generates an IP command that tells IXP˜to make a connection to IXP^.</div>
<div class="description-paragraph" id="p-0355" num="0357">3. 750^ generates an IP command to tell IXPA to make Target^ ‘visible’ over IP.</div>
<div class="description-paragraph" id="p-0356" num="0358">4. Originator˜issues a SCSI READ CDB to Target-. Target-sends CDB to 750˜.</div>
<div class="description-paragraph" id="p-0357" num="0359">5. 750˜builds SCSI/IP request with CDB and issues it to IXP˜.</div>
<div class="description-paragraph" id="p-0358" num="0360">6. IXP˜sends packet to IXP^.</div>
<div class="description-paragraph" id="p-0359" num="0361">7. IXP^ sends IP packet to 750^.</div>
<div class="description-paragraph" id="p-0360" num="0362">8. 750^ removes SCSI CDB from IP packet and issues SCSI CDB request to OriginatorA (memory for READ COMMAND has been allocated).</div>
<div class="description-paragraph" id="p-0361" num="0363">9. Originator^ issue FCP_CMND to Target^.</div>
<div class="description-paragraph" id="p-0362" num="0364">10. When command is complete Target^ sends FCP_RSP to Originator^. Originator^ notifies 750^ with good status.</div>
<div class="description-paragraph" id="p-0363" num="0365">11. 750^ packages data and status into IP packets sends to IXP^.</div>
<div class="description-paragraph" id="p-0364" num="0366">12. IXP˜sends data and status to IXP˜.</div>
<div class="description-paragraph" id="p-0365" num="0367">13. IXP˜sends IP packets with data and status 750˜.</div>
<div class="description-paragraph" id="p-0366" num="0368">14. 750˜allocates buffer spaces, dumps data in to buffers and requests Target^ to send data and response to Originator-.</div>
<div class="description-paragraph" id="h-0009" num="0000">III. NFS Load Balancing</div>
<div class="description-paragraph" id="p-0367" num="0369">An object of load balancing is that several individual servers are made to appear as a single, virtual, server to a client (s). An overview is provided in <figref idrefs="DRAWINGS">FIG. 24</figref>, including elements <b>2402</b> et seq. In particular, the client makes file system requests to a virtual server. These requests are then directed to one of the servers that make up the virtual server. The file system requests can be broken into two categories; 1) reads, or those requests that do not modify the file system; and 2) writes or those requests that do change the file system.</div>
<div class="description-paragraph" id="p-0368" num="0370">Read requests do not change the file system and thus can be sent to any of the individual servers that make up the virtual server. Which server a request is sent to is determined by one of several possible load balancing algorithms.</div>
<div class="description-paragraph" id="p-0369" num="0371">This spreads the requests across several servers resulting in an improvement in performance over a single server. In addition, it allows the performance of a virtual server to be scaled simply by adding more physical servers.</div>
<div class="description-paragraph" id="p-0370" num="0372">Some of the possible load balancing algorithms are:</div>
<div class="description-paragraph" id="p-0371" num="0373">1. Round Robin where each request is sent to sequentially to the next server.</div>
<div class="description-paragraph" id="p-0372" num="0374">2. Weighted access where requests are sent to servers based on a percentage formula, e.g. 15% of the requests go to server A, 35% to server B, and 50% to server C. These Weighting factors can be fixed, or be dynamic based on such factors as server response time.</div>
<div class="description-paragraph" id="p-0373" num="0375">3. File handle where requests for files that have been acccessed previously are directed back to the server that originally satisfied the request. This increases performance by increasing the likelihood that the file will be found in the server's cache.</div>
<div class="description-paragraph" id="p-0374" num="0376">Write requests are different from read requests in that they must be broadcast to each of the individual servers so that the file systems on each server stay in sync. Thus, each write request generates several responses, one from each of the individual servers. However, only one response is sent back to the client.</div>
<div class="description-paragraph" id="p-0375" num="0377">An important way to improve performance is to return to the client the first positive response from any of the servers instead of waiting for all the server responses to be received. This means the client sees the fastest server response instead of the slowest. A problem can arise if all the servers do not send the same response, for example one of the servers fails to do the write while all the others are successful. This results in the server's file systems becoming un-sychronized. In order to catch and fix un-synchronized file systems, each outstanding write request must be remembered and the responses from each of the servers kept track of.</div>
<div class="description-paragraph" id="p-0376" num="0378">The file handle load balancing algorithm works well for directing requests for a particular file to a particular server. This increases the likelihood that the file will be found in the server's cache, resulting in a corresponding increase in performance over the case where the server has to go out to a disk. It also has the benefit of preventing a single file from being cached on two different servers, which uses the servers' caches more efficiently and allows more files to be cached. The algorithm can be extended to cover the case where a file is being read by many clients and the rate at which it is served to these clients could be improved by having more than one server serve this file. Initially a file's access will be directed to a single server. If the rate at which the file is being accessed exceeds a certain threshold another server can be added to the list of servers that handle this file. Successive requests for this file can be handled in a round robin fashion between the servers setup to handle the file.</div>
<div class="description-paragraph" id="p-0377" num="0379">Presumably the file will end up in the caches of both servers. This algorithm can handle an arbitrary number of servers handling a single file.</div>
<div class="description-paragraph" id="p-0378" num="0380">The following discussion describes methods and apparatus for providing NFS server load balancing in a system utilizing the Pirus box, and focuses on the process of how to balance file reads across several servers.</div>
<div class="description-paragraph" id="p-0379" num="0381">As illustrated in <figref idrefs="DRAWINGS">FIG. 24</figref>, NFS load balancing is done so that multiple NFS servers can be viewed as a single server. An NFS client issuing an NFS request does so to a single NFS IP address. These requests are captured by the NFS load balancing functionality and directed toward specific NFS servers.</div>
<div class="description-paragraph" id="p-0380" num="0382">The determination of which server to send the request to is based on two criteria, the load on the server and whether the server already has the file in cache.</div>
<div class="description-paragraph" id="p-0381" num="0383">The terms “SA” (the general purpose StrongArm processor that resides inside an IXP) and” Micro-engine” (the Micro-coded processor in the IXP are used herein. In one embodiment of the invention, there are <b>6</b> in each IXP.) As shown in the accompanying diagrams and specification, the invention utilizes “workload distribution” methods in conjunction with a multiplicity of NFS (or other protocol) servers. Among these methods (generically referred to herein as“load balancing”) are methods of “server load balancing” and“content aware switching”.</div>
<div class="description-paragraph" id="p-0382" num="0384">A preferred practice of the invention combines both“Load Balancing” and“Content Aware Switching” methods to distribute workload within a file server system. A primary goal of this invention is to provide salable performance by adding processing units, while“hiding” this increased system complexity from outside users.</div>
<div class="description-paragraph" id="p-0383" num="0385">The two methods used to distribute workload have different but complimentary characteristics. Both rely on the common method of examining or interpreting the contents of incoming requests, and then making a workload distribution decision based on the results of that examination.</div>
<div class="description-paragraph" id="p-0384" num="0386">Content Aware Switching presumes that the multiplicity of servers handle different contents; for example, different subdirectory trees of a common file system. In this mode of operation, the workload distribution method would be to pass requests for (e.g.) “subdirectory A” to one server, and “subdirectory B” to another. This method provides a fair distribution of workload among servers, given a statistically large population of independent requests, but can not provide enhanced response to a large number of simultaneous requests for a small set of files residing on a single server.</div>
<div class="description-paragraph" id="p-0385" num="0387">Server Load Balancing presumes that the multiplicity of servers handle similar content; for example, different RAID 1 replications of the same file system. In this mode of operation, the workload distribution method would be to select one of the set of available servers, based on criteria such as the load on the server, its availability, and whether it has the requested file in cache.</div>
<div class="description-paragraph" id="p-0386" num="0388">This method provides a fair distribution of workload among servers, when there are many simultaneous requests for a relatively small set of files.</div>
<div class="description-paragraph" id="p-0387" num="0389">These two methods may be combined, with content aware switching selecting among sets of servers, within which load balancing is performed to direct traffic to individual servers. As a separate invention, the content of the servers may be dynamically changed, for example by creating additional copies of commonly requested files, to provide additional server capacity transparently to the user.</div>
<div class="description-paragraph" id="p-0388" num="0390">As shown in the accompanying diagrams and specification, one element of the invention is the use of multiple computational elements, e.g. Network Processors and/or Storage CPUs, interconnected with a high speed connection network, such as a packet switch, crossbar switch, or shared memory system.</div>
<div class="description-paragraph" id="p-0389" num="0391">The resultant tight, low latency coupling facilitates the passing of necessary state information between the traffic distribution method and the file server method.</div>
<div class="description-paragraph" id="p-0390" num="0392">1. Operation 1.1</div>
<div class="description-paragraph" id="p-0391" num="0393">Read Requests Referring now to <figref idrefs="DRAWINGS">FIGS. 25 and 26</figref>, the following is the sequence of events that occurs in one embodiment of the invention, when an NFS READ (could also include other requests like LOOKUP) request is received.</div>
<div class="description-paragraph" id="p-0392" num="0394">1. A Micro-engine receives a packet on one of its ports from an NFS client that contains a READ request to the NFS domain.</div>
<div class="description-paragraph" id="p-0393" num="0395">2. The Micro-engine uses the file handle contained in the request to perform a lookup in a file handle hash table.</div>
<div class="description-paragraph" id="p-0394" num="0396">3. The hash lookup results in a pointer to a file handle entry (we'll assume a hit for now).</div>
<div class="description-paragraph" id="p-0395" num="0397">4. In the hash table is the IP address for the specific NFS server the request should be directed to. Presumably this NFS server should have the file in its cache and thus be able to serve it up more quickly than one that does not.</div>
<div class="description-paragraph" id="p-0396" num="0398">5. The destination IP address of the packet with the READ request is updated with the server IP address and then forwarded to the server.</div>
<div class="description-paragraph" id="p-0397" num="0399">A hash table entry can have more than one NFS server IP address. This allows a file that is under heavy access to exist in more than one NFS server cache and thus to be served up by more than one server. The selection of which specific server to direct a specific READ request to can be determined, but could be as simple as a round robin.</div>
<div class="description-paragraph" id="p-0398" num="0400">1.2 Determining the Number of Servers for a File</div>
<div class="description-paragraph" id="p-0399" num="0401">The desired behavior is that:</div>
<div class="description-paragraph" id="p-0400" num="0402">1. Files that are lightly accessed, i.e. have a low number of accesses per second, only need to be served by a single server.</div>
<div class="description-paragraph" id="p-0401" num="0403">2. Files that are heavily accessed are served by more than one server.</div>
<div class="description-paragraph" id="p-0402" num="0404">3. Accesses to a file are directed to the same server, or set of servers if it is being heavily accessed, to keep accesses directed to those servers that have that file in its cache.</div>
<div class="description-paragraph" id="p-0403" num="0405">1.3 Server Lists</div>
<div class="description-paragraph" id="p-0404" num="0406">In addition to being able to be looked up using the file handle hash table, file handle entries can be placed on doubly linked lists. There can be a number of such linked lists. Each list has the file handle entries on it that have a specific number of servers serving them. There is a list for file handle entries that have only one server serving them. Thus, as shown in <figref idrefs="DRAWINGS">FIG. 27</figref>, for example, there might a total of three lists; a single server list, a two-server list and a four-server list. The single server list has entries in it that are being served by one server, the two-server list is a list of the entries being served by two servers, etc. File handle entries are moved from list to list as the frequency of access increases or decreases.</div>
<div class="description-paragraph" id="p-0405" num="0407">1. 3.1 Single Server List</div>
<div class="description-paragraph" id="p-0406" num="0408">All the file handle entries begin on the single server list. When a READ request is received the file handle in the READ is used to access the hash table. If there is no entry for that file handle a free entry is taken from the entry free list and a single server is selected to serve the file, by some criteria such as least loaded, fastest responding or round robin. If no entries are free then a server is selected and the request is sent directly to it without an entry being filled out. Once a new entry is filled out it is added to the hash table and placed at the top of the single server list queue.</div>
<div class="description-paragraph" id="p-0407" num="0409">Periodically, a process check the free list and if it is close to empty it will take some number of entries off the bottom of the single server list, remove them from hash table and then place them back on the free list. This keeps the free list replenished.</div>
<div class="description-paragraph" id="p-0408" num="0410">Since entries are placed on the top of the list and taken off from the bottom, each entry spends a certain amount of time on the list, which varies according to rate at which new file handle READ requests occur. During the period of time that an entry exists on the list it has the opportunity to be hit by another READ access. Each time a hit occurs a counter is bumped in the entry. If an entry receives enough hits while it is on the list to exceed a pre-defined threshold it is deemed to have enough activity to it to deserve to have more servers serving it. Such an entry is then taken off the single server list, additional servers selected to serve the file, and then placed on one of the multiple server lists.</div>
<div class="description-paragraph" id="p-0409" num="0411">In the illustrated embodiment of the invention, it is expected that the micro-engines will handle the lookup and forwarding of requests to the servers, and that the SA will handle all the entry movements between lists and adding and removing them from the hash table. However, other distributions of labor can be utilized.</div>
<div class="description-paragraph" id="p-0410" num="0412">1.3.2 Multiple Server Lists</div>
<div class="description-paragraph" id="p-0411" num="0413">In addition to the single server list, there are multiple server lists. Each multiple server list contains the entries that are being served by the same number of servers. Just like with entries on the single server list, entries on the multiple server lists get promoted to the top of the next list when their frequency of access exceeds a certain threshold. Thus a file that is being heavily accessed might move from the single server list, to the dual server list and finally to the quad server list.</div>
<div class="description-paragraph" id="p-0412" num="0414">When an entry moves to a new list it is added to the top of that list.</div>
<div class="description-paragraph" id="p-0413" num="0415">Periodically, a process will re-sort the list by frequency of access. As a file becomes less frequently accessed it will move toward the bottom of its list.</div>
<div class="description-paragraph" id="p-0414" num="0416">Eventually the frequency of access will fall below a certain threshold and the entry will be placed on the top of the previous list, e.g. an entry might fall off the quad server list and be put on the dual server list. During this demotion process the number of servers serving this file will be reduced.</div>
<div class="description-paragraph" id="p-0415" num="0417">1.4 Synchronizing Lists Across Multiple IXP's</div>
<div class="description-paragraph" id="p-0416" num="0418">The above scheme works well when one entity, i.e., an IXP, sees all the file READ requests. However, this will not be the case in most systems. In order to have the same set of servers serving a file information must be passed between IXP's that have the same file entry. This information needs to be passed when an entry is promoted or demoted between lists, as this is when servers are added or taken away.</div>
<div class="description-paragraph" id="p-0417" num="0419">When an entry is going to be promoted by an IXP it first broadcasts to all the other IXP's asking for their file handle entries for the file handle of the entry it wants to promote. When it receives the entries from the other IXP's it looks to see whether one of the other IXP's has already promoted this entry. If it has, it adds the new servers from that entry. If not, it selects new servers based on some TBD criteria.</div>
<div class="description-paragraph" id="p-0418" num="0420">Demotion of an entry from one list to the other works much the same way, except that when the demoting IXP looks at the entries from the other IXP's it looks for entries that have less servers than its entry currently does. If there are any then it selects those servers. This keeps the same set of servers serving a file even as fewer of them are serving it. If there are no entries with fewer servers, then the IXP can use one or more criteria to remove the needed number of servers from the entry.</div>
<div class="description-paragraph" id="p-0419" num="0421">There are advantages to making load balancing decisions based upon filehandle information. When the inode portion of the filehandle is used to select a unique target NAS server for information reads, a maximally distributed cache is achieved. When an entire NAS working set of files fits in any one cache then a lowest latency response system is created by allowing all working set files to be simultaneously inside every NAS server's cache. Load balancing is then best performed using a round-robin policy.</div>
<div class="description-paragraph" id="p-0420" num="0422">Pirus NAS servers will provide cache utilization feedback to an IXP load balancer. The LB can use this feedback to dynamically shift between maximally distributed caching and round-robin balancing for smaller working sets. These processes are depicted in <figref idrefs="DRAWINGS">FIGS. 25 and 26</figref> (NFS Receive Micro-Code Flowchart and NFS Transmit Micro-Code Flowchart).</div>
<div class="description-paragraph" id="h-0010" num="0000">IV. Intelligent Forwarding and Filtering</div>
<div class="description-paragraph" id="p-0421" num="0423">The following discussion describes certain Pirus box functions referred to as intelligent forwarding and filtering (IFF). IFF is optimized to support the load balancing function described elsewhere herein. Hence, the following discussion contains various load balancing definitions that will facilitate an understanding of IFF.</div>
<div class="description-paragraph" id="p-0422" num="0424">As noted elsewhere herein, the Pirus box provides load-balancing functions, in a manner that is transparent to the client and server. Therefore, the packets that traverse the box do not incur a hop count as they would, for example, when traversing a router. <figref idrefs="DRAWINGS">FIG. 28</figref> is illustrative. In <figref idrefs="DRAWINGS">FIG. 28</figref>, Servers <b>1</b>,<b>2</b> , and <b>3</b> are directly connected to the Pirus box (denoted by the pear icon), and packets forwarded to them are sent to their respective MAC addresses. Server <b>4</b> sits behind a router and packets forwarded to it are sent to the MAC address of the router interface that connects to the Pirus box. Two upstream routers forward packets from the Internet to the Pirus box.</div>
<div class="description-paragraph" id="p-0423" num="0425">1. Definitions The following definitions are used in this discussion:</div>
<div class="description-paragraph" id="p-0424" num="0426">A Server Network Processor (SNP) provides the functionality for ports connected to servers. Packets received from a server are processed an SNP.</div>
<div class="description-paragraph" id="p-0425" num="0427">A Router Network Processor (RNP) provides the functionality for ports connected to routers or similar devices. Packets received from a router are processed an RNP.</div>
<div class="description-paragraph" id="p-0426" num="0428">In accordance with the invention, an NP may support the role of RNP and SNP simultaneously. This is likely to be true, for example, on 10/100 Ethernet modules, as the NP will server many ports, connected to both routers and servers.</div>
<div class="description-paragraph" id="p-0427" num="0429">An upstream router is the router that connects the Internet to the Pirus box.</div>
<div class="description-paragraph" id="p-0428" num="0430">2. Virtual Domains</div>
<div class="description-paragraph" id="p-0429" num="0431">As used herein, the term “virtual domain” denotes a portion of a domain that is served by the Pirus box. It is “virtual” because the entire domain may be distributed throughout the Internet and a global load-balancing scheme can be used to“tie it all together” into a single domain.</div>
<div class="description-paragraph" id="p-0430" num="0432">In one practice of the invention, defining a virtual domain, on a Pirus box requires specifying one or more URLs, such as www.fred.com, and one or more virtual IP addresses that are used by clients to address the domain. In addition, a list of the IP addresses of the physical servers that provide the content for the domain must be specified; the Pirus box will load-balance across these servers. Each physical server definition will include, among other things, the IP address of the server and, optionally, a protocol and port number (used for TCP/UDP port multiplexing-see below).</div>
<div class="description-paragraph" id="p-0431" num="0433">For servers that are not directly connected to the Pirus box, a route, most likely static, will need to be present; this route will contain either the IP address or IP subnet of the server that is NOT directly connected, with a gateway that is the IP address of the router interface that connects to the Pirus box to be used as the next-hop to the server.</div>
<div class="description-paragraph" id="p-0432" num="0434">The IP subnet/mask pairs of the devices that make up the virtual domain should be configured. These subnet/mask pairs indirectly create a route table for the virtual domain. This allows the Pirus box to forward packets within a virtual domain, such as from content servers to application or database servers. A mask of 255.255.255.255 can be used to add a static host route to a particular device.</div>
<div class="description-paragraph" id="p-0433" num="0435">The Pirus box may be assigned an IP address from this subnet/mask pair. This IP address will be used in all IP and ARP packets authored by the Pirus box and sent to devices in the virtual domain. If an IP address is not assigned, all IP and ARP packets will contain a source IP address equal to one of the virtual IP addresses of the domain. <figref idrefs="DRAWINGS">FIG. 29</figref> is illustrative. In <figref idrefs="DRAWINGS">FIG. 29</figref>, the Pirus box is designated by numeral 100. Also in <figref idrefs="DRAWINGS">FIG. 29</figref>, the syntax for a port is &lt;slot number&gt;. &lt;port number&gt;) ports 1.3, 2.3, 3.3, 4.3, 5.1 and 5.3 are part of the same virtual domain. Server 1.1. 1.1 may need to send packets to Cache 1.1. 1.100. Even though the Cache may not be explicitly configured as part of the virtual domain, configuring the virtual domain with an IP subnet/mask of 1.1. 1.0/255. 255.255. 0 will allow the servers to communicate with the cache. Server 1.1. 1.1 may also need to send packets to Cache 192.168. 1.100. Since this IP subnet is outside the scope of the virtual domain (i.e., the cache, and therefore the IP address, may be owned by the ISP), a static host route can be added to this one particular device.</div>
<div class="description-paragraph" id="p-0434" num="0436">2.1 Network Address Translation In one practice of the invention, Network Address Translation, or NAT, is performed on packets sent to or from a virtual IP address. In <figref idrefs="DRAWINGS">FIG. 29</figref> above, a client connected to the Internet will send a packet to a virtual IP address representing a virtual domain. The load-balancing function will select a physical server to send the packet to. NAT results in the destination IP address (and possibly the destination TCP/UDP port, if port multiplexing is being used) being changed to that of the physical server. The response packet from the server also has NAT performed on it to change the source IP address (and possibly the source TCP/UDP port) to that of the virtual domain.</div>
<div class="description-paragraph" id="p-0435" num="0437">NAT is also performed when a load-balanceable server sends a request that also passes through the load-balancing function, such as an NFS request. In this case, the server assumes the role of a client.</div>
<div class="description-paragraph" id="p-0436" num="0438">3. VLAN Definition</div>
<div class="description-paragraph" id="p-0437" num="0439">It is contemplated that since the Pirus box will have many physical ports, the Virtual LAN (VLAN) concept will be supported. Ports that connect to servers and upstream routers will be grouped into their own VLAN, and the VLAN will be added to the configuration of a virtual domain.</div>
<div class="description-paragraph" id="p-0438" num="0440">In one practice of the invention, a virtual domain will be configured with exactly one VLAN. Although the server farms comprising the virtual domain may belong to multiple subnets, the Pirus box will not be routing (in a traditional sense) between the subnets, but will be performing a form of L<b>3</b> switching.</div>
<div class="description-paragraph" id="p-0439" num="0441">Unlike today's L<b>3</b> switch/routers that switch frames within a VLAN at Layer 2 and route packets between VLANs at Layer 3, the Pirus box will switch packets using a combination of Layer 2 and Layer 3 information. It is expected that the complexity of routing between multiple VLANs will be avoided.</div>
<div class="description-paragraph" id="p-0440" num="0442">By default, packets received on all ports in the VLAN of a virtual domain are candidates for load balancing. On Router ports (see 4.4. 1, Router Port), these packets are usually HTTP or FTP requests. On Server ports (see 4.4. 2, Server Port), these packets are usually back-end server requests, such as NFS.</div>
<div class="description-paragraph" id="p-0441" num="0443">All packets received by the Pirus box are classified to a VLAN and are, hence, associated with a virtual domain. In some cases, this classification may be ambiguous because, with certain constraints, a physical port may belong to more than one VLAN. These constraints are discussed below.</div>
<div class="description-paragraph" id="p-0442" num="0444">3.1 Default VLAN</div>
<div class="description-paragraph" id="p-0443" num="0445">In one practice of the invention, by default, every port will be assigned to the Default VLAN. All non-IP packets received by the Pirus box are classified to the Default VLAN. If a port is removed from the Default VLAN, non-IP packets received on that port are discarded, and non-IP packets received on other ports will not be sent on that port.</div>
<div class="description-paragraph" id="p-0444" num="0446">In accordance with this practice of the invention, all non-IP packets will be handled in the slow path. This CPU will need to build and maintain MAC address tables to avoid flooding all received packets on the Default VLAN.</div>
<div class="description-paragraph" id="p-0445" num="0447">The packets will be forwarded to a single CPU determined by an election process. This avoids having to copy (potentially large) forwarding tables between slots but may result in each packet traversing the switch fabric twice.</div>
<div class="description-paragraph" id="p-0446" num="0448">3.2 Server Administration</div>
<div class="description-paragraph" id="p-0447" num="0449">VLAN Devices connected to ports on the Server Administration VLAN can manage the physical servers in any virtual domain. By providing only this form of inter-VLAN routing, the system can avoid having to add Server Administration ports (see below) to the VLANs of every virtual domain that the server administration stations will manage.</div>
<div class="description-paragraph" id="p-0448" num="0450">3.3 Server Access VLAN</div>
<div class="description-paragraph" id="p-0449" num="0451">A Server Access VLAN is used internally between Pirus boxes. A Pirus box can make a load-balancing decision to send a packet to a physical server that is connected to another Pirus box. The packet will be sent on a Server Access VLAN that, unlike packets received on Router ports, may directly address physical servers. See the discussion of Load Balancing elsewhere herein for additional information on how this is used.</div>
<div class="description-paragraph" id="p-0450" num="0452">3.4 Port Types</div>
<div class="description-paragraph" id="p-0451" num="0453">3.4.1 Router Port</div>
<div class="description-paragraph" id="p-0452" num="0454">In one embodiment of the invention, one or more Router ports will be added to the VLAN configuration of a virtual domain. Note that a Router port is likely to be carrying traffic for many virtual domains.</div>
<div class="description-paragraph" id="p-0453" num="0455">Classifying a packet received on a Router port to a VLAN of a virtual domain is done by matching the destination IP address to one of the virtual IP addresses of the configured virtual domains.</div>
<div class="description-paragraph" id="p-0454" num="0456">ARP requests sent by the Pirus box to determine the MAC address and physical port of the servers that are configured as part of a virtual domain are not sent out Router ports. If a server is connected to the same port as an upstream router, the port must be configured as a Combo port (see below).</div>
<div class="description-paragraph" id="p-0455" num="0457">3.4.2 Server Port</div>
<div class="description-paragraph" id="p-0456" num="0458">Server ports connect to the servers that provide the content for a virtual domain. A Server port will most likely be connected to a single server, although it may be connected to multiple servers.</div>
<div class="description-paragraph" id="p-0457" num="0459">Classifying a packet received on a Server port to a VLAN of a virtual domain may require a number of steps.</div>
<div class="description-paragraph" id="p-0458" num="0460">1. using the VLAN of the port if the port is part of a single VLAN</div>
<div class="description-paragraph" id="p-0459" num="0461">2. matching the destination IP address and TCP/UDP port number to the source of a flow (i.e., an HTTP response)</div>
<div class="description-paragraph" id="p-0460" num="0462">3. matching the destination IP address to one of the virtual IP addresses of the configured virtual domains (i.e., an NFS request) The default and preferred configuration is for a Server port to be a member of a single VLAN. However, multiple servers, physical or logical, may be connected to the same port and be in different VLANs only if the packets received on that port can unambiguously be associated with one of the VLANs on that port.</div>
<div class="description-paragraph" id="p-0461" num="0463">One way for this is to use different IP subnets for all devices on the VLANs that the port connects to. TCP/UDP port multiplexing is often configured with a single IP address on a server and multiple TCP/UDP ports, one per virtual domain. It is preferable to also use a different IP address with each TCP/UDP port, but this is necessary only if the single server needs to send packets with TCP/UDP ports other than the ones configured on the Pirus box.</div>
<div class="description-paragraph" id="p-0462" num="0464">In <figref idrefs="DRAWINGS">FIG. 30</figref>, the physical server with IP address 1.1.1.4 provides HTTP content for two virtual domains, www.larry.com and www.curly.com. TCP/UDP port multiplexing is used to allow the same server to provide content for both virtual domains. When the Pirus box load balances packets to this server, it will use NAT to translate the destination IP address to 1.1.1.4 and the TCP port to 8001 for packets sent to www. larry.com and 8002 for packets sent to www. curly. com.</div>
<div class="description-paragraph" id="p-0463" num="0465">Packets sent from this server with a source TCP port of 8001 or 8002 can be classified to the appropriate domain. But if the server needs to send packets with other source ports (i.e., if it needs to perform an NFS request), it is ambiguous as to which domain the packet should be mapped.</div>
<div class="description-paragraph" id="p-0464" num="0466">The list of physical servers that make up a domain may require significant configuration. The IP addresses of each must be entered as part of the domain. To minimize the amount of information that the administrator must provide, the Pirus box determines the physical port that connects to a server, as well as its MAC address, by issuing ARP requests to the IP addresses of the servers. The initial ARP requests are only sent out Server and Combo ports. The management software may allow the administrator to specify the physical port to which a server is attached. This restricts the ARP request used to obtain the MAC address to that port only.</div>
<div class="description-paragraph" id="p-0465" num="0467">A Server port may be connected to a router that sits between the Pirus box and a server farm. In this configuration, the VLAN of the virtual domain must be configured with a static route of the subnet of the server farm that points to the IP address of the router port connected to the Pirus box. This intermediate router needs a route back to the Pirus box as well (either a default route or a route to the virtual IP address (es) of the virtual domain (s) served by the server farm.</div>
<div class="description-paragraph" id="p-0466" num="0468">3.4.3 Combo Port</div>
<div class="description-paragraph" id="p-0467" num="0469">A Combo port, as defined herein, is connected to both upstream routers and servers. Packet VLAN classification first follows the rules for Router ports then Server ports.</div>
<div class="description-paragraph" id="p-0468" num="0470">3.4.4 Server Administration Port</div>
<div class="description-paragraph" id="p-0469" num="0471">A Server Administration port is connected to nodes that administer servers. Unlike packets received on a Router port, packets received on a Server Administration port can be sent directly to servers. Packets can also be sent to virtual IP addresses in order to test the load-balancing function.</div>
<div class="description-paragraph" id="p-0470" num="0472">A Server Administration port may be assigned to a VLAN that is associated with a virtual domain, or it may be assigned to the Server Administration VLAN. The former is straightforward-the packets are forwarded only to servers that are part of the virtual domain. The latter case is more complicated, as the packets received on the Server Administration port can only be sent to a particular server if that server's IP address is unique among all server IP addresses known to the Pirus box. This uniqueness requirement also applies if the same server is in two different virtual domains with TCP/UDP port multiplexing.</div>
<div class="description-paragraph" id="p-0471" num="0473">3.4.5 Server Access Port A Server Access port is similar to a trunk port on a conventional Layer 2 switch. It is used to connect to another Pirus box and carry“tagged” traffic for multiple VLANs. This allows one Pirus box to forward a packet to a server connected to another Pirus box.</div>
<div class="description-paragraph" id="p-0472" num="0474">The Pirus box will use the IEEE 802. 1Q VLAN trunking format. A VLAN ID will be assigned to the VLAN that is associated with the virtual domain. This VLAN ID will be carried in the VLAN tag field of the 802. 1Q header.</div>
<div class="description-paragraph" id="p-0473" num="0475">3.4.6 Example of VLAN <figref idrefs="DRAWINGS">FIG. 30</figref> is illustrative of a VLAN. Referring now to <figref idrefs="DRAWINGS">FIG. 30</figref>, the Pirus box, designated by the pear icon, is shown with 5 slots, each of which has 3 ports. The VLAN configuration is as follows (the syntax for a port is slot number&gt;. &lt;port number&gt;):</div>
<div class="description-paragraph" id="p-0474" num="0476">VLAN 1</div>
<div class="description-paragraph" id="p-0475" num="0477">Server ports 1.1, 2.1, 3.1 and 4.3 (denoted in picture by a dotted line)</div>
<div class="description-paragraph" id="p-0476" num="0478">Router port 4.1 (denoted in picture by a heavy solid line)</div>
<div class="description-paragraph" id="p-0477" num="0479">VLAN 2</div>
<div class="description-paragraph" id="p-0478" num="0480">Server ports 1.2, 2.2, 3.2 and 4.3 (denoted in picture by a dashed line)</div>
<div class="description-paragraph" id="p-0479" num="0481">Server Administration port 5.2</div>
<div class="description-paragraph" id="p-0480" num="0482">Router port 4.1 (denoted in picture by a heavy solid line)</div>
<div class="description-paragraph" id="p-0481" num="0483">VLAN 3</div>
<div class="description-paragraph" id="p-0482" num="0484">Server ports 1.3, 2.3, 3.3 and 4.3 (denoted in picture by a solid line) o Server Administration port 5.3</div>
<div class="description-paragraph" id="p-0483" num="0485">Router port 4.1 (denoted in picture by a heavy solid line) Server Administration VLAN</div>
<div class="description-paragraph" id="p-0484" num="0486">Server Administration port 5.1 (denoted in picture by wide area link)</div>
<div class="description-paragraph" id="p-0485" num="0487">An exemplary virtual domain configuration is as follows:</div>
<div class="description-paragraph" id="p-0486" num="0488">Virtual domain www.moe.com</div>
<div class="description-paragraph" id="p-0487" num="0489">Virtual IP address 100.1.1.1</div>
<div class="description-paragraph" id="p-0488" num="0490">VLAN 1§Server 2.1.1.1 §Server 2.1.1.2 §Server 2.1.1.3 §Server 2.1.1.4 Virtual domain www.larry.com</div>
<div class="description-paragraph" id="p-0489" num="0491">Virtual IP address 200.1.1.1</div>
<div class="description-paragraph" id="p-0490" num="0492">VLAN 2</div>
<div class="description-paragraph" id="p-0491" num="0493">Server 1.1.1.1</div>
<div class="description-paragraph" id="p-0492" num="0494">Server 1.1.1.2</div>
<div class="description-paragraph" id="p-0493" num="0495">Server 1.1.1.3</div>
<div class="description-paragraph" id="p-0494" num="0496">Server 1.1.1.4 Port 8001 Virtual domain www.curly.com</div>
<div class="description-paragraph" id="p-0495" num="0497">Virtual IP address 300.1. 1.1</div>
<div class="description-paragraph" id="p-0496" num="0498">VLAN 3</div>
<div class="description-paragraph" id="p-0497" num="0499">Server 1.1.1.1</div>
<div class="description-paragraph" id="p-0498" num="0500">Server 1.1.1.2</div>
<div class="description-paragraph" id="p-0499" num="0501">Server 1.1.1.3</div>
<div class="description-paragraph" id="p-0500" num="0502">Server 1.1.1.4 Port 8002</div>
<div class="description-paragraph" id="p-0501" num="0503">Domain www.larry.com and www.curly.com each have a VLAN containing 3 servers with the same IP addresses: 1.1.1.1, 1.1.1.2 and 1.1.1.3. This functionality allows different customers to have virtual domains with servers using their own private address space that doesn't need to be unique among all the servers known to the Pirus box. They also contain the same server with IP address 1.1. 1.4. Note the Port number in the configuration. This is an example of TCP/UDP port multiplexing, where different domains can use the same server, each using a unique port number. Domain www.moe.com has servers in their own address space, although server 2.1.1.4 is connected to the same port (4.3) as server 1.1.1.4 shared by the other two domains.</div>
<div class="description-paragraph" id="p-0502" num="0504">The administration station connected to port 5.2 is used to administer the servers in the www.larry.com virtual domain, and the station connected to 5.3 is used to administer the servers in the www.curly.com domain. The administration station connected to port 5.1 can administer the servers in www.moe.com.</div>
<div class="description-paragraph" id="p-0503" num="0505">4. Filtering Function The filtering function of an RNP performs filtering on packets received from an upstream router. This ensures that the physical servers downstream from the Pirus box are not accessed directly from clients connected to the Internet 5. Forwarding Function The Pirus box will track flows between IP devices. A flow is a bi-directional conversation between two connected IP devices; it is identified by a source IP address, source UDP/TCP port, destination IP address, and destination TCP/UDP port.</div>
<div class="description-paragraph" id="p-0504" num="0506">A single flow table will contain flow entries for each flow through the Pirus box. The forwarding entry content, creation, removal and use are discussed below.</div>
<div class="description-paragraph" id="p-0505" num="0507">5.1 Flow Entry Description</div>
<div class="description-paragraph" id="p-0506" num="0508">A flow entry describes a flow and the information necessary to reach the endpoints of the flow. A flow entry contains the following information:</div>
<div class="description-paragraph" id="p-0507" num="0509">
<tables id="TABLE-US-00001" num="00001">
<patent-tables colsep="0" frame="none" rowsep="0">
<table align="left" class="description-table" cols="3" colsep="0" rowsep="0" width="100%">
<thead>
<tr class="description-tr">
<td align="center" class="description-td" colspan="3" nameend="3" namest="1" rowsep="1"> </td>
</tr>
<tr class="description-tr">
<td class="description-td">Attribute</td>
<td class="description-td"># of Bytes</td>
<td class="description-td">Description</td>
</tr>
<tr class="description-tr">
<td align="center" class="description-td" colspan="3" nameend="3" namest="1" rowsep="1"> </td>
</tr>
</thead>
<tbody><tr class="description-tr">
<td class="description-td"> </td>
</tr>
</tbody></table>
<table align="left" class="description-table" cols="3" colsep="0" rowsep="0" width="100%">
<tbody><tr class="description-tr">
<td class="description-td">Source IP address</td>
<td class="description-td">4</td>
<td class="description-td">Source IP address</td>
</tr>
<tr class="description-tr">
<td class="description-td">Destination IP address</td>
<td class="description-td">4</td>
<td class="description-td">Destination IP address</td>
</tr>
<tr class="description-tr">
<td class="description-td">Source TCP/UDP port</td>
<td class="description-td">2</td>
<td class="description-td">Source higher layer port</td>
</tr>
<tr class="description-tr">
<td class="description-td">Destination TCP/UDP port</td>
<td class="description-td">2</td>
<td class="description-td">Destination higher layer port</td>
</tr>
<tr class="description-tr">
<td class="description-td">Source physical port</td>
<td class="description-td">2</td>
<td class="description-td">Physical port of the source</td>
</tr>
<tr class="description-tr">
<td class="description-td">Source next-hop MAC</td>
<td class="description-td">6</td>
<td class="description-td">The MAC address of next-</td>
</tr>
<tr class="description-tr">
<td class="description-td">address</td>
<td class="description-td"> </td>
<td class="description-td">hop to source</td>
</tr>
<tr class="description-tr">
<td class="description-td">Destination physical port</td>
<td class="description-td">2</td>
<td class="description-td">Physical port of destination</td>
</tr>
<tr class="description-tr">
<td class="description-td">Destination next-hop MAC</td>
<td class="description-td">6</td>
<td class="description-td">MC address of next-hop to</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">address destination</td>
</tr>
<tr class="description-tr">
<td class="description-td">NAT IP address</td>
<td class="description-td">4</td>
<td class="description-td">Translation IP address</td>
</tr>
<tr class="description-tr">
<td class="description-td">NAT TCP/UDP port</td>
<td class="description-td">2</td>
<td class="description-td">Translation higher layer port</td>
</tr>
<tr class="description-tr">
<td class="description-td">Flags</td>
<td class="description-td">2</td>
<td class="description-td">Various flags</td>
</tr>
<tr class="description-tr">
<td class="description-td">Received packets</td>
<td class="description-td">2</td>
<td class="description-td">No. packets received from</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">source IP address</td>
</tr>
<tr class="description-tr">
<td class="description-td">Transmitted packets</td>
<td class="description-td">2</td>
<td class="description-td">No. packets sent to source IP</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">address</td>
</tr>
<tr class="description-tr">
<td class="description-td">Received bytes</td>
<td class="description-td">4</td>
<td class="description-td">No. bytes received from</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">source IP address</td>
</tr>
<tr class="description-tr">
<td class="description-td">Transmitted bytes</td>
<td class="description-td">4</td>
<td class="description-td">No. bytes sent to source IP</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">address</td>
</tr>
<tr class="description-tr">
<td class="description-td">Next pointer (receive path)</td>
<td class="description-td">4</td>
<td class="description-td">Pointer to next forwarding</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">entry in hash table used in the</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">receive path</td>
</tr>
<tr class="description-tr">
<td class="description-td">Next pointer (transmit path)</td>
<td class="description-td">4</td>
<td class="description-td">Pointer to next forwarding</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">entry in the hash table used in</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">the transmit path</td>
</tr>
<tr class="description-tr">
<td class="description-td">Transmit path key</td>
<td class="description-td">4</td>
<td class="description-td">Smaller key unique</td>
</tr>
<tr class="description-tr">
<td align="center" class="description-td" colspan="3" nameend="3" namest="1" rowsep="1"> </td>
</tr>
</tbody></table>
</patent-tables>
</tables>
</div>
<div class="description-paragraph" id="p-0508" num="0510">Total 60 among all flow entries</div>
<div class="description-paragraph" id="p-0509" num="0511">In accordance with the invention, the IP addresses and TCP/UDP ports in a flow entry are relative to the direction of the flow. Therefore, a flow entry for a flow will be different in the flow tables that handle each direction. This means a flow will have 2 different flow entries, one on the NP that connects to the source of the flow and one on the NP that connects to the destination of the flow. If the same NP connects to both the source and destination, then that NP will contain 2 flow entries for the flow.</div>
<div class="description-paragraph" id="p-0510" num="0512">In one practice of the invention, on an RNP, the first four attributes uniquely identify a flow entry. The source and destination IP addresses are globally unique in this context since they both represent reachable Internet addresses.</div>
<div class="description-paragraph" id="p-0511" num="0513">On an SNP, the fifth attribute is also required to uniquely identify a flow entry. This is best described in connection with the example shown in <figref idrefs="DRAWINGS">FIG. 31</figref>. As shown therein, a mega-proxy, such as AOL, performs NAT on the source IP address and TCP/UDP port combinations from the clients that connect them. Since a flow is defined by source and destination IP address and TCP/UDP port, the proxy can theoretically reuse the same source IP address and TCP/UDP port when communicating with different destinations.</div>
<div class="description-paragraph" id="p-0512" num="0514">But when the Pirus box performs load balancing and NAT from the virtual IP address to a particular server, the destination IP addresses and TCP/UDP port of the packets may no longer be unique to a particular flow. Therefore, the virtual domain must be included in the comparison to find the flow entry.</div>
<div class="description-paragraph" id="p-0513" num="0515">Requiring that the IP addresses reachable on a Server port be unique across all virtual domains on that port solves the problem. The flow entry lookup can also compare the source physical port of the flow entry with the physical port on which the packet was received.</div>
<div class="description-paragraph" id="p-0514" num="0516">A description of the attributes is as follows:</div>
<div class="description-paragraph" id="p-0515" num="0517">5.1.1 Source IP address: The source IP address of the packet. Source TCP/UDP port: The source TCP/UDP port number of the packet.</div>
<div class="description-paragraph" id="p-0516" num="0518">5.1.2 Destination IP address: The destination IP address of the packet.</div>
<div class="description-paragraph" id="p-0517" num="0519">5.1.3 Destination TCP/UDP port: The destination TCP/UDP port number of the packet.</div>
<div class="description-paragraph" id="p-0518" num="0520">5.1.4 Source physical port: The physical port on the Pirus box used to reach the source IP address.</div>
<div class="description-paragraph" id="p-0519" num="0521">5.1.5 Source next-hop MAC address: The MAC address of the next-hop to the source IP address. This MAC address is reachable out the source physical port and may be the host that owns the IP address.</div>
<div class="description-paragraph" id="p-0520" num="0522">5.1.6 Destination physical port: The physical port on the Pirus box used to reach the destination IP address.</div>
<div class="description-paragraph" id="p-0521" num="0523">5.1.7 Destination next-hop MAC address: The MAC address of the next-hop to the destination IP address. This MAC address is reachable out the destination physical port and may be the host that owns the IP address.</div>
<div class="description-paragraph" id="p-0522" num="0524">5.1.8 NAT IP address: The IP address that either the source or destination IP addresses must be translated to. If the source IP address in the flow entry represents the source of the flow, then this address replaces the destination IP address in the packet. If the source IP address in the flow entry represents the destination of the flow, then this address replaces the source IP address in the packet.</div>
<div class="description-paragraph" id="p-0523" num="0525">5.1.9 NAT TCP/UDP port: The TCP/UDP port that either the source or destination TCP/UDP port must be translated to. If the source TCP/UDP port in the flow entry represents the source of the flow, then this port replaces the destination TCP/UDP port in the packet. If the source TCP/UDP port in the flow entry represents the destination of the flow, then this port replaces the source TCP/UDP port in the packet.</div>
<div class="description-paragraph" id="p-0524" num="0526">5.1.10 Flags: Various flags can be used to denote whether the flow entry is relative to the source or destination of the flow, etc.</div>
<div class="description-paragraph" id="p-0525" num="0527">5.1.11 Received packets: The number of packets received with a source IP address and TCP/UDP port equal to that in the flow entry.</div>
<div class="description-paragraph" id="p-0526" num="0528">5.1.12 Transmitted packets: The number of packets transmitted with a destination IP address and TCP/UDP port equal to that in the flow entry.</div>
<div class="description-paragraph" id="p-0527" num="0529">5.1.13 Received bytes: The number of bytes received with a source IP address and TCP/UDP port equal to that in the flow entry.</div>
<div class="description-paragraph" id="p-0528" num="0530">5.1.14 Transmitted bytes: The number of bytes transmitted with a destination IP address and TCP/UDP port equal to that in the flow entry.</div>
<div class="description-paragraph" id="p-0529" num="0531">5.1.15 Next pointer (receive path): A pointer to the next flow entry in the linked list. It is assumed that a hash table will be used to store the flow entries. This pointer will be used to traverse the list of hash collisions in the hash done by the receive path (see below).</div>
<div class="description-paragraph" id="p-0530" num="0532">5.1.16 Next pointer (transmit path): A pointer to the next flow entry in the linked list. It is assumed that a hash table will be used to store the flow entries. This pointer will be used to traverse the list of hash collisions in the hash done by the transmit path (see below).</div>
<div class="description-paragraph" id="p-0531" num="0533">5.2 Adding Forwarding Entries</div>
<div class="description-paragraph" id="p-0532" num="0534">5.2.1 Client IP Addresses:</div>
<div class="description-paragraph" id="p-0533" num="0535">A client IP address is identified as a source IP address in a packet that has a destination IP address that is part of a virtual domain. A flow entry is created for client IP addresses by the load-balancing function. A packet received on a Router or Server port is matched against the configured policies of a virtual domain. If a physical server is chosen to receive the packet, a flow entry is created with the following values: Attribute Value Source IP address the source IP address from the packet Destination IP address the destination IP address from the packet Source TCP/UDP port the source TCP/UDP port from the packet Destination TCP/UDP port the destination TCP/UDP port from the packet</div>
<div class="description-paragraph" id="p-0534" num="0536">Source physical port the physical port on which the packet was received Source next-hop MAC address source MAC address of the packet Destination physical port the physical port connected to the server Destination next-hop MAC the MAC address of the server address NAT IP address IP address of the server chosen by the load-balancing function NAT TCP/UDP port TCP/UDP port number of the chosen server.</div>
<div class="description-paragraph" id="p-0535" num="0537">This may be different from the destination TCP/UDP port if port multiplexing is used Flags Can be determined In one practice of the invention, the flow entry will be added to two hash tables. One hash table is used to lookup a flow entry given values in a packet received via a network interface. The other hash table is used to lookup a flow entry given values in a packet received via the switch fabric. Both hash table index values will most likely be based on the source and destination IP addresses and TCP/UDP port numbers.</div>
<div class="description-paragraph" id="p-0536" num="0538">In accordance with the invention, if the packet of the new flow is received on a Router port, then the newly created forwarding entry needs to be sent to the NPs of all other Router ports. The NP connected to the flow destination (most likely a Server port; could it be a Router port?) will rewrite the flow entry from the perspective of packets received on that port that will be sent to the source of the flow: Attribute Value Source IP address original NAT IP address Destination IP address original source IP address Source TCP/UDP port original NAT TCP/UDP port</div>
<div class="description-paragraph" id="p-0537" num="0539">Destination TCP/UDP port original source TCP/UDP port Source physical port original destination physical port Source next-hop MAC address original destination MAC address Destination physical port original source physical port Destination next-hop MAC address original source MAC address NAT IP address original destination IP address NAT TCP/UDP port original destination TCP/UDP port Flags Can be determined 5.2. 2 Virtual Domain IP Addresses: Virtual domain IP addresses are those that identify the domain (such as www. fred. com) and are visible to the Internet. The“next hop” of these IP addresses is the load balancing function. In one practice of the invention, addition of these IP addresses is performed by the management software when the configuration is read.</div>
<div class="description-paragraph" id="p-0538" num="0540">Attribute Value IP address the virtual IP address TCP/UDP port zero if the servers in the virtual domain accept all TCP/UDP port numbers; otherwise, a separate forwarding entry will exist with each TCP/UDP port number that is supported Destination IP address zero Destination TCP/UDP port zero Physical port n/a Next-hop MAC address n/a Server IP address n/a Server TCP/UDP port n/a Server physical port n/a Flags an indicator that packets destined to this IP address and TCP/UDP port are to be load-balanced 5.2. 3 Server IP Addresses: Server IP addresses are added to the forwarding table by the management software when the configuration is read.</div>
<div class="description-paragraph" id="p-0539" num="0541">The forwarding function will periodically issue ARP requests for the IP address of each physical server. It is beyond the scope of the IFF function as to exactly how the physical servers are known, be it manual configuration or dynamic learning. In any case, since the administrator shouldn't have to specify the port that connects to the physical servers, this will require that the Pirus box determine it. ARP requests will need to be sent out every port connected to an SNP until an ARP response is received from a server on a port. Once a server's IP address has been resolved, periodic ARP requests to ensure the server is still alive can be sent out the learned port. A forwarding entry will be created once an ARP response is received. A forwarding entry will be removed (or marked invalid) once an entry times out.</div>
<div class="description-paragraph" id="p-0540" num="0542">If the ARP information for the server times out, subsequent ARP requests will again need to be sent out all SNP ports. An exponential backoff time can be used so that servers that are turned off will not result in significant bandwidth usage.</div>
<div class="description-paragraph" id="p-0541" num="0543">For servers connected to the Pirus box via a router, ARP requests will be issued for the IP address of the router interface.</div>
<div class="description-paragraph" id="p-0542" num="0544">Attribute Value IP address the server's IP address TCP/UDP port TBD Destination IP address zero Destination TCP/UDP port zero Physical port n/a Server IP address n/a Server TCP/UDP port n/a Server physical port n/a Flags TBD 5.3 Distributing the Forwarding Table: In one practice of the invention, as physical servers are located, their IP address/port combinations will be distributed to all RNPs. Likewise, as upstream routers are located, their IP address/MAC address/port combinations will be distributed to all SNPs.</div>
<div class="description-paragraph" id="p-0543" num="0545">5.4 Ingress Function:</div>
<div class="description-paragraph" id="p-0544" num="0546">It is assumed that the Ethernet frame passes the CRC check before the packet reaches the forwarding function and that frames that don't pass the CRC check are discarded. As it is anticipated that the RNP will be heavily loaded, the IP and TCP/UDP checksum validation can be performed by the SNP. Although it is probably not useful to perform the forwarding function if the packet is corrupted because the data used by those functions may be invalid, the process should still work.</div>
<div class="description-paragraph" id="p-0545" num="0547">After the load balancing function has determined a physical server that should receive the packet, the forwarding function performs a lookup on the IP address of the server. If an entry is found, this forwarding table entry contains the port number that is connected to the server, and the packet is forwarded to that port. If no entry is found, the packet is discarded. The load balancing function should never choose a physical server whose location is unknown to the Pirus box.</div>
<div class="description-paragraph" id="p-0546" num="0548">On packets received a packet from a server, the forwarding function performs a lookup on the IP address of the upstream router. If an entry is found, the packet is forwarded to the port contained in the forwarding entry.</div>
<div class="description-paragraph" id="p-0547" num="0549">The ingress function in the RNP calls the load balancing function and is returned the following (any value of zero implies that the old value should be used) 1. new destination IP address 2. new destination port The RNP will optionally perform Network Address Translation, or NAT, on the packets that arrive from the upstream router. This is because the packets from the client have a destination IP address of the domain (i.e., www. fred. com). The new destination IP address of the packet is that of the actual server that was chosen by the load balancing function. In addition, a new destination port may be chosen if TCP/UDP port multiplexing is in use.</div>
<div class="description-paragraph" id="p-0548" num="0550">Port multiplexing may be used on the physical servers in order to conserve IP addresses. A single server may serve multiple domains, each with a different TCP/UDP port number.</div>
<div class="description-paragraph" id="p-0549" num="0551">The SNP will optionally perform NAT on the packets that arrive from a server. This is because there may be a desire to hide the details of the physical servers that provide the load balancing function and have it appear as if the domain IP address is the“server”. The new source of the packet is that of the domain. As the domain may have multiple IP addresses, the Pirus box needs a client table that maps the client's IP address and TCP/UDP port to the domain IP address and port to which the client sent the original packet.</div>
<div class="description-paragraph" id="p-0550" num="0552">6. Egress Function:</div>
<div class="description-paragraph" id="p-0551" num="0553">Packets received from an upstream router will be forwarded to a server.</div>
<div class="description-paragraph" id="p-0552" num="0554">The forwarding function sends the packet to the SNP providing support for the server. This SNP performs the egress function to do the following: 1. verify the IP checksum 2. verify the TCP or UDP checksum 3: change the destination port to that of the server (as determined by the load balancing function call in the ingress function) 4. change the destination IP address to that of the server (as determined by the load balancing function call in the ingress function) 5. recalculate the TCP or UDP checksum if the destination port or destination IP address was changed 6. recalculate the IP header checksum if the destination IP address was changed 7. sets the destination MAC address to that of the server or next-hop to the server (as determined by the forwarding function) 8. recalculate the Ethernet packet CRC if the destination port or destination IP address was changed Packets received from a server will be forwarded to an upstream router.</div>
<div class="description-paragraph" id="p-0553" num="0555">The SNP performs the egress function to do the following:</div>
<div class="description-paragraph" id="p-0554" num="0556">1. verify the IP checksum</div>
<div class="description-paragraph" id="p-0555" num="0557">2. verify the TCP or UDP checksum</div>
<div class="description-paragraph" id="p-0556" num="0558">3. change the source port to the one that the client sent the request to (as determined by the ingress function client table lookup) 4. change the source IP address to the one that the client sent the request to (as determined by the ingress function client table lookup) 5. recalculate the TCP or UDP checksum if the source port or source IP address was changed 6. recalculate the IP header checksum if the destination IP address was changed 7. sets the destination MAC address to that of the upstream router 8. recalculate the Ethernet packet CRC if the source port or source IP address was changed V. IP-Based Storage Management-Device Discovery &amp; Monitoring In data networks based on IP/Ethernet technology a set of standards has developed that permit users to manage/operate their networks using a heterogeneous collection of hardware and software. These standards include Ethernet, Internet Protocol (IP), Internet Control Message Protocol (ICMP), Management Information Block (MIB) and Simple Network Management Protocol (SNMP). Network Management Systems (NMS) such as HP Open View utilize these standards to discover and monitor network devices. Storage Area Networks (SANs) use a completely different set of technology based on Fibre Channel (FC) to build and manage “Storage Networks”. This has led to a “re-inventing of the wheel” in many cases. Also, SAN devices do not integrate well with existing IP-based management systems.</div>
<div class="description-paragraph" id="p-0557" num="0559">Lastly, the storage devices (Disks, Raid Arrays, etc), which are Fibre Channel attached to the SAN devices, do not support IP (and the SAN devices have limited IP support) and the storage devices cannot be discovered/managed by IP-based management systems. There are essentially two sets of management products-one for the IP devices and one for the storage devices.</div>
<div class="description-paragraph" id="p-0558" num="0560">A trend is developing where storage networks and IP networks are converging to a single network based on IP. However, conventional IP-based management systems can not discover FC attached storage devices.</div>
<div class="description-paragraph" id="p-0559" num="0561">The following discussion explains a solution to this problem, in two parts. The first aspect is device discovery, the second is device monitoring.</div>
<div class="description-paragraph" id="p-0560" num="0562">Device Discovery <figref idrefs="DRAWINGS">FIG. 32</figref> illustrates device discovery in accordance with the invention.</div>
<div class="description-paragraph" id="p-0561" num="0563">In the illustrated configuration the NMS cannot discover (“see”) the disks attached to the FC Switch but it can discovery (“see”) the disks attached to the Pirus System. This is because the Pirus System does the following: Assigns an IP address to each disk attached to it.</div>
<div class="description-paragraph" id="p-0562" num="0564">Creates an Address Resolution Protocol (ARP) table entry for each disk.</div>
<div class="description-paragraph" id="p-0563" num="0565">This is a simple table that contains a mapping between IP and physical addresses.</div>
<div class="description-paragraph" id="p-0564" num="0566">When the NMS uses SNMP to query the Pirus System, the Pirus System will return an ARP entry for each disk attached to it.</div>
<div class="description-paragraph" id="p-0565" num="0567">‘The NMS will then“ping” (send ICMP echo request) for each ARP entry it receives from the Pirus System.</div>
<div class="description-paragraph" id="p-0566" num="0568">‘The Pirus System will intercept the ICMP echo requests destined for the disks and translate the ICMP echo into a SCSI Read Block 0 request and send it to the disk.</div>
<div class="description-paragraph" id="p-0567" num="0569">If the SCSI Read Block 0 request successfully completes then the Pirus System acknowledges the“ping” by sending back an ICMP echo reply to the NMS.</div>
<div class="description-paragraph" id="p-0568" num="0570">If the SCSI Read Block 0 request fails then the Pirus System will not respond to the “ping” request.</div>
<div class="description-paragraph" id="p-0569" num="0571">The end result of these actions is that the NMS will learn about the existence of each disk attached to the Pirus System and verify that it can reach it. The NMS has now discovered the device.</div>
<div class="description-paragraph" id="p-0570" num="0572">Device Monitoring Once the device (disk) has been discovered by the NMS it will start sending it SNMP requests to learn what the device can do (i.e., determine its level of functionality.) The Pirus System will intercept these SNMP requests and generate a SCSI request to the device. The response to the SCSI request will be converted back into an SNMP reply and returned to the NMS. <figref idrefs="DRAWINGS">FIG. 33</figref> illustrates this.</div>
<div class="description-paragraph" id="p-0571" num="0573">The configuration illustrated in <figref idrefs="DRAWINGS">FIG. 33</figref> is essentially an SNMP &lt;-&gt;SCSI converter/translator.</div>
<div class="description-paragraph" id="p-0572" num="0574">Lastly, NMS can receive asynchronous events (traps) from devices.</div>
<div class="description-paragraph" id="p-0573" num="0575">These are notifications of events that may or may not need attention. The Pirus System will also translate SCSI exceptions into SNMP traps, which are then propagated to the NMS. <figref idrefs="DRAWINGS">FIG. 34</figref> illustrates this.</div>
<div class="description-paragraph" id="h-0011" num="0000">VI. Data Structure Layout</div>
<div class="description-paragraph" id="p-0574" num="0576">Data Structure Layout:</div>
<div class="description-paragraph" id="p-0575" num="0577"> <figref idrefs="DRAWINGS">FIG. 35</figref> shows the relationships between the various configuration data structures. Each data structure is described in detail following the diagram. The data structures are not linked; however, the interconnecting lines in the diagram display references from one data structure to another. These references are via instance number.</div>
<div class="description-paragraph" id="p-0576" num="0578">Data Structure Descriptions:</div>
<div class="description-paragraph" id="p-0577" num="0579">1. VSD CFG T: This data structure describes a Virtual Storage Domain. Typically there is a single VSD for each end user customer of the box. A VSD has references to VLANS that provide information on ports allowed access to the VSD. VSE structures provide information for the storage available to a VSD and SERVER CFG T structures provide information on CPUs available to a VSD. A given VSD may have multiple VSE and SERVER structures.</div>
<div class="description-paragraph" id="p-0578" num="0580">2. VSE_CFG_T: This data structure describes a Virtual Storage Endpoint. VSEs can be used to represent Virtual Servers (NAS) or IP-accessible storage (ISCSI, SCSI over UDP, etc.). They are always associated with one, and only one, VSD.</div>
<div class="description-paragraph" id="p-0579" num="0581">3. VlanConfig: This data structure is used to associate a VLAN with a VSD. It is not used to create a VLAN.</div>
<div class="description-paragraph" id="p-0580" num="0582">4. SERVER_CFG_T: This data structure provides information regarding a single CPU. It is used to attach CPUs to VSEs and VSDs. For replicated NFS servers there can be more than one of these data structures associated with a given VSE.</div>
<div class="description-paragraph" id="p-0581" num="0583">5. MED_TARG_CFGT: This data structure represents the endpoint for Mediation Target configuration: a device on the FibreChannel connected to the Pirus box being accessed via some form of SCSI over IP.</div>
<div class="description-paragraph" id="p-0582" num="0584">6. LUN_MAP_CFG_T: This data structure is used for mapping Mediation Initiator access. It maps a LUN on the specified Pirus FC port to an IP/LUN pair on a remote ISCSI target.</div>
<div class="description-paragraph" id="p-0583" num="0585">7. FILESYS_CFG_T: This data structure is used to represent a file system on an individual server. There may be more than one of these associated witha given server. If this file system will be part of a replicated NFS file system, the filesystem_id and the mount point will be the same for each of the file systems in the replica set.</div>
<div class="description-paragraph" id="p-0584" num="0586">8. SHARE_CFG_T: This data structure is used to provide information regarding how a particular file system is being shared. The information in this data structure is used to populate the sharetab file on the individual server CPUs.</div>
<heading id="h-0012">EXAMPLES</heading>
<div class="description-paragraph" id="p-0585" num="0587">Server Health:</div>
<div class="description-paragraph" id="p-0586" num="0588">1) Listen forVSD_CFG_T. When get one, create local VSD structure</div>
<div class="description-paragraph" id="p-0587" num="0589">2) Listen for VSE_CFG_T. When get one, wire to local VSD.</div>
<div class="description-paragraph" id="p-0588" num="0590">3) Listen for SERVER_CFG_T. When get one, wire to local VSE.</div>
<div class="description-paragraph" id="p-0589" num="0591">4) Start Server Health for server.</div>
<div class="description-paragraph" id="p-0590" num="0592">5) Listen for FILESYS_CFG_T. When get one, wire to local SERVERNSE.</div>
<div class="description-paragraph" id="p-0591" num="0593">6) Start Server Health read/write to file system.</div>
<div class="description-paragraph" id="p-0592" num="0594">7) Listen for MED SE CFG T. When get one, wire to local VSE.</div>
<div class="description-paragraph" id="p-0593" num="0595">8) Start Server Healthpingson IP specified in VSE referenced by MED_SE_CFG_T.</div>
<div class="description-paragraph" id="p-0594" num="0596">Mediation Target:</div>
<div class="description-paragraph" id="p-0595" num="0597">1) Listen for VSE_CFG_T. When get one with type of MED, create local VSE structure.</div>
<div class="description-paragraph" id="p-0596" num="0598">2) Listen for MED_SE_CFG_T. When get one, wire to local VSE.</div>
<div class="description-paragraph" id="p-0597" num="0599">3) Setup mediation mapping based on information provided in VSE/MED_SE pair.</div>
<div class="description-paragraph" id="p-0598" num="0600">Mediation Initiator:</div>
<div class="description-paragraph" id="p-0599" num="0601">1) Listen for LUN_MAP_CFG_T. When get one, request associated SERVER_CFG_T from MIC.</div>
<div class="description-paragraph" id="p-0600" num="0602">2) Create local SERVER structure.</div>
<div class="description-paragraph" id="p-0601" num="0603">3) Add information from LUN_MAP_CFG_T to LUN map for that server.</div>
<div class="description-paragraph" id="p-0602" num="0604">NCM:</div>
<div class="description-paragraph" id="p-0603" num="0605">1) Listen for SHARE_CFG_T with a type of NFS.</div>
<div class="description-paragraph" id="p-0604" num="0606">2) Request associated FILESYS_CFG_T from MIC.</div>
<div class="description-paragraph" id="p-0605" num="0607">3) If existing filesystemJd, add to set. If new˜create new replica set.</div>
<div class="description-paragraph" id="p-0606" num="0608">4) Bring new file system up to date. When finished, send FILESYS_CFG_T with state of “ONLINE”.</div>
<div class="description-paragraph" id="p-0607" num="0609">The above features of the Pirus System allow storage devices attached to a Pirus System be discovered and managed by an IP-based NMS. This lets users apply standards based; widely deployed systems that manage IP data networks manage storage devices-something currently not possible.</div>
<div class="description-paragraph" id="p-0608" num="0610">Accordingly, the Pirus System permits for the integration of storage (non-IP devices) devices (e.g., disks) into IP-based management systems (e.g., NMS), and thus provides unique features and functionality.</div>
<div class="description-paragraph" id="p-0609" num="0611">VIl. NAS Mirroring and Content Distribution</div>
<div class="description-paragraph" id="p-0610" num="0612">The following section describes techniques and subsystems for providing mirrored storage content to external NAS clients in accordance with the invention. The Pirus SRC NAS subsystem described herein provides dynamically distributed, mirrored storage content to external NAS clients, as illustrated in <figref idrefs="DRAWINGS">FIG. 36</figref>. These features provide storage performance scalability and increased availability to users of the Pirus system. The following describes the design of the SRC NAS content distribution subsystem as it pertains to NAS servers and NAS management processes. Load Balancing operations are described elsewhere in this document.</div>
<div class="description-paragraph" id="p-0611" num="0613">1. Content Distribution and Mirroring</div>
<div class="description-paragraph" id="p-0612" num="0614">1.1 Mirror Initialization via NAS</div>
<div class="description-paragraph" id="p-0613" num="0615">After volume and filesystem initialization-a complete copy of a filesystem can be established using the normal NAS facilities (create and write) and the maintenance procedures described hereinafter. A current filesystem server set is in effect immediately after filesystem creation using this method.</div>
<div class="description-paragraph" id="p-0614" num="0616">1.2 Mirror Initialization via NDMP</div>
<div class="description-paragraph" id="p-0615" num="0617">A complete filesystem copy can also be initialized via NDMP. Since NDMP is a TCP based protocol and TCP based load balancing is not initially supported, the 2nd and subsequent members of a NAS peer set must be explicitly initialized. This can be done with additional NDMP operations. It can also be accomplished by the filesystem synchronization facilities described herein. Once initialization is complete a current filesystem server set is in effect.</div>
<div class="description-paragraph" id="p-0616" num="0618">1.3 Sparse Content Distribution</div>
<div class="description-paragraph" id="p-0617" num="0619">Partial filesystem content replication can also be supported. Sparse copies of a filesystem will be dynamically maintained in response to IFF and MIC requests. The details of MIC and DO interaction can be left to implementers, but the concept of sparse filesystems and their maintenance is discussed herein.</div>
<div class="description-paragraph" id="p-0618" num="0620">2. NCM</div>
<div class="description-paragraph" id="p-0619" num="0621">The NCM (NAS Coherency Manager) is used to maintain file handle synchronization, manage content distribution, and coordinate filesystem (re) construction. The NCM runs primarily on an SRC's 9th processor with agents executing on LIC IXPs and SRC 750's within the chassis. Inter-chassis NAS replication is beyond the scope of this document.</div>
<div class="description-paragraph" id="p-0620" num="0622">2.1 NCM Objectives</div>
<div class="description-paragraph" id="p-0621" num="0623">One of the primary goals of the NCM is to minimize the impact of mirrored content service delivery upon individual NAS servers. NAS servers within the Pirus chassis will operate as independent peers while the NCM manages synchronization issues“behind the scenes.” The NCM will be aware of all members in a Configured Filesystem Server Set. Individual NAS servers do not have this responsibility.</div>
<div class="description-paragraph" id="p-0622" num="0624">The NCM will resynchronize NAS servers that have fallen out of sync with the Configured Filesystem Server Set, whether due to transient failure, hard failure, or new extension of an existing group.</div>
<div class="description-paragraph" id="p-0623" num="0625">The NCM will be responsible for executing content re-distribution requests made by IFF load balancers when sparse filesystem copies are supported. The NCM will provide Allocated Inode and Content Inode lists to IFF load balancers.</div>
<div class="description-paragraph" id="p-0624" num="0626">The NCM will be responsible for executing content re-distribution requests made by the MIC when sparse filesystem copies are supported. Note that rules should exist for run-time contradictions between IXP and MIC balancing requests.</div>
<div class="description-paragraph" id="p-0625" num="0627">The NCM will declare NAS server“life” to interested parties in the chassis and accept“death notices” from server health related services.</div>
<div class="description-paragraph" id="p-0626" num="0628">2.2 NCM Architecture</div>
<div class="description-paragraph" id="p-0627" num="0629">2.3 NCM Processes and Locations</div>
<div class="description-paragraph" id="p-0628" num="0630">The NCM has components executing at several places in the Pirus chassis.</div>
<div class="description-paragraph" id="p-0629" num="0631">The primary NCM service executes on an SRC 9th processor.</div>
<div class="description-paragraph" id="p-0630" num="0632">An NCM agent runs on each SRC 750 CPU that is loaded for NAS. o An NCM agent runs on each IXP that is participating in a VSD.</div>
<div class="description-paragraph" id="p-0631" num="0633">A Backup NCM process will run on a 2nd SRC's 9th processor. If the primary NCM becomes unavailable for any reason the secondary NCM will assume its role.</div>
<div class="description-paragraph" id="p-0632" num="0634">2.4 NCM and IPC Services</div>
<div class="description-paragraph" id="p-0633" num="0635">The NCM will use the Pirus IPC subsystem to communicate with IFF and NAS server processors.</div>
<div class="description-paragraph" id="p-0634" num="0636">The NCM will receive any and all server health declarations, as well as any IFF initiated server death announcement. The NCM will announce server life to all interested parties via IPC.</div>
<div class="description-paragraph" id="p-0635" num="0637">Multiast IPC messages should be used by NCM agents when communicating with the NCM service. This allows the secondary NCM to remain synchronized and results in less disruptive failover transitions.</div>
<div class="description-paragraph" id="p-0636" num="0638">After chassis initialization the MIC configuration system will inform the NCM of all Configured Filesystem Server Sets via IPC. Any user configured changes to Filesystem Server Sets will be relayed to the NCM via IPC.</div>
<div class="description-paragraph" id="p-0637" num="0639">NCM will make requests of NCM agents via IPC and accept their requests as well.</div>
<div class="description-paragraph" id="p-0638" num="0640">2.5 NCM and node Management</div>
<div class="description-paragraph" id="p-0639" num="0641">All file handles (inodes) in a Current Filesystem Server Set should have identical interpretation.</div>
<div class="description-paragraph" id="p-0640" num="0642">The NC will query each member of a Configured Filesystem Server Set for InodeList-Allocated and InodeList-Content after initialization and after synchronization. The NCM may periodically repeat this request for verification purposes.</div>
<div class="description-paragraph" id="p-0641" num="0643">Each NAS server is responsible for maintaining these 2 file handle usage maps on a per filesystem basis. One map represents all allocated inodes on a server-IN-Alloc. The 2nd usage map represents all inodes with actual content present on the server-IN-Content. On servers where full n-way mirroring is enabled the 2 maps will be identical. On servers using content sensitive mirroring the 2nd“content” map will be a subset of the first. Usage maps will have a global filesystem checkpoint value associated with them.</div>
<div class="description-paragraph" id="p-0642" num="0644">2.6 Inode Allocation Synchronization</div>
<div class="description-paragraph" id="p-0643" num="0645">All peer NAS servers must maintain identical file system and file handle allocations.</div>
<div class="description-paragraph" id="p-0644" num="0646">All inode creation and destruction operations must be multicast from IXP/IFF source to an entire active filesystem server set. These multicast packets must also contain a sequence number that uniquely identifies the transaction on a per IXP basis.</div>
<div class="description-paragraph" id="p-0645" num="0647">Inode creation and destruction will be serialized within individual NAS servers.</div>
<div class="description-paragraph" id="p-0646" num="0648">2.7 Inode Inconsistency Identification</div>
<div class="description-paragraph" id="p-0647" num="0649">When an inode is allocated, deallocated or modified, the multicasting IXP must track the outstanding request, report inconsistency or timeout as a NAS server failure to the NCM.</div>
<div class="description-paragraph" id="p-0648" num="0650">When all members of a current filesystem server set timeout on a single request the IXP must consider that the failure is one of the following events: D) XP switch fabric multicast transmission error Bogus client request 0 Simultaneous current filesystem server set fatality The 3rd item is least likely and should only be assumed when the first 2 bullets can be ruled out.</div>
<div class="description-paragraph" id="p-0649" num="0651">NAS servers must track the incoming multicast sequence number provided by the IXP in order to detect erroneous transactions as soon as possible. If a NAS server detects a missing our out of order multicast sequence number it must negotiate its own death with NCM. If all members of a current filesystem server set detect the same missing sequence number then the negotiation fails and the current filesystem server set should remain active.</div>
<div class="description-paragraph" id="p-0650" num="0652">When an inconsistency is identified the offending NAS server will be reset and rebooted. The NCM is responsible for initiating this process. It may be possible to gather some “pre-mortem” information and possibly even undo final erroneous inode allocations prior to rebooting.</div>
<div class="description-paragraph" id="p-0651" num="0653">3. Filesystem Server Sets</div>
<div class="description-paragraph" id="p-0652" num="0654">3.1 Types</div>
<div class="description-paragraph" id="p-0653" num="0655">For a given filesystem, there are 3 filesystem server sets that pertain to it; configured, current and joining.</div>
<div class="description-paragraph" id="p-0654" num="0656">As described in the definition section, the configured filesystem server set is what the user specified as being the cpus that he wants to serve a copy of the particular filesystem. To make a filesystem ready for service a current filesystem server set must be created. As servers present themselves and their copy of the filesystem to the NCM and are determined to be part of the configured server set, the NCM must reconcile their checkpoint value for the filesystem with either the current set's checkpoint value or the checkpoint value of joining servers in the case where a current filesystem server set does not yet exist.</div>
<div class="description-paragraph" id="p-0655" num="0657">A current filesystem server set is a dynamic grouping of servers that is identified by a filesystem id and a checkpoint checkpoint value. The current filesystem server set for a filesystem is created and maintained by the NCM.</div>
<div class="description-paragraph" id="p-0656" num="0658">The joining server set is simply the set of NAS servers that are attempting to be part of the current server set.</div>
<div class="description-paragraph" id="p-0657" num="0659">3.2 States of the Current Server Set</div>
<div class="description-paragraph" id="p-0658" num="0660">A current filesystem server set can be active, inactive, or paused. When it is active, NFS requests associated with the filesystem id are being forwarded from the IXPs to the members of the set. When the set is inactive the IXPs are dropping NFS requests to the server set. When the set is paused, the IXPs are queuing NFS requests destined for the set.</div>
<div class="description-paragraph" id="p-0659" num="0661">When a current filesystem server set becomes active and is serving clients and a new server wishes to join the set, we must at least pause the set to prevent updates to the copies of the filesystem during the join operation.</div>
<div class="description-paragraph" id="p-0660" num="0662">The benefit of a successful pause and continue versus deactivate and activate is that NFS clients may not need to retransmit requests that were sent while the new server was joining. There clearly are limits to how many NFS client requests you can queue before you are forced to drop. Functionally both work.</div>
<div class="description-paragraph" id="p-0661" num="0663">A first pass could leave out the pause and continue operations until later.</div>
<div class="description-paragraph" id="p-0662" num="0664">4. Description of Operations on a Current Filesystem Server Set</div>
<div class="description-paragraph" id="p-0663" num="0665">During the lifetime of a current filesystem set, for recovery purposes several items of information must be kept somewhere where an NCM can find them after a fault 4.1 Create_Current_Filesystem_Server_Set (fsid, slots/cpus) Given a set of cpus that are up, configured to serve the filesystem, and wishing to join, the NCM must decide which server has the latest copy of the filesystem, and then synchronize the other joining members with that copy.</div>
<div class="description-paragraph" id="p-0664" num="0666">4.2 Add_Member_To_Current Filesystem_Server_Set (fsid, slot/CPU)</div>
<div class="description-paragraph" id="p-0665" num="0667">Given a cpu that wishes to join, the NCM must synchronize that cpu's copy of the filesystem with the copy being used by the current filesystem server set.</div>
<div class="description-paragraph" id="p-0666" num="0668">Chckpoint_Current_Filesystem_Server_Set (fsid) Since a filesystem's state is represented by its checkpoint value and modified node-Lists, the time to recover from a filesystem with the same checkpoint value is a function of the modifications represented by the modified InodeList, it is desirable to checkpoint the filesystem regularly. The NCM will coordinate this. A new checkpoint value will then be associated with the copies served by the current filesystem server set and the modified InodeList on each member of the set will be cleared.</div>
<div class="description-paragraph" id="p-0667" num="0669">Get Status Of Filesystem Server Set (fsid. &amp;status struct) Return the current state of the filesystem server set.</div>
<div class="description-paragraph" id="p-0668" num="0670">Struct server set status {Long configured set; Long current set; Long current set checkpoint value; Long joining set; Int active_flag; }; 5. Description of Operations that Change the State of the Current Server Set 5.1 Activate Server Set (fsid)</div>
<div class="description-paragraph" id="p-0669" num="0671">Allow NFS client requests for this fsid to reach the NFS servers on the members of the current filesystem server set.</div>
<div class="description-paragraph" id="p-0670" num="0672">5.2 Pause Filesystem Server Set (fsid) Queue</div>
<div class="description-paragraph" id="p-0671" num="0673">NFS client requests for this fsid headed for the NFS servers on the members of the current filesystem server set. Note any queue space is finite so pausing for too long can result in dropped messages. This operation waits until all pending NFS modification ops to this fsid have completed.</div>
<div class="description-paragraph" id="p-0672" num="0674">5.3 Continue Filesystem Server Set (fsid) Queued</div>
<div class="description-paragraph" id="p-0673" num="0675">NFS client requests for this fsid are allow to proceed to the NFS servers on members of the current filesystem server set.</div>
<div class="description-paragraph" id="p-0674" num="0676">5.4 DeactivateServerSet (fsid)</div>
<div class="description-paragraph" id="p-0675" num="0677">Newly arriving NFS requests for this fsid are now dropped. This operation waits until all pending NFS modification ops to this fsid have completed.</div>
<div class="description-paragraph" id="p-0676" num="0678">6. Recovery Operations on a Filesystem Copy</div>
<div class="description-paragraph" id="p-0677" num="0679">There are two cases of Filesystem Copy:</div>
<div class="description-paragraph" id="p-0678" num="0680">6.1 Construction: refers to the Initialization of a “filesystem copy”, which will typically entail copying every block from the Source to the Target.</div>
<div class="description-paragraph" id="p-0679" num="0681">Construction occurs when the Filesystem Synchronization Number does not match between two filesystem copies.</div>
<div class="description-paragraph" id="p-0680" num="0682">6.2 Restoration: refers to the recovery of a “filesystem copy”.</div>
<div class="description-paragraph" id="p-0681" num="0683">Restoration occurs when the Filesystem Synchronization Number matches between two filesystem copies.</div>
<div class="description-paragraph" id="p-0682" num="0684">Conceptually, the two cases are very similar to one another. There are three phases of each Copy:</div>
<div class="description-paragraph" id="p-0683" num="0685">I. First-pass: copy-method everything that has changed since the last Synchronization. For the Construction case, this really is EVERY thing; for the Restoration case, this is only the inodes in the IN-Mod list.</div>
<div class="description-paragraph" id="p-0684" num="0686">II. Copy-method the IN-Copy list changes, i.e. modifications which occurred while the first phase was being done. Repeat until the IN-Copy list is (mostly) empty; even if it is not empty, it is possible to proceed to synchronization at the cost of a longer synchronization time.</div>
<div class="description-paragraph" id="p-0685" num="0687">III. Synchronization by NCM: update of Synchronization Number, clearing of the IN-Mod list. Note that by pausing ongoing operations at each NAS (and IXP if a new NAS is being brought into the peer group), it is possible to achieve synchronization on-line (i.e. during active NFS modify operations).</div>
<div class="description-paragraph" id="p-0686" num="0688">The copy-method refers to the actual method of copying used in either the Construction or Restoration cases. It is proposed here that the copy-method will actually hide the differences between the two cases.</div>
<div class="description-paragraph" id="p-0687" num="0689">6.3 NAS-FS-Copy</div>
<div class="description-paragraph" id="p-0688" num="0690">An NAS-FS copy inherently utilizes the concept of “inodes” to perform the Copy. This is built-into both the IN-Mod and IN-Copy lists maintained on each NAS.</div>
<div class="description-paragraph" id="p-0689" num="0691">6.3.1 Construction of Complete Copy</div>
<div class="description-paragraph" id="p-0690" num="0692">Use basic volume block-level mirroring to make “first pass” copy of entire volume, from Source to Target NAS. This is an optimization to take advantage of sequential 1/0 performance; however, this will impact the copy-method. The copy-method will be an ‘image’ copy, i.e. it is a volume block-by-block copy; conceptually, the result of the Construction will be a mirror-volume copy. (Actually, the selection of volume block-level copying can be determined by the amount of “used” filesystem space; i.e. if the filesystem were mostly empty, it would be better to use an inode logical copy as in the Restoration case.)</div>
<div class="description-paragraph" id="p-0691" num="0693">For this to work correctly, since a physical-copy is being done, the completion of the Copy (i.e. utilizing the IN-Copy) must also be done at the physical-copy level; stated another way, the“inode” copy-method must be done at the physical-copy level to complete the Copy.</div>
<div class="description-paragraph" id="p-0692" num="0694">6.4 Copy-method</div>
<div class="description-paragraph" id="p-0693" num="0695">The inode copy-method must exactly preserve the inode: this is not just the inode itself, but also includes the block mappings. For example, copying the <b>128</b> <i>b </i>of the inode will only capture the Direct, 2nd-level, and 3rd-level indirect blocks; it will not capture the data in the Direct, nor the levels of indirection embedded in both the 2nd/3rd indirect blocks. In effect, the indirect blocks of an inode (if they exist) must be traversed and copied exactly; another way to state this, the list of all block numbers allocated to an inode must be copied.</div>
<div class="description-paragraph" id="p-0694" num="0696">6.5 Special inodes:</div>
<div class="description-paragraph" id="p-0695" num="0697">Special inodes will be instantiated in both IN-Mod and IN-Copy which reflect changes to filesystem metadata: specifically block-allocation and inode-allocation bitmaps (or alternatively for each UFS' cylinder-group), and superblocks. This is because all physical changes (i.e. this is a physical-image copy) must be captured in this copy-method.</div>
<div class="description-paragraph" id="p-0696" num="0698">6.6 Locking:</div>
<div class="description-paragraph" id="p-0697" num="0699">Generally, any missed or overlapping updates will be caught by repeating IN-Copy changes; any racing allocations and/or de-allocations will be reflected in both the inode (being extended or truncated), and the corresponding block-allocation bitmap (s). Note these special inodes are not used for Sparse Filesystem Copies.</div>
<div class="description-paragraph" id="p-0698" num="0700">However, while the block map is being traversed (i.e. 2nd/3rd indirect blocks), changes during the traversal must be prevented to prevent inconsistencies. Since the copy-method can be repeated, it would be best to utilize the concept of a soft-lock which would allow an ongoing copy-method to be aborted by the owning/Source-NAS if there was a racing extension/truncation of the file.</div>
<div class="description-paragraph" id="p-0699" num="0701">6.7 Restoration of Complete Copy</div>
<div class="description-paragraph" id="p-0700" num="0702">This step assumes that two NAS' differ only in the IN-Mod list; to complete re-Synchronization, it requires that all changed inodes be propagated from the Source NAS to the Target NAS (since the last synchronization-point).</div>
<div class="description-paragraph" id="p-0701" num="0703">6.8 Copy-method</div>
<div class="description-paragraph" id="p-0702" num="0704">The node copy-method occurs at the logical level: specifically the copying is performed by performing logical reads of the inode, and no information is needed of the actual block mappings (other than to maintain sparse-inodes). Recall the Construction case required a physical-block copy of the inode block-maps (i.e. block-map tree traversal), creating a physical-block mirror-copy of the inode 6.9 Special lnodes No special inodes are needed; because per-filesystem metadata is not propagated for a logical copy.</div>
<div class="description-paragraph" id="p-0703" num="0705">6.10 Locking</div>
<div class="description-paragraph" id="p-0704" num="0706">Similarily (to the construction case), a soft-lock around an inode is all that is needed.</div>
<div class="description-paragraph" id="p-0705" num="0707">6.11 Data structures</div>
<div class="description-paragraph" id="p-0706" num="0708">There are two primary Lists: the IN-Mod and the IN-Copy list. The IN-Copy is logically nested within the IN-Copy.</div>
<div class="description-paragraph" id="p-0707" num="0709">6.11. 1 Modified-lnodes-list (IN-Mod)</div>
<div class="description-paragraph" id="p-0708" num="0710">The IN-Mod is the list of all modified inodes since the last Filesystem Checkpoint: Worst-case, if an empty filesystem was restored from backup, the list would encompass every allocated inode.</div>
<div class="description-paragraph" id="p-0709" num="0711">D Best-case, an unmodified filesystem will have an empty-list; or a filesystem with a small working-set of inodes being modified will have a (very) small list.</div>
<div class="description-paragraph" id="p-0710" num="0712">The IN-Mod is used as a recovery tool, which allows the owning NAS to be used as the ‘source’ for a NAS-FS-Copy. It allows the NCM to determine which inodes have been modified since the last Filesystem Checkpoint.</div>
<div class="description-paragraph" id="p-0711" num="0713">The IN-Mod is implemented non-volatile, primarily for the case of chassis crashes (i.e. all NAS'crash), as one IN-Mod must exist to recover. Conceptually, the IN-Mod can be implemented as a Bitmap, or, as a List.</div>
<div class="description-paragraph" id="p-0712" num="0714">The IN-Mod tracks any modifications to any inode by a given NAS. This could track any change to the inode ‘object’ (i.e. both inode attributes, and, inode data), or, differentiate between the inode attributes and the data contents.</div>
<div class="description-paragraph" id="p-0713" num="0715">The IN-Mod must be updated (for a given inode) before it is committed to non-volatile storage (i.e. disk, or NVRAM); otherwise, there is a window where the system could crash and the change not be reflected in the IN-Mod. In a BSD implementation, the call to add a modified inode to the IN-Mod could be done in VOPUPDATE.</div>
<div class="description-paragraph" id="p-0714" num="0716">Finally, the Initialization case requires ‘special’ inodes to reflect non-inode disk changes, specifically filesystem metadata; e.g. cylinder-groups, superblocks. Since Initialization is proposing to use a block-level copy, all block-level changes need to be accounted for by the IN-Mod.</div>
<div class="description-paragraph" id="p-0715" num="0717">6.11.2 Copy-lnodes-list (IN-Copy)</div>
<div class="description-paragraph" id="p-0716" num="0718">The IN-Copy tracks any modifications to an inode by a given NAS, once a Copy is in-progress: it allows a Source-NAS to determine which inodes still need to be copied because it has changed during the Copy. In other words, it is an interim modified-list, which exists during a Copy. Once the Copying begins, all changes made to the IN-Mod are mirrored in the IN-Copy; this effectively captures all changes “since the Copy is in-progress”.</div>
<div class="description-paragraph" id="p-0717" num="0719">6.11.3 Copy progress:</div>
<div class="description-paragraph" id="p-0718" num="0720">The Source NAS needs to know which inodes to copy to the Target NAS. Conceptually, this is a snapshot ‘image’ of the IN-Mod before the IN-Copy is enabled, as this lists all the inodes which need to be copied at the beginning of the Copy (and, where the IN-Copy captures all changes rolling forward). In practice, the IN-Mod itself can be used, at the minor cost of repeating some of the Copy when the IN-Copy is processed.</div>
<div class="description-paragraph" id="p-0719" num="0721">Note the IN-Copy need not be implemented in NVRAM, since any NAS crashes (either Source or Target) can be restarted from the beginning. If an IN-Copy is instantiated, the calls to update IN-Copy can be hidden in the IN-Mod layer.</div>
<div class="description-paragraph" id="p-0720" num="0722">6.11.4 Copying Inodes:</div>
<div class="description-paragraph" id="p-0721" num="0723">An on-disk inode is 128 bytes (i.e. this is effectively the inode's attributes); the inode's data is variable length, and can vary between 0 and 4 GB, in filesystem fragment-size increments. On-disk inodes tend to be allocated in physically contiguous disk blocks, hence an optimization is copy a large number of inodes all at once. CrosStor-Note: all inodes are stored in a reserved-inode (file) itself.</div>
<div class="description-paragraph" id="p-0722" num="0724">6.11. 5 Construction case</div>
<div class="description-paragraph" id="p-0723" num="0725">In this case, locking is necessary to prevent racing changes to the inode (and or data contents), as the physical image of the inode (and data) needs to be preserved.</div>
<div class="description-paragraph" id="p-0724" num="0726">Specifically, the block mapping (direct and indirect blocks) need to be preserved exactly in the inode; so both the block-mapping and every corresponding block in the file have to be written to the same physical block together.</div>
<div class="description-paragraph" id="p-0725" num="0727">As an example, assume the race is where a given file is being first truncated, and then extended. Since each allocated-block needs to be copied exactly (i.e. same physical block number on the volume), care has to be taken that the copy does not involve a block in transition. Otherwise, locking on block allocations would have to occur on the source-NAS. Instead, locking on an inode would seem the better alternative here. An optimization would be to allow a source-NAS to ‘break’ a Copy-Lock, with the realization that an inode being Copied should defer to a waiting modification.</div>
<div class="description-paragraph" id="p-0726" num="0728">6.11. 6 Restoration case</div>
<div class="description-paragraph" id="p-0727" num="0729">In this case, no locking is implied during an inode-copy, since any “racing” modifications will be captured by the IN-Copy. A simple optimization might be to abort an in-progress Copy if such a ‘race’ is detected; e.g. imagine a very large file Copy which is being modified.</div>
<div class="description-paragraph" id="p-0728" num="0730">Specifically, the inode is copied, but not the block-mapping; the file data (represented by the block-mapping) is logically copied to the target NAS.</div>
<div class="description-paragraph" id="p-0729" num="0731">Examples-Set 1 1. Walkthroughs of Operations on a Current Filesystem Server Set Create Current Server Set (fsid, slots/cpus) Assumptions Assume that no NAS server is serving the filesystem; the current filesystem server set is empty.</div>
<div class="description-paragraph" id="p-0730" num="0732">El Steps 0 NAS A boots and tells the NCM it is up.</div>
<div class="description-paragraph" id="p-0731" num="0733">The NCM determines the new servers role in serving and that the filesystem is not being served by any NAS servers.</div>
<div class="description-paragraph" id="p-0732" num="0734">The NCM asks server A for the checkpoint value for the filesystem and also its modified InodeList.</div>
<div class="description-paragraph" id="p-0733" num="0735">The NCM insures that this is the most up to date copy of the filesystem.</div>
<div class="description-paragraph" id="p-0734" num="0736">(Reconciles static configuration info on filesystem with which servers are actually running, looks in NVRAM if needed . . . ) NCM activates the server set.</div>
<div class="description-paragraph" id="p-0735" num="0737">The filesystem is now being served.</div>
<div class="description-paragraph" id="p-0736" num="0738">Add_Member_to_Current_Filesystem_Server_Set (fsid) Assumptions Assume a complete copy of the filesystem is already being served.</div>
<div class="description-paragraph" id="p-0737" num="0739">The current filesystem server set contains NAS B.</div>
<div class="description-paragraph" id="p-0738" num="0740">The current filesystem server set is active.</div>
<div class="description-paragraph" id="p-0739" num="0741">NAS A is down.</div>
<div class="description-paragraph" id="p-0740" num="0742">NAS A boots and tells the NCM it is up. a Steps a The NCM determines the new servers role in serving the filesystem and determines the current server set for this filesystem contains only NAS B.</div>
<div class="description-paragraph" id="p-0741" num="0743">The NCM asks server A for the checkpoint value for the filesystem and also its modified InodeList.</div>
<div class="description-paragraph" id="p-0742" num="0744">NCM initiates recovery and asks NAS A to do it.</div>
<div class="description-paragraph" id="p-0743" num="0745">D NAS A finishes recovery and tells the NCM.</div>
<div class="description-paragraph" id="p-0744" num="0746">The NCM pauses the current filesystem server set.</div>
<div class="description-paragraph" id="p-0745" num="0747">NCM asks NAS A to do recovery to catch anything that might have changed since the last recovery request. This should only include NFS requests received since the last recovery.</div>
<div class="description-paragraph" id="p-0746" num="0748">NAS A completes the recovery.</div>
<div class="description-paragraph" id="p-0747" num="0749">The NCM asks all members of the set to update their filesystem checkpoint value. They all respond.</div>
<div class="description-paragraph" id="p-0748" num="0750">The NCM resumes the current filesystem server set.</div>
<div class="description-paragraph" id="p-0749" num="0751">A new filesystem checkpoint has been reached.</div>
<div class="description-paragraph" id="p-0750" num="0752">Checkpointing an Active Filesystem Server Set Assumptions a Steps NCM determines it is time to bring all the members of the current server set to a checkpoint.</div>
<div class="description-paragraph" id="p-0751" num="0753">NCM asks the NCM agent on one member of the server set to forward a multicast filesystem sync message to all members of the current server set. This message contains a new checkpoint value for the filesystem.</div>
<div class="description-paragraph" id="p-0752" num="0754">Upon receipt of this message the NAS server must finish processing any NFS requests received prior to the sync message that apply to the filesystem. New requests must be deferred.</div>
<div class="description-paragraph" id="p-0753" num="0755">The NAS server then writes the new checkpoint value to stable storage and clears any modified InodeLists for the filesystem and updates the NFS modification sequence number.</div>
<div class="description-paragraph" id="p-0754" num="0756">The NAS servers then sends a message to the NCM indicating that it has reach a new filesystem checkpoint.</div>
<div class="description-paragraph" id="p-0755" num="0757">The NCM waits for these messages from all NAS servers.</div>
<div class="description-paragraph" id="p-0756" num="0758">The NCM then sends multicast to the current server set telling them to start processing NFS requests.</div>
<div class="description-paragraph" id="p-0757" num="0759">The NCM then updates it's state to indicate a new filesystem checkpoint has been reached.</div>
<div class="description-paragraph" id="p-0758" num="0760">Examples-Set 2 2 UML Static Structure Diagram <figref idrefs="DRAWINGS">FIG. 37</figref> is a representation of the NCM, IXP and NAS server classes. For each, the top box is the name, the second box contains attributes of an instance of this class and the bottom box describes the methods each class must implement.</div>
<div class="description-paragraph" id="p-0759" num="0761">Attributes Description Data local to an instance of the class that make it unique.</div>
<div class="description-paragraph" id="p-0760" num="0762">Methods Description Those preceded with a + are public and usually invoked by receiving a message. The method is preceded by the name of the sender of the message surrounded by &lt;&lt; &gt;&gt;. Calling out the sender in the description should help you to correlate the messaging scenarios described in this document to implemented methods in the classes. Those preceded by a-are private methods that may be invoked during processing of public methods. They help to organize and reuse functions performed by the class.</div>
<div class="description-paragraph" id="p-0761" num="0763">VIII. System Mediation Manager</div>
<div class="description-paragraph" id="p-0762" num="0764">The following discussion sets forth the functional specification and design for the Mediation Manager subsystem of the Pirus box.</div>
<div class="description-paragraph" id="p-0763" num="0765">Mediation refers to storage protocol mediation, i.e., mediating between two transport protocols (e.g., FC and IP) that carry a storage protocol (SCSI).</div>
<div class="description-paragraph" id="p-0764" num="0766">The system disclosed herein will use the mediation configurations shown in <figref idrefs="DRAWINGS">FIGS. 38A</figref>, B, C. Thus, for example, in <figref idrefs="DRAWINGS">FIG. 38A</figref>, the Pirus box terminates a mediation session. In <figref idrefs="DRAWINGS">FIGS. 38B</figref> and C, Pirus Boxl originates a mediation session and Pirus box 2 terminates it. In <figref idrefs="DRAWINGS">FIG. 38C</figref>, Pirus Boxl runs backup software to copy its disks to the other Pirus box.</div>
<div class="description-paragraph" id="p-0765" num="0767">1. Components In accordance with one embodiment of the invention, mediation is handled by a Mediation Manager and one or more Mediation Protocol Engines. Their interaction between each other and other parts of the Pirus box is shown in <figref idrefs="DRAWINGS">FIG. 39</figref>.</div>
<div class="description-paragraph" id="p-0766" num="0768">2. Storage Hierarchy In accordance with known storage practice, at the lowest level of storage, there are physical disks, and each disk has one or more LUNs. In the system of the invention, as shown in the <figref idrefs="DRAWINGS">FIG. 40</figref>, the Volume manager configures the disks in a known manner (such as mirroring, RAID, or the like) and presents them to the SCSI server as volumes (e.g., Vol 1 thru Vol 5). The SCSI server assigns each volume to a Virtual LUN (VLO thru VL 2) in a Virtual Target (VTO through VT1).</div>
<div class="description-paragraph" id="p-0767" num="0769">The following behaviors are observed:
</div> <ul> <li id="ul0003-0001" num="0000"> <ul> <li id="ul0004-0001" num="0770">1. Each Volume corresponds to only one Virtual LUN.</li> <li id="ul0004-0002" num="0771">2. Each Virtual Target can have one or more Virtual LUNs.</li> <li id="ul0004-0003" num="0772">3. Each Virtual Target is assigned an IP address.</li> <li id="ul0004-0004" num="0773">4. A virtual target number is unique in a Pirus box.</li> </ul> </li> </ul>
<div class="description-paragraph" id="p-0768" num="0774">3. Functional Specification In one practice of the invention, the Mediation Manager will be responsible for configuration, monitoring, and management of the Mediation Protocol Engines; and only one instance of the Mediation Manager will run on each 755 on the SRC. Each Mediation Manager will communicate with the MIC and the Mediation Protocol Engines as shown in <figref idrefs="DRAWINGS">FIG. 4</figref> above. The MIC provides the configurations and commands, and the Mediation Protocol Engines will actually implement the various mediation protocols, such as iSCSI, SEP, and the like. The Mediation Manager will not be involved in the actual mediation, hence, it will not be in the data path.</div>
<div class="description-paragraph" id="p-0769" num="0775">4. Functional Requirements
</div> <ul> <li id="ul0005-0001" num="0000"> <ul> <li id="ul0006-0001" num="0776">1. In one practice of the invention, the Mediation Manager always listens to receive configuration and command information from the MIC, and sends statistics back to the MIC.</li> <li id="ul0006-0002" num="0777">2. The Mediation Manager accepts the following configuration information from the MIC, and configures the Mediation Protocol Engines appropriately: a. Add a virtual target i. Mediation Protocol
        <ul> <li id="ul0007-0001" num="0778">1. TCP/UDP port number</li> <li id="ul0007-0002" num="0779">2. Max inactivity time ii. Virtual target number iii. IP address iv. Number of LUNs v. Max number of sessions b. Modify a virtual target c. Remove a virtual target</li> <li id="ul0007-0003" num="0780">3. Once configured by the MIC, the Mediation Manager spawns only one Mediation Protocol Engine for each configured mediation protocol. A Mediation Protocol Engine will handle all the sessions for that protocol to any/all the accessible disks on its Fiber Channel port.</li> <li id="ul0007-0004" num="0781">4. The Mediation Manager accepts the following commands from the MIC and sends a corresponding command to the appropriate Mediation Protocol Engine: a. Start/Stop a Mediation Protocol Engine b. Abort a session c. Get/Reset a stat for a mediation protocol and virtual target</li> </ul>
</li> </ul> </li> </ul>
<div class="description-paragraph" id="p-0770" num="0782">5. The Mediation Manager will collect statistics from the Mediation Protocol Engines and report them to the MIC. The stats are: a. Number of currently established sessions per mediation protocol per virtual target; this stat is unaffected by a stat reset. b. A list of all the sessions for a mediation protocol and virtual target: virtual LUN, attached server, idle time; this stat is unaffected by a stat reset. c. Number of closed sessions due to“inactivity” per mediation protocol per virtual target. d. Number of denied sessions due to“max # of sessions reached” per mediation protocol per virtual target.</div>
<div class="description-paragraph" id="p-0771" num="0783">6. The Mediation Manager will communicate the rules passed down by the MIC to the appropriate Mediation Protocol Engine: a. Host Access Control per mediation protocol (in one practice of the invention, this will be executed on the LIC) i. Deny sessions from a list of hosts/networks ii. Accept sessions only from a list of hosts/networks b. Storage Access Control per virtual target i. Age out a virtual target, i.e., deny all new sessions to a virtual target. This can be used to take a virtual target offline once all current sessions die down.</div>
<div class="description-paragraph" id="p-0772" num="0784">7. The Mediation Manager (as ordered by the user through the MIC) will send the following commands to the Mediation Protocol Engines: a. Start (this may be equivalent to spawning a new engine) b. Stop c. Abort a session d. Get/Reset stats for a mediation protocol and virtual target.</div>
<div class="description-paragraph" id="p-0773" num="0785">8. The Mediation Manager will register to receive ping (ICMP Echo Request) packets destined for any of its virtual targets.</div>
<div class="description-paragraph" id="p-0774" num="0786">9. Once the Mediation Manager receives a ping (ICMP Echo Request) packet for a virtual target, it will send a request to the “Storage Health Service” for a status check on the specified virtual target. Once the reply comes back from the Storage Health Service, the Mediation Manager will send back an ICMP Echo Reply packet.</div>
<div class="description-paragraph" id="p-0775" num="0787">10. The Mediation Manager will register to send/receive messages through IPC with the Storage Health Service.</div>
<div class="description-paragraph" id="p-0776" num="0788">5. Design In the embodiment shown, only one Mediation Manager task runs on each 755 on the SRC. It listens for configuration and command information from the MIC to manage the Mediation Protocol Engines. It also reports back statistics to the MIC. The Mediation Manager spawns the Mediation Protocol Engines as tasks when necessary. In addition, it also handles ping (ICMP Echo Request) packets destined to any of its virtual targets.</div>
<div class="description-paragraph" id="p-0777" num="0789">6. Data Structures In this embodiment, the data structures for keeping track of virtual target devices and their corresponding sessions are set up as shown in <figref idrefs="DRAWINGS">FIG. 9-6</figref>.</div>
<div class="description-paragraph" id="p-0778" num="0790">In the embodiment shown in <figref idrefs="DRAWINGS">FIG. 41</figref>, the number of supported virtual target devices on a Pirus box is 1024, with each having 256 sessions; and the virtual target devices are different for termination and origination.</div>
<div class="description-paragraph" id="p-0779" num="0791">At startup, the Mediation Manager sets up an array of MEDTYPECFGT, one for each mediation protocol type: iSCSI, SEP, SCSI over UDP, and FC over IP. It will then allocate an array of pointers for each virtual target device, DEVENTRYT. Once the MIC configures a new virtual target device (for termination or origination) the Mediation Manager allocates and links in a MEDDEVCFGT structure. Finally, when a new session is established, a MEDSESSENTRYT structure is allocated.</div>
<div class="description-paragraph" id="p-0780" num="0792">This structure will provide a reasonable compromise between memory consumption and the speed at which the structure could be searched for a device or session.</div>
<div class="description-paragraph" id="p-0781" num="0793">In this practice of the invention, a session id is a 32-bit entity defined as follows to allow for direct indexing into the above structure.</div>
<div class="description-paragraph" id="p-0782" num="0794">Mediation type is 4 bits which allows for 16 mediation protocol types.</div>
<div class="description-paragraph" id="p-0783" num="0795">The next single bit indicates whether it is for termination or origination.</div>
<div class="description-paragraph" id="p-0784" num="0796">The next 11 bits represent the device number, basically an index to the device array.</div>
<div class="description-paragraph" id="p-0785" num="0797">The 8 bits of session number is the index into the session array.</div>
<div class="description-paragraph" id="p-0786" num="0798">Finally, 8 bits of generation number is used to distinguish old sessions from current sessions.</div>
<div class="description-paragraph" id="p-0787" num="0799">7. Flow Chart In this practice of the invention, there will be one semaphore that the</div>
<div class="description-paragraph" id="p-0788" num="0800">Mediation Manager will wait upon. Two events will post the semaphore to awaken the Mediation Manager: 1. Arrival of a packet through IPCEP from the MIC 2. Arrival of a ping packet As indicated in <figref idrefs="DRAWINGS">FIG. 42</figref>, the Mediation includes the following steps: Initializing all data structures for mediation <b>4201</b>; Creating two queues: for ping packets and for IPCEP messages <b>4202</b>; Registering to receive IPCEP messages from the MIC <b>4203</b>; Registering to receive ping packets from the TCP/IP stack <b>4204</b>; Waiting to receive ping packets from the TCP/IP stack; Waiting to receive a ping or IPCEP message; Checking whether the received item is an IPCEP message, and if so, Retrieving the message form the queue and checking the message type and calling the med engine API (or similar process) and then returning to the “wait to receive” step; or, if not, Checking whether it is a ping packet, and if so, retrieving the message from the queue, processing the ping packet, contacting the storage health service, and returning to the“wait to receive” step; or if not a ping packet, returning to the“wait to receive” step.</div>
<div class="description-paragraph" id="h-0013" num="0000">IX. Mediation Caching</div>
<div class="description-paragraph" id="p-0789" num="0801">The following section describes techniques for utilizing data caching to improve access times and decrease latency in a mediation system according to the present invention. By installing a data cache on the Client Server (as illustrated in <figref idrefs="DRAWINGS">FIG. 43</figref>), the local clients can achieve faster access times for the data being served by the Data Server. The cache will provide access to data that has already (recently) been read from the Data Server. In the case where a client attempts to access a segment of data that has been previously read, either by the same client or any other attached client, the data can be delivered from the local cache. If the requested data is not in the local cache, the read operation must be transmitted to the Data Server, and the server will access the storage system. Once the data is transferred back to the Client Server, the data will be stored in the local cache, and be available for other clients to access.</div>
<div class="description-paragraph" id="p-0790" num="0802">In a similar fashion, the write performance of the clients can be improved by employing a Non-Volatile Ram (NVRAM) on the client server.</div>
<div class="description-paragraph" id="p-0791" num="0803">Using the NVRAM, the system can reply to the local clients that the write operation is complete as soon as the data is committed to the NVRAM cache.</div>
<div class="description-paragraph" id="p-0792" num="0804">This is possible since the data will be preserved in the NVRAM, and will eventually be written back to the Data Server for commitment to the storage device by the system. The performance can be further improved by altering the way in which the NVRAM data cache is manipulated before the data is sent to the Data Server. The write data from the NVRAM can be accumulated such that a large semi-contiguous write access can be performed to the data server rather than small piecewise accesses. This improves both the data transmit characteristics between the servers as well as improving the storage characteristics of the Data Server since a large transfer involves less processor intervention than small transfers.</div>
<div class="description-paragraph" id="p-0793" num="0805">This system improves latency on data writes when there is space available in the write cache because the client writer does not have to wait for the write data to be transmitted to the Data Server and be committed to the storage device before the acknowledgement is generated. The implied guarantees of commitment to the storage device is managed by the system through the utilization of NVRAM and a system to deliver the data to the Data Server after a system fault.</div>
<div class="description-paragraph" id="p-0794" num="0806">The system improves latency on data reads when the read data segment is available in the local read cache because the client does not have to wait for the data transmission from the data server, or the storage access times before the data is delivered. In the case where the data is not in the local cache the system performance is no worse that a standard system.</div>
<div class="description-paragraph" id="p-0795" num="0807">The system requires that the data in the write cache be available to the client readers so that data integrity can be maintained. The order of operation for read access is 1) check the local write cache for data segment match 2) (if not found in 1) check the local read cache for data segment match 3) (if not found in 2) issue the read command to the Data Server 4) Once the data is transmitted from the Data Server save it in the local data cache.</div>
<div class="description-paragraph" id="p-0796" num="0808">The order of operation for write access is 1) check the local read cache for a matching data segment and invalidate the matching read segments 2) check the local write cache for matching write segments and invalidate (or re-use) 3) generate a new write cache entry representing the write data segments.</div>
<div class="description-paragraph" id="p-0797" num="0809"> <figref idrefs="DRAWINGS">FIG. 43</figref> shows the simple system with one Client Server per Data server. Note that the client server can have any number of clients, and a Client Server can target any number of Data Servers.</div>
<div class="description-paragraph" id="p-0798" num="0810">The caching mechanism becomes more complex in a system such as the one shown in <figref idrefs="DRAWINGS">FIG. 44</figref>. When a system contains more than one Client Server per Data Server, the cache coherency mechanism must become more complex. This is because one client server can modify data that is in the local cache of the other client server, and the data will not match between the Client Servers.</div>
<div class="description-paragraph" id="p-0799" num="0811">Cache coherency can be maintained in the more complex system by determining the state of the cache on the Data Server. Before any data can be served from the Client Server local data cache, a message must be sent to the data server to determine if the data in the local data cache must be updated from the Data Server. One method of determining this is by employing time-stamps to determine if the data in the Client Server local data cache is older than that on the Data Server. If the cache on the Client Server needs to be updated before the data is served to the client, a transmission of the data segment from the Data Server will occur. In this case, the access from the client will look like a standard read operation as if the data were not in the local cache. The local data cache will be updated by the transmission from the Data Server, and the time-stamps will be updated.</div>
<div class="description-paragraph" id="p-0800" num="0812">Similarly, in the data write case, the Data Server must be consulted to see if the write data segments are locked by another client. If the segments are being written by another Client Server during the time a new Client Server wants to write the same segments (or overlapping segments), the new write must wait for the segments to be free (write operation complete from first Client Server). A light weight messaging system can be utilized to check and maintain the cache coherency by determining the access state of the data segments on the Data Server.</div>
<div class="description-paragraph" id="p-0801" num="0813">The order of operation for read access in the complex system is as follows: 1) check the local write cache for data segment match 2) (if not found in 1) check the local read cache for data segment match 3) (if the segment is found in local cache) send a request to the Data Server to determine the validity of the local read cache 4) If the local read cache is not valid, or the segment is not found in the local cache, issue a read operation to the Data Server. 5) Once the data is transmitted from the Data Server save it in the local data cache.</div>
<div class="description-paragraph" id="p-0802" num="0814">Note that the case where the data cache is not valid can be optimized by returning the read data in the event that the local cache data is invalid. This saves an additional request round-trip. The order of operation for write access in the complex system is 1) check the local read cache for a matching data segment and invalidate the matching read segments 2) check the local write cache for matching write segments and invalidate (or re-use) 3) Send a message to the Data Server to determine if the write segment is available for writing (if the segment is not available, wait for the segment to become available) 4) generate a new write cache entry representing the write data segments. 5) Send a message to the Data Server to unlock the data segments.</div>
<div class="description-paragraph" id="p-0803" num="0815">Note that in step <b>3</b>, the message will generate a lock on the data segment if the segment is available; this saves an additional request round-trip.</div>
<div class="description-paragraph" id="h-0014" num="0000">X. Server Health Monitoring</div>
<div class="description-paragraph" id="p-0804" num="0816">The following discussion describes the Pirus Server Health Manager, a system process that runs within the Pirus chassis and monitors the state of storage services that are available to external clients. Server Health manages the state of Pirus Storage services, and uses that data to regulate the flow of data into the Pirus chassis. Server health will use this information to facilitate load balancing, fast-forwarding or discarding of traffic coming into the system.</div>
<div class="description-paragraph" id="p-0805" num="0817">The Pirus Server Health Manager (SHM) is responsible for monitoring the status or health of a target device within the Pirus chassis. Pirus target devices can include, for example, NAS and mediation/iSCSI services that run on processors connected to storage devices.</div>
<div class="description-paragraph" id="p-0806" num="0818">In one practice of the invention, the SHM runs on the Pirus system processor (referred to herein as Network Engine Card or NEC) where NAS or FISCS) storage requests first enter the system. These requests are forwarded from this high-speed data path across a switched fabric to target devices.</div>
<div class="description-paragraph" id="p-0807" num="0819">SHM will communicate with software components in the system and provide updated status to the data-forwarding path.</div>
<div class="description-paragraph" id="p-0808" num="0820">1. Operation with Network Access Server (NAS): In accordance with the invention, SHM communicates with components on the NAS Storage Resource Card (SRC) to monitor the health of NF S services. NFS requests are originated from the NEC and inserted into the data stream along with customer traffic that enters from the high-speed data path. Statistics are gathered to keep track of latency, timeouts and any errors that may be returned from the server. SHM also exchanges IPC messages with the NFS Coherency Manager (NCM) on the SRC to pass state information between the two processors. Message sequences exchanged between these two systems can originate from the NAS or from the NEC.</div>
<div class="description-paragraph" id="p-0809" num="0821">2. Operation with iSCSI/Mediation Devices: SHM will also communicate with a Mediation Device Manager (MDM) that runs on a SRC card and manages mediation devices like iSCSI. SHM will send ICMP messages to each target and wait on responses. Statistics are also gathered for mediation devices to keep track of latency, timeouts and error codes. IPC messages will also be sent from the NEC to MDM whenever an ICMP request times out.</div>
<div class="description-paragraph" id="p-0810" num="0822">Interaction with Data Forwarding Services: Data arrives into the Pirus chassis from high-speed network interfaces like Ethernet. Low-level drivers and the Intelligent Filtering and Forwarding (IFF) component, described elsewhere in this document, receive this data. IFF works with code in the IXP</div>
<div class="description-paragraph" id="p-0811" num="0823">1200 Micro-engine to forward traffic across the backplane to the NAS or FISCS) service.</div>
<div class="description-paragraph" id="p-0812" num="0824">3. Forwarding of NFS Traffic: Either a single server or multiple servers within the Pirus chassis can consume NFS traffic. It is contemplated that NFS traffic forwarded to a single server will always be sent to the same target CPU across the backplane as long as that CPU and server are alive and healthy.</div>
<div class="description-paragraph" id="p-0813" num="0825">A group of NFS servers can provide the same ‘virtual’ service where traffic can be forwarded to multiple servers that reside on multiple CPUs. In this configuration, NFS write and create operations are replicated to every member of the group, while read operations can be load balanced to a single member of the group. The forwarding decision is based on the configured policy along with server health of each of the targets.</div>
<div class="description-paragraph" id="p-0814" num="0826">Load balancing decisions for read operations may be based on a virtual service (defined by a single virtual IP address) and could be as simple as round-robin, or, alternatively, use a configured weight to determine packet forwarding. Health of an individual target could drop one of these servers out of the list of candidates for forwarding or affect the weighting factor.</div>
<div class="description-paragraph" id="p-0815" num="0827">Load balancing may also be based on NFS file handles. This requires that server health, IFF and micro-engine code manage state on NFS file handles and use this state for load balancing within the virtual service. File handle load balancing will work with target server balancing to provide optimum use of services within the Pirus chassis.</div>
<div class="description-paragraph" id="p-0816" num="0828">4. NFS Read Load Balancing Algorithms: The following read load balancing algorithms can be employed: Round robin to each server within a virtual service Configured weight of each server within a virtual service Fastest response time determines weight of each server within a virtual service New file handle round robin to a server within a virtual service, accesses to the same file handle are always directed to the same server New file handle configured weight to a server within a virtual service, accesses to the same file handle are always directed to the same server Heavily accessed file list split across multiple servers Each of the algorithms above will be affected by server health status along with previous traffic loads that have been forwarded. Servers may drop out of the server set if there is congestion or failure on the processor or associated disk subsystem.</div>
<div class="description-paragraph" id="h-0015" num="0000">XI. Fast-Path: Description of Illustrated Embodiments</div>
<div class="description-paragraph" id="p-0817" num="0829">The following description refers to examples of Fast-Path implemented in the Pirus Box and depicted in the attached <figref idrefs="DRAWINGS">FIGS. 45 and 46</figref>. As noted above, however, the Fast-Path methods are not limited to the Pirus Box, and can be implemented in substantially any TCP/UDP processing system, with different combinations of hardware and software, the selection of which is a matter of design choice. The salient aspect is that Fast-Path code is accelerated using distributed, synchronized, fast-path and slow-path processing, enabling TCP (and UDP) sessions to run faster and with higher reliability. The described methods simultaneously maintain TCP state information in both the fast-path and the slow-path, with control messages exchanged between fast-path and slow-path processing engines to maintain state synchronization and hand off control from one processing engine to another. These control messages can be optimized to require minimal processing in the slow-path engines while enabling efficient implementation in the fast path hardware. In particular, the illustrated embodiments provide acceleration in accordance with the following principles:</div>
<div class="description-paragraph" id="p-0818" num="0830">1. Packet processing in a conventional TCP/IP stack is complex and time consuming. However, most packets do not represent an exceptional case and can be handled with much simpler and faster processing. The illustrated embodiments (1) establish a parallel, fast-path TCP/IP stack that handles the majority of packets with minimal processing, (2) pass exceptions to the conventional (slow-path) stack for further processing and (3) maintain synchronization between fast and slow paths.</div>
<div class="description-paragraph" id="p-0819" num="0831">2. As a matter of design choice, the illustrated embodiments employ IXP micro-engines to execute header verification, flow classification, and TCP/IP check-summing. The micro-engines can also be used for other types of TCP/IP processing. Processing is further accelerated by this us of multiple, high-speed processors for routine operations.</div>
<div class="description-paragraph" id="p-0820" num="0832">3. The described system also enables full control over the Mediation applications described in other sections of this document. Limits can be placed on the behavior of such applications, further simplifying TCP/IP processing.
</div> <ul> <li id="ul0008-0001" num="0000"> <ul> <li id="ul0009-0001" num="0833">1. Fast-Path Architecture Referring to <figref idrefs="DRAWINGS">FIG. 45</figref>, the illustrated Fast-Path implementations in the Pirus Box include the following three units, the functions of which are described below:
        <ul> <li id="ul0010-0001" num="0834">1. The Fast-Path module of the SRC card, which integrates the Fast-Path TCP/IP stack. This module creates and destroys Fast-Path sessions based on the TCP socket state, and executes TCP/UDP/IP processing for Fast-Path packets.</li> <li id="ul0010-0002" num="0835">2. Micro-engine code running on the IXPs. This element performs IP header verification, flow classification (by doing a four-tuple lookup in a flow forwarding table) and TCP/UDP check summing.</li> <li id="ul0010-0003" num="0836">3. IFF control code running on the IXP ARM. This module creates/destroys forwarding entries in the flow forwarding table based on the IPC messages from the SRC.</li> </ul>
</li> <li id="ul0009-0002" num="0837">2. Fast-Path Functions 2.1 LRC Processing:</li> <li id="ul0009-0003" num="0838">Referring now to <figref idrefs="DRAWINGS">FIGS. 1 and 2</figref>, it will be seen that the illustrated embodiments of Fast-Path utilize both LRC and SRC processing. When VSEs (Virtual Storage Endpoints) are created, IP addresses are assigned to each, and these IP addresses are added to the IFF forwarding databases on all IXPs.</li> </ul> </li> </ul>
<div class="description-paragraph" id="p-0821" num="0839">For Mediation VSEs, forwarding table entries will be labeled as Mediation in the corresponding destination IPC service number. When the IXP Receive micro-engine receives a packet from its Ethernet interface, it executes a lookup in the IFF forwarding database. If a corresponding entry is found for that packet, and the associated destination service is Mediation, the packet is passed to the IXP Mediation micro-engine for Fast-Path processing. The IXP Mediation micro-engine first verifies the IP header for correctness (length, protocol, IP checksum, no IP options and the like), verifies TCP/UDP checksum, and then executes a flow lookup. If a corresponding entry is found, flow ID is inserted into the packet (overwriting the MAC address) and the packet is forwarded to the Fast-Path service on the destination SRC. If a corresponding entry is not found, the packet is forwarded to the IFF service on the destination SRC.</div>
<div class="description-paragraph" id="p-0822" num="0840">2.2 SRC processing: Referring again to <figref idrefs="DRAWINGS">FIGS. 45 and 46</figref>, when the Fast-Path service on the SRC receives packets from the IPC layer, the SRC extracts Session ID from the packet and uses it to look up socket and TCP control blocks. It then determines whether the packet can be processed by the Fast-Path: i.e., the packet is in sequence, no retransmission, no data queued in the socket's Send buffer, no unusual flags, no options other then timestamp, and timestamp is correct. If any condition is not met, the packet is injected into the slow-path TCP input routine for full processing. Otherwise, TCP counters are updated, ACK-ed data (if any) is released, an ACK packet is generated (if necessary), and the packet is handed directly to the application.</div>
<div class="description-paragraph" id="p-0823" num="0841">2.3 Session creation/termination: In the illustrated embodiments, a Fast-Path session is established immediately after establishment of a standard TCP session (Inside Accept and Connect Calls); and destroyed just before the socket is closed (Inside Close Call). A socket's Send Call will be modified to attempt a Fast-Path Send from the user task's context all the way to the IPC. If Fast-Path fails, the job will fail back to the regular (slow-path) code path of the TCP Send Call, by sending a message to the TCP task. Conversely, the Fast-Path Receive routines, which can be executed from an interrupt or as a separate task, can forward received packets to the user task's message queue, just as conventional TCP Receive processing does. As a result, from the perspective of the user application, packets received by the Fast-Path system are indistinguishable from packets received via the slow-path.</div>
<div class="description-paragraph" id="p-0824" num="0842">Referring again to <figref idrefs="DRAWINGS">FIGS. 45 and 46</figref>, at an initial time (i.e., prior to Fast-Path session creation), there will be no entries in the flow forwarding table, and all packets will pass through the IFF/IP/TCP path on the SRC as described in the other sections of this document. When a TCP (or UDP) connection is established, the TCP socket's code will call Fast-Path code to create a Fast-Path session. When the Fast-Path session is created, all IXPs will be instructed to create a flow forwarding table entry for the session. This ensures that if the route changes and a different IXP begins to receive connection data, appropriate routing information will be available to the“new” IXP. (In IP architectures it is possible to have an asymmetric path, in which outgoing packets are sent to an IXP different from the one receiving the incoming packets. As a result, it would be insufficient to maintain a forwarding table only on the IXP that sends packets out.) Each time a Mediation forwarding table entry is added to the associated IXP's forwarding table, it will broadcast to all SRCs (or, in an alternative embodiment, uni-cast to the involved SRC) a request to re-post any existing Fast-Path sessions for the corresponding address. This step ensures that when a new IXP is added (or crashes and is then re-booted), the pre-existing Fast-Path state is restored. Subsequently, when the TCP (or UDP) connection is terminated, the TCP socket's code will call Fast-Path code to delete the previously-created Fast-Path session. All IXPs then will be instructed to destroy the corresponding flow forwarding table entry.</div>
<div class="description-paragraph" id="p-0825" num="0843">In the case that an SRC processor crashed or was removed from service, the MIC module will detect the crash or removal, and issue a command to remove the associated Mediation IP address. Similarly, if the SRC processor is restarted, it will issue a command to once again add the corresponding Mediation IP address. When the IFF module on the IXP removes the forwarding entry for the corresponding Mediation IP address, it will also remove all corresponding Fast-Path session forwarding entries.</div>
<div class="description-paragraph" id="p-0826" num="0844">2.4 Session Control Blocks: The described Fast-Path system maintains a table of Fast-Path Session Control blocks, each containing at least the following information: 1. Socket SID and SUID, for Fast TCP and Socket Control blocks in Receive operations.</div>
<div class="description-paragraph" id="p-0827" num="0845">2. TCP/IP/Ethernet or UDP/IP/Ethernet header templates for Send operations.</div>
<div class="description-paragraph" id="p-0828" num="0846">3. Cached IP next-hop information, including outgoing source and destination MAC addresses, and the associated IXP's slot, processor and port numbers.</div>
<div class="description-paragraph" id="p-0829" num="0847">An index of the Session Control block serves as a Session ID, enabling rapid session lookups. When a Fast-Path Session is created, the Session ID is stored in the socket structure to enable quick session lookup during Sends.</div>
<div class="description-paragraph" id="p-0830" num="0848">2. 5 IXP Services: Referring again to <figref idrefs="DRAWINGS">FIGS. 45 and 46</figref>, when a new Fast-Path session is established, the IXPs in the Pirus Box are set to forward TCP or UDP flow to a well-known Fast-Path service on the destination SRC processor. The associated IXP will insert an associated Fast-Path flow ID into the first word of the packet's Ethernet header (thereby overriding the destination MAC address) to permit easy flow identification by the Fast-Path processing elements. The IXP will execute a lookup of a four-tuple value (consisting of ip_src, ip_dst, portsrt, portdst) in the forwarding table to determine destination (card, processor, flow ID). In addition, the IXP will execute the following steps for packets that match the four-tuple lookup:</div>
<div class="description-paragraph" id="p-0831" num="0849">1. Check IP header for correctness. Drop packet if this fails.</div>
<div class="description-paragraph" id="p-0832" num="0850">2. Execute IP checksum. Drop packet if this fails.</div>
<div class="description-paragraph" id="p-0833" num="0851">3. Confirm that there is/are no fragmentation or IP option. (As a matter of design choice, certain TCP options are permitted, for timestamp and RDMA.) If this fails, forward the packet to the SRC “slow path” (IFF on SRC).</div>
<div class="description-paragraph" id="p-0834" num="0852">4. Execute TCP or UDP checksum. If this fails, send packet to a special error service on the SRC.</div>
<div class="description-paragraph" id="p-0835" num="0853">The IXP can also execute further TCP processing, including, but not limited to, the following steps:
</div> <ul> <li id="ul0011-0001" num="0000"> <ul> <li id="ul0012-0001" num="0854">1. Confirm that header length is correct.</li> <li id="ul0012-0002" num="0855">2. Confirm that TCP flags are ACK and nothing else.</li> <li id="ul0012-0003" num="0856">3. Confirm that the only option is TCP timestamp.</li> <li id="ul0012-0004" num="0857">4. Remember last window value and confirm that it has not changed.</li> </ul> </li> </ul>
<div class="description-paragraph" id="p-0836" num="0858">The IXP can also have two special well-known services: TCPADDCHECKSUM and UDP ADD CHECKSUM. Packets sent to these services will have TCP and IP, or UDP and IP checksums added to them.</div>
<div class="description-paragraph" id="p-0837" num="0859">Thus, the illustrated Fast-Path embodiment can utilize a number of well-known services, including 2 on the IXP
</div> <ul> <li id="ul0013-0001" num="0000"> <ul> <li id="ul0014-0001" num="0860">IPC_SVC_IXP_CSUM -adds TCP checksum to outbound packets</li> <li id="ul0014-0002" num="0861">IPC_SVC_IXP_UDP_CSUM -adds UDP checksum to outbound packets
<br/>
-and 3 on the SRC:
</li> <li id="ul0014-0003" num="0862">IPC_SVC_SRC_FP -Fast-Path input</li> <li id="ul0014-0004" num="0863">IPC_SVC_SRC_SP -“slow path” input</li> <li id="ul0014-0005" num="0864">IPC_DVC_SRC_FP_ERR -error service that increments</li> </ul> </li> </ul>
<div class="description-paragraph" id="p-0838" num="0865">3. Further Fast Path Aspects Referring again to <figref idrefs="DRAWINGS">FIGS. 45 and 46</figref>, all Fast-Path IPC services (i.e., each service corresponding to a TCP or UDP connection) will have the same IPC callback routine. Flow ID can be readily extracted from the associated Ethernet header information, and can be easily translated into socket descriptor/socket queue ID by executing a lookup in a Fast-Path session table.</div>
<div class="description-paragraph" id="p-0839" num="0866">Subsequently, both TCB and socket structure pointers can also be quickly obtained by a lookup.</div>
<div class="description-paragraph" id="p-0840" num="0867">Fast-Path processing will be somewhat different for TCP and UDP. In the case of UDP, Fast-Path processing of each packet can be simplified substantially to the updating of certain statistics. In the case of TCP, however, a given packet may or may not be eligible for Fast-Path processing, depending on the congestion/flow-control state of the connection. Thus, a Fast-Path session table entry will have a function pointer for either TCP or UDP Fast-Path protocol handler routines, depending on the socket type. In addition, the TCP handler will determine whether a packet is Fast-Path eligible by examining the associated Fast-Path connection entry, TCP header, TCP control block, and socket structure. If a packet is Fast-Path eligible, the TCP handler will maintain the TCP connection, and transmit control information to the Mediation task's message queue. If the TCP stack's Send process needs to be restarted, the TCP handler will send a message to the TCP stack's task to restart the buffered Send. Conversely, if a packet is not eligible for Fast-Path, the TCP handler will send it to the slow-path IP task.</div>
<div class="description-paragraph" id="p-0841" num="0868">In the illustrated embodiments, the Socket Send Call checks to determine whether the socket is Fast-Path enabled, and if it is, calls the Fast-Path Send routine. The Fast-Path Send routine will obtain socket and TCB pointers and will attempt to execute a TCP/IP shortcut and send the packet directly to the IPC. In order to leave a copy of the data in the socket, in case TCP needs to retransmit, the Fast-Path module will duplicate BJ and IBD, increment the REF count on the buffer, and add IBD to the socket buffer. The illustrated embodiments of Fast-Path do not calculate TCP and IP check-sums, but maintain two well-known service numbers, TCP CHECKSUM ADD, UDPCHECKSUMADD; and the IXP will add checksums on the packets received on these services. The destination IXP will be determined by referencing the source IXP of the last received packet. If the Fast-Path system is unable to transmit the packet directly to the IPC it will return an error code to the Socket Send Routine, which will then simply continue its normal code path and send the packet to the slow-path TCP task's message queue for further processing.</div>
<div class="description-paragraph" id="p-0842" num="0869">To provide additional streamlining and acceleration of TCP/UDP packet processing, a number of optional simplifications can be made. For example, the described Fast-Path does not itself handle TCP connection establishment and teardown. These tasks are handled by the conventional TCP stack on the SRC. Similarly, the described Fast-Path does not itself handle IP options and IP fragmentation; these conditions are handled by the conventional TCP stacks on both the LRC and the SRC. In the illustrated embodiments, Fast-Path handles the TCP timestamp option, while the conventional TCP stack on the SRC handles all other options. Similarly, the described Fast-Path system does not handle TCP retransmission and reassembly; these aspects are handled by the conventional TCP stack on the SRC. Certain security protocols, such as IPSec, change the IP protocol field and insert their own headers between the IP and TCP headers. The illustrated Fast-Path embodiments can be modified to handle this circumstance.</div>
<div class="description-paragraph" id="p-0843" num="0870">Fast-Path can be enabled by each socket's application on a per-socket basis. The system can be set to be disabled by default, and can be enabled by doing a socket ioctl after a socket is created, but before a connection is established. Apart from this, the described Fast-Path is transparent for the socket application, from the viewpoint of the socket interface.</div>
<div class="description-paragraph" id="p-0844" num="0871">The performance gains provided by Fast-Path are in part a function of the number of TCP retransmissions in the network. In networks having a large number of packet drops, most of the packets will go through the conventional TCP stack instead of the Fast-Path system. However, in a “good” LAN with limited packet drops, more than 90% of packets will go through Fast-Path, thus providing significant performance improvements.</div>
<div class="description-paragraph" id="p-0845" num="0872">For example, the invention can be implemented in the Pirus interconnection system described below and in U.S. provisional patent application 60/245,295 (referred to as the“Pirus Box”). The Pirus Box routes, switches and bridges multiple protocols across Fibre Channel, Gigabit Ethernet and SCSI protocols and platforms, thereby enabling interoperability of servers, NAS (network attached storage) devices, IP and Fibre Channel switches on SANs (storage area networks), WANs (wide area networks) or LANs (wide area networks). Within the Pirus Box, multiple front-end controllers (IXPs) connect to a high-speed switching fabric and point-to-point serial interconnect.</div>
<div class="description-paragraph" id="p-0846" num="0873">Back-end controllers connect to switched Ethernet or other networks, managing the flow of data from physical storage devices.</div>
<div class="description-paragraph" id="p-0847" num="0874">In one implementation of the invention within the Pirus Box, the Fast-Path includes Fast-Path code running on 750-series microprocessors, with hardware acceleration in IXP micro-engines. Alternatively, in a configuration having a close coupling between the IXP modules and the processors terminating TCP sessions, the Fast-Path code is executed together with the hardware acceleration in the IXP micro-engines. In each case, the described Fast-Path code can be highly optimized and placed in gates or micro-engines.</div>
<div class="description-paragraph" id="p-0848" num="0875">Such code will execute much faster than a conventional TCP/IP stack, even when running on the same processor as a conventional stack.</div>
<div class="description-paragraph" id="p-0849" num="0876">The Fast-Path methods described herein are not limited to the Pirus Box, but can be implemented in substantially any TCP/UDP processing system.</div>
<div class="description-paragraph" id="p-0850" num="0877">GLOSSARY OF TERMS</div>
<div class="description-paragraph" id="p-0851" num="0878">Backplane—the Pirus box chassis is referred to herein a backplane; however, it will be recognized that the chassis could alternatively be a midplane design.</div>
<div class="description-paragraph" id="p-0852" num="0879">CLI—Command Line Interface</div>
<div class="description-paragraph" id="p-0853" num="0880">FC—Fibre Channel</div>
<div class="description-paragraph" id="p-0854" num="0881">FSC—Fibre Channel Switching Card</div>
<div class="description-paragraph" id="p-0855" num="0882">IFF—Layer 2, 3, 4 and 5 Intelligent Filtering and Forwarding switch</div>
<div class="description-paragraph" id="p-0856" num="0883">JBOD—Just a Bunch of Disks</div>
<div class="description-paragraph" id="p-0857" num="0884">LlC—LAN Interface Card</div>
<div class="description-paragraph" id="p-0858" num="0885">MAC—Media Access Control-usually refers to an Ethernet interface chip</div>
<div class="description-paragraph" id="p-0859" num="0886">MIC—Management Interface Card</div>
<div class="description-paragraph" id="p-0860" num="0887">MTU—Maximum Transfer Unit-largest payload that can be sent on a medium.</div>
<div class="description-paragraph" id="p-0861" num="0888">NEC—Network Engine Card</div>
<div class="description-paragraph" id="p-0862" num="0889">NP—Network Processor</div>
<div class="description-paragraph" id="p-0863" num="0890">SCSI—Small Computer Systems Interface</div>
<div class="description-paragraph" id="p-0864" num="0891">SRC—Resource Module Card</div>
<div class="description-paragraph" id="p-0865" num="0892">uP—Microprocessor</div>
<div class="description-paragraph" id="p-0866" num="0893">ARP—Address Resolution Protocol</div>
<div class="description-paragraph" id="p-0867" num="0894">CLI—Command Line Interface</div>
<div class="description-paragraph" id="p-0868" num="0895">CONSOLE—System Console</div>
<div class="description-paragraph" id="p-0869" num="0896">CPCM—Card/Processor Configuration Manager</div>
<div class="description-paragraph" id="p-0870" num="0897">CSA—Configuration and Statistics Agent</div>
<div class="description-paragraph" id="p-0871" num="0898">CSM—Configuration and Statistics Manager</div>
<div class="description-paragraph" id="p-0872" num="0899">DC—Disk Cache</div>
<div class="description-paragraph" id="p-0873" num="0900">Eth Dryer—Ethernet Driver</div>
<div class="description-paragraph" id="p-0874" num="0901">FC Nx—Fibre Channel Nx Port</div>
<div class="description-paragraph" id="p-0875" num="0902">FFS—Flash File System</div>
<div class="description-paragraph" id="p-0876" num="0903">FS—File System</div>
<div class="description-paragraph" id="p-0877" num="0904">HTTP—Hyper Text Transfer Protocol</div>
<div class="description-paragraph" id="p-0878" num="0905">HTTPS—Hyper Test Transfer Protocol Secured</div>
<div class="description-paragraph" id="p-0879" num="0906">IP—Internet Protocol</div>
<div class="description-paragraph" id="p-0880" num="0907">IPC—Inter Process Communication</div>
<div class="description-paragraph" id="p-0881" num="0908">L<b>2</b>—Layer 2</div>
<div class="description-paragraph" id="p-0882" num="0909">LHC—Local Hardware Control</div>
<div class="description-paragraph" id="p-0883" num="0910">LOGI—Logging Interface</div>
<div class="description-paragraph" id="p-0884" num="0911">MLAN—Management LAN</div>
<div class="description-paragraph" id="p-0885" num="0912">MNT—Mount</div>
<div class="description-paragraph" id="p-0886" num="0913">NFS—Network File Seryer</div>
<div class="description-paragraph" id="p-0887" num="0914">RCB—Rapid Control Backplane</div>
<div class="description-paragraph" id="p-0888" num="0915">RPC—Remote Procedure Call</div>
<div class="description-paragraph" id="p-0889" num="0916">RSS—Remote Shell Service</div>
<div class="description-paragraph" id="p-0890" num="0917">S<b>2</b>—System Services</div>
<div class="description-paragraph" id="p-0891" num="0918">SAM—System Abstraction Model</div>
<div class="description-paragraph" id="p-0892" num="0919">SB—Service Broker</div>
<div class="description-paragraph" id="p-0893" num="0920">SCSI—Small Computer System Interface</div>
<div class="description-paragraph" id="p-0894" num="0921">SFI—Switch Fabric Interface</div>
<div class="description-paragraph" id="p-0895" num="0922">SGLUE—SNMP Glue</div>
<div class="description-paragraph" id="p-0896" num="0923">SNMP—Simple Network Management Protocol</div>
<div class="description-paragraph" id="p-0897" num="0924">SSC—Server State Client</div>
<div class="description-paragraph" id="p-0898" num="0925">SSH—Secured Shell</div>
<div class="description-paragraph" id="p-0899" num="0926">SSM—Server State Manager</div>
<div class="description-paragraph" id="p-0900" num="0927">TCP—Transmission Control Protocol</div>
<div class="description-paragraph" id="p-0901" num="0928">UDP—User Datagram Protocol</div>
<div class="description-paragraph" id="p-0902" num="0929">VM—Volume Manager</div>
<div class="description-paragraph" id="p-0903" num="0930">WEBH—WEB Handlers
</div> <ul> <li id="ul0015-0001" num="0931">Current Filesystem Server Set: The subset of the configured filesystem server set that is made up of members that have synchronized copies of the filesystem.</li> <li id="ul0015-0002" num="0932">Joining Filesystem Server Set: Members not part of the Current Filesystem Set that are in the process of joining that set.</li> <li id="ul0015-0003" num="0933">Complete copy of a Filesystem: A copy of a filesystem containing file data for all file inodes of a filesystem.</li> <li id="ul0015-0004" num="0934">Construction of a Filesystem Copy: Building a sparse or complete copy of a filesystem by copying every element of the source filesystem.</li> <li id="ul0015-0005" num="0935">Filesystem Checkpoint: NCM has insured that all members of the current filesystem server set have the same copy of the filesystem. A new filesystem checkpoint value was written to all copies and placed on stable storage. The filesystem modification sequence number on all members of the current filesystem server set is the same. The IN-MOD has been cleared on all members of the current filesystem server set.</li> <li id="ul0015-0006" num="0936">Filesystem Checkpoint Value: Filesystems and NVRAM are marked with a filesystem checkpoint value to indicate when running copies of the filesystem were last checkpointed. This is used to identify stale (non-identical, non-synchronized) filesystems.</li> <li id="ul0015-0007" num="0937">Filesystem Modification Sequence Number: The number of NFS modification requests performed by a NAS server since the last filesystem checkpoint.</li> <li id="ul0015-0008" num="0938">Each NAS server is responsible for maintaining its own stable storage copy that is accessible to the NCM after a failure. The filesystem checkpoint value combined with this number indicate which NAS server has the most recent copy of the filesystem.</li> <li id="ul0015-0009" num="0939">Inode List Allocated (IN-Alloc): The list of inodes in a filesystem that have been allocated.</li> <li id="ul0015-0010" num="0940">Inode List Content (IN-Con): The list of inodes in a filesystem that have content present on a server; this must be a subset of IN-Alloc. This will include every non-file (i.e. directory) inode. If this is a Complete Copy of a Filesystem, then IN-Con is identical to IN-Alloc.</li> <li id="ul0015-0011" num="0941">Inode List Copy (IN-Copy): Which inodes of a filesystem have been modified since we began copying the filesystem (during Construction/Restoration); in the disclosed embodiments, this must be a subset of IN-Con.</li> <li id="ul0015-0012" num="0942">Inode List Modified (IN-Mod): Which inodes have been modified since the last filesystem checkpoint. 2 filesystems with the same filesystem checkpoint value should only differ by the changes represented by their modified InodeList. A Filesystem Checkpoint between two filesystems means that each is a logical image of one another, and the IN-Mod can be cleared.</li> <li id="ul0015-0013" num="0943">NCM-NAS Coherency Manager: The Pirus chassis process that is responsible for synchronizing peer NAS servers.</li> <li id="ul0015-0014" num="0944">Peer NAS Server: Any CPU that is a member of a virtual storage target group (VST).</li> <li id="ul0015-0015" num="0945">Recovery of a Filesystem Copy: Bringing an out of date filesystem copy in sync with a later copy. This can be accomplished by construction or restoration.</li> <li id="ul0015-0016" num="0946">Restoration of a Filesystem Copy: Bringing a previously served filesystem from its current state to the state of an up to date copy by a means other than an element by element copy of the original.</li> <li id="ul0015-0017" num="0947">Sparse copy of a filesystem: A copy of a filesystem containing file data for less than all file inodes of a filesystem.</li> <li id="ul0015-0018" num="0948">VST—Virtual Storage Target: As used herein, this term refers to a group of NAS server CPUs within a Pirus chassis that creates the illusion of a single NAS server to an external client.</li> <li id="ul0015-0019" num="0949">ARM, StrongARM processors: general-purpose processors with embedded networking protocols and/or applications compliant with those of ARM Holdings, PLC (formerly Advanced RISC Machines) of Cambridge, U. K.</li> <li id="ul0015-0020" num="0950">BSD: sometimes referred to as Berkeley UNIX, an open source operating system developed in the 1970s at U. C. Berkeley. BSD is found in nearly every variant of UNIX, and is widely used for Internet services and firewalls, timesharing, and multiprocessing systems.</li> <li id="ul0015-0021" num="0951">IFF—Intelligent Forwarding and Filtering (described elsewhere in this document in the context of the Pirus Box architecture).</li> <li id="ul0015-0022" num="0952">IOCTL: A system-dependent device control system call, the ioctl function typically performs a variety of device-specific control functions on device special files.</li> <li id="ul0015-0023" num="0953">IPC: Inter-Process Communications. On the Internet, IPC is implemented using TCP transport-layer protocol.</li> <li id="ul0015-0024" num="0954">IPSec: IP security protocol, a standard used for interoperable network encryption.</li> <li id="ul0015-0025" num="0955">IXP: Internet Exchange Processors, such as Intel's IXP 1200 Network Processors, can be used at various points in a network or switching system to provide routing and other switching functions. Intel's IXP 1200, for example, is an integrated network processor based on the StrongARM architecture and six packet-processing micro-engines. It supports software and hardware compliant with the Intel Internet Exchange Architecture (IXA). See Pirus Box architecture described elsewhere in this document.</li> <li id="ul0015-0026" num="0956">LRC: LAN Resource Card. In the Pirus Box described herein, the LRC interfaces to external LANs, servers or WANS, performs load balancing and content-aware switching, implements storage mediation protocols and provides TCP hardware acceleration in accordance with the present invention.</li> <li id="ul0015-0027" num="0957">MAC address: Media Access Control address; a hardware address that uniquely identifies each node of a network.</li> <li id="ul0015-0028" num="0958">Micro-engine: Micro-coded processor in the IXP. In one implementation of the Pirus Box, there are six in each IXP.</li> <li id="ul0015-0029" num="0959">NFS: Network File Server Protocol Mediation: applications and/or devices that translate between and among different protocols, such as TCP/IP, X. 25, SNMP and the like.</li> <li id="ul0015-0030" num="0960">Particular Mediation techniques and systems are described elsewhere in this document in connection with the Pirus Box.</li> <li id="ul0015-0031" num="0961">RDMA: Remote Direct Memory Access. The transfer of application data from a remote buffer into a contiguous local buffer. Typically refers to memory-to-memory copying between processors over TCP protocols such as HTTP and NFS across an Ethernet.</li> <li id="ul0015-0032" num="0962">SCSI: Small Computer System Interface, widely-used ANSI standards-based family of protocols for communicating with)/0 devices, particularly storage devices.</li> <li id="ul0015-0033" num="0963">FISCS): Internet SCSI, a proposed transport protocol for SCSI that operates on top of TCP, and transmits native SCSI over a layer of the IP stack. The Pirus Box described herein provides protocol mediation services to FISCS) devices and networks (“iSCSI Mediation Services”), using TCP/IP to provide LAN-attached servers with access to block-oriented storage.</li> <li id="ul0015-0034" num="0964">Silly Window Avoidance Algorithm (Send-Side): A technique in which the sender delays sending segments until it can accumulate a reasonable amount of data in its output buffer. In some cases, a “reasonable amount” is defined to be a maximum-sized segment (MST).</li> <li id="ul0015-0035" num="0965">SRC: Storage Resource Card. In the Pirus Box architecture described herein, the SRC interfaces to external storage devices, provides NFS and CIFS services, implements IP to Fibre Channel (FC) storage mediation, provides volume management services (including dynamic storage partitioning and JBOD (Just a Bunch of Disks) aggregation to create large storage pools), supports RAID functionality and provides integrated Fibre Channel SAN switching.</li> <li id="ul0015-0036" num="0966">TCP: Transmission Control Protocol, a protocol central to TCP/IP networks.</li> <li id="ul0015-0037" num="0967">TCP guarantees delivery of data and that packets will be delivered in the same order in which they were sent.</li> <li id="ul0015-0038" num="0968">TCP/IP: Transmission Control Protocol/Internet Protocol, the suite of communications protocols used to connect hosts on the Internet.</li> <li id="ul0015-0039" num="0969">UDP: User Datagram Protocol (UDP) supports a datagram mode of packet-switched communications in an interconnected set of computer networks, and enables applications to message other programs with a minimum of protocol mechanism. UDP is considerably simpler than TCP and is useful in situations where the reliability mechanisms of TCP are not necessary. The UDP header has only four fields: source port, destination port, length, and UDP checksum.</li> <li id="ul0015-0040" num="0970">VxWorks: a real-time operating system, part of the Tornado II embedded development platform commercially available from WindRiver Systems, Inc. of Alameda, Calif., which is designed to enable developers to create complex real-time applications for embedded microprocessors.</li> </ul>
<div class="description-paragraph" id="p-0904" num="0971">
<tables id="TABLE-US-00002" num="00002">
<patent-tables colsep="0" frame="none" rowsep="0">
<table align="left" class="description-table" cols="1" colsep="0" rowsep="0" width="100%">
<thead>
<tr class="description-tr">
<td align="center" class="description-td" colspan="1" nameend="1" namest="1" rowsep="1"> </td>
</tr>
<tr class="description-tr">
<td class="description-td">TABLE OF CONTENTS</td>
</tr>
<tr class="description-tr">
<td align="center" class="description-td" colspan="1" nameend="1" namest="1" rowsep="1"> </td>
</tr>
</thead>
<tbody><tr class="description-tr">
<td class="description-td"> </td>
</tr>
</tbody></table>
<table align="left" class="description-table" cols="1" colsep="0" rowsep="0" width="100%">
<tbody><tr class="description-tr">
<td class="description-td">Incorporation by Reference/Priority Claim</td>
</tr>
<tr class="description-tr">
<td class="description-td">Field of the Invention</td>
</tr>
<tr class="description-tr">
<td class="description-td">Background of the Inventor</td>
</tr>
<tr class="description-tr">
<td class="description-td">Summary of the Invention</td>
</tr>
<tr class="description-tr">
<td class="description-td">Brief Description of the Drawings</td>
</tr>
<tr class="description-tr">
<td class="description-td">Detailed Description of the Invention</td>
</tr>
<tr class="description-tr">
<td class="description-td">I. Overview</td>
</tr>
<tr class="description-tr">
<td class="description-td">II. Hardware/Software Architecture</td>
</tr>
<tr class="description-tr">
<td class="description-td">1. Software Architecture Overview</td>
</tr>
<tr class="description-tr">
<td class="description-td">1.1. System Services</td>
</tr>
<tr class="description-tr">
<td class="description-td">1.1.1. SanStreaM (SSM) System Services (S2)</td>
</tr>
<tr class="description-tr">
<td class="description-td">1.1.2. SSM Application Service (AS)</td>
</tr>
<tr class="description-tr">
<td class="description-td">2. Management Interface Card</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.1. Management Software</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.2. Management Software Overview</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.2.1. User Interfaces (Uis)</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.2.2. Rapid Control Backplane (RBI)</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.2.3. System Abstraction Model (SAM}</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.2.4. Configuration &amp; Statistics Manager (CSM)</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.2.5. Logging I Billing (APis)</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.2.6. Configuration &amp; Statistics Agent (CSA)</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.3. Dynamic Configuration</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.4. Management Applications</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.4.1. Volume Manager</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.4.2. Load Balancer</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.4.3. Server-less Backup (NDMP)</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.4.4. IP-ized Storage Management</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.4.5. Mediation Manager</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.4.6. VLAN Manager</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.4.7. File System Manager</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.5. Virtual Storage Domain (VSD)</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.5.1. Services</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.5.2. Policies</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.6. Boot Sequence and Configuration</td>
</tr>
<tr class="description-tr">
<td class="description-td">3. LIC Software</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.1. VLANs</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.1.1. Intelligent Filtering and Forwarding (IFF)</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.2. Load Balance Data Flow</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3. LIC-NAS Software</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3.1. Virtual Storage Domains (VSD)</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3.2. Network Address Translation (NAT)</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3.3. Local Load Balance (LLB)</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3.3.1. Load Balancing Order of Operations</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3.3.2. File System Server Load Balance (FSLB)</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3.3.3. NFS Server Load Balancing (NLB)</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3.3.4. TCP and UDP-Methods of Balancing</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3.3.5. Write Replication</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3.4. Load Balancer Failure Indication</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3.4.1. CIFS Server Load Balancing</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3.4.2. Content Load Balance</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.4. LIC-SCSI/IP Software</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.5. Network Processor Functionality</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.5.1. Flow Control</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.5.1.1. Flow Definition</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.5.1.2. Flow Control Model</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.5.2. Flow Thru V. Buffering</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.5.2.1. Flow Thru</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.5.2.2. Buffering</td>
</tr>
<tr class="description-tr">
<td class="description-td">4. SRC NAS (Software Features)</td>
</tr>
<tr class="description-tr">
<td class="description-td">4.1. SRC NAS Storage Features</td>
</tr>
<tr class="description-tr">
<td class="description-td">4.1.1. Volume Manager</td>
</tr>
<tr class="description-tr">
<td class="description-td">4.1.2. Disk Cache</td>
</tr>
<tr class="description-tr">
<td class="description-td">4.1.3. SCSI</td>
</tr>
<tr class="description-tr">
<td class="description-td">4.1.4. Fibre Channel</td>
</tr>
<tr class="description-tr">
<td class="description-td">4.1.5. Switch Fabric Interface</td>
</tr>
<tr class="description-tr">
<td class="description-td">4.2. NAS Pirus System Features</td>
</tr>
<tr class="description-tr">
<td class="description-td">4.2.1. Configuration/Statistics.</td>
</tr>
<tr class="description-tr">
<td class="description-td">4.2.2. NSF Load Balancing</td>
</tr>
<tr class="description-tr">
<td class="description-td">4.2.3. NFS Mirroring Service</td>
</tr>
<tr class="description-tr">
<td class="description-td">5. SRC Mediation</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1. Supported Mediation Protocols</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.1. SCSI/UDP</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.2. Storage Components</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.2.1. SCSI/IP Layer</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.2.2. SCSI Mediator</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.2.3. Volume Manager</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.2.4. SCSI Originator</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.2.5. SCSI Target</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.2.6. Fibre Channel</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.3. Mediation Example</td>
</tr>
<tr class="description-tr">
<td class="description-td">III. NFS Load Balancing</td>
</tr>
<tr class="description-tr">
<td class="description-td">1 Operation</td>
</tr>
<tr class="description-tr">
<td class="description-td">1.1. Read Requests</td>
</tr>
<tr class="description-tr">
<td class="description-td">1.2. Determining the Number of Servers for a File</td>
</tr>
<tr class="description-tr">
<td class="description-td">1.3. Server Lists</td>
</tr>
<tr class="description-tr">
<td class="description-td">1.3.1. Single Server List</td>
</tr>
<tr class="description-tr">
<td class="description-td">1.3.2. Multiple Server Lists</td>
</tr>
<tr class="description-tr">
<td class="description-td">1.4. Synchronizing Lists Across Multiple IXP's</td>
</tr>
<tr class="description-tr">
<td class="description-td">IV. Intelligent Forwarding and Filtering</td>
</tr>
<tr class="description-tr">
<td class="description-td">1. Definitions</td>
</tr>
<tr class="description-tr">
<td class="description-td">2. Virtual Domains</td>
</tr>
<tr class="description-tr">
<td class="description-td">2.1. Network Address Translation</td>
</tr>
<tr class="description-tr">
<td class="description-td">3. VLAN Definition</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.1. Default VLAN</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.2. Server Administration VLAN</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.3. Server Access VLAN</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.4. Port Types</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.4.1. Router Port</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.4.2. Server Port</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.4.3. Combo Port</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.4.4. Server Administration Port</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.4.5. Server Access Port</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.4.6. Example of VLAN</td>
</tr>
<tr class="description-tr">
<td class="description-td">4. Filtering Function</td>
</tr>
<tr class="description-tr">
<td class="description-td">5. Forwarding Function</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1. Flow Entry Description</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.1. Source IP Address</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.2. Destination IP Address</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.3. Destination TCP/UOP port</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.4. Source physical port</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.5. Source next-hop MAC address</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.6. Destination physical port</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.7. Destination next-hop MAC address</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.8. NAT IP address</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.9. NAT TCP/UDP port</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.10. Flags</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.11. Received packets</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.12. Transmitted packets</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.13. Received bytes</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.14. Transmitted bytes</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.15. Next pointer (receive path)</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.1.16. Next pointer (transmit path)</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.2. Adding Forwarding Entries</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.2.1. Client IP Addresses</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.2.2. Virtual Domain IP Addresses</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.2.3. Server IP Addresses</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.3. Distribute the Forwarding Table</td>
</tr>
<tr class="description-tr">
<td class="description-td">5.4. Ingress Function</td>
</tr>
<tr class="description-tr">
<td class="description-td">6. Egress Function</td>
</tr>
<tr class="description-tr">
<td class="description-td">V. IP-Based Storage Management-Device Discovery &amp; Monitoring</td>
</tr>
<tr class="description-tr">
<td class="description-td">Examples:</td>
</tr>
<tr class="description-tr">
<td class="description-td">Server Health</td>
</tr>
<tr class="description-tr">
<td class="description-td">Mediation Target</td>
</tr>
<tr class="description-tr">
<td class="description-td">Mediation Initiator</td>
</tr>
<tr class="description-tr">
<td class="description-td">NCM</td>
</tr>
<tr class="description-tr">
<td class="description-td">VI DATA STRUCTURE LAYOUT</td>
</tr>
<tr class="description-tr">
<td class="description-td">1. VSD_CFG_T</td>
</tr>
<tr class="description-tr">
<td class="description-td">2. VSE_CFG_T</td>
</tr>
<tr class="description-tr">
<td class="description-td">3. SERVER_CFG_T</td>
</tr>
<tr class="description-tr">
<td class="description-td">4. MED_TARG_CFG_T</td>
</tr>
<tr class="description-tr">
<td class="description-td">5. LUN_MAP CFG_T</td>
</tr>
<tr class="description-tr">
<td class="description-td">6. FILESYS_CFT T</td>
</tr>
<tr class="description-tr">
<td class="description-td">VII. NAS Mirroring and Content Distribution</td>
</tr>
<tr class="description-tr">
<td class="description-td">1. Content Distribution and Mirroring</td>
</tr>
<tr class="description-tr">
<td class="description-td">2. Mirror Initialization via NAS</td>
</tr>
<tr class="description-tr">
<td class="description-td">Mirror Initialization via NDMP</td>
</tr>
<tr class="description-tr">
<td class="description-td">Sparse Content Distribution</td>
</tr>
<tr class="description-tr">
<td class="description-td">NCM</td>
</tr>
<tr class="description-tr">
<td class="description-td">NCM Objectives</td>
</tr>
<tr class="description-tr">
<td class="description-td">NCM Architecture</td>
</tr>
<tr class="description-tr">
<td class="description-td">NCM Processes and Locations</td>
</tr>
<tr class="description-tr">
<td class="description-td">NCM and IPC Services</td>
</tr>
<tr class="description-tr">
<td class="description-td">NCM and lnode Management</td>
</tr>
<tr class="description-tr">
<td class="description-td">lnode Allocation Synchronization</td>
</tr>
<tr class="description-tr">
<td class="description-td">lnode Inconsistency Identification</td>
</tr>
<tr class="description-tr">
<td class="description-td">3. Filesystem Server Sets</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.1. Types</td>
</tr>
<tr class="description-tr">
<td class="description-td">3.2. State of the Current Server Set</td>
</tr>
<tr class="description-tr">
<td class="description-td">4. Description of Operations</td>
</tr>
<tr class="description-tr">
<td class="description-td">Create_Current_Filesystem_Server_Set (fsid, slots/cpus)</td>
</tr>
<tr class="description-tr">
<td class="description-td">Add_Member_To_Current Filesystem_Server_Set (fsid, slot/cpu)</td>
</tr>
<tr class="description-tr">
<td class="description-td">5. Description of Operations that Change the State of the Current</td>
</tr>
<tr class="description-tr">
<td class="description-td">Server Set</td>
</tr>
<tr class="description-tr">
<td class="description-td">Activate_Server_Set (fsid)</td>
</tr>
<tr class="description-tr">
<td class="description-td">Pause Filesystem Server Set (fsid)</td>
</tr>
<tr class="description-tr">
<td class="description-td">Continue Filesystem Server Set (fsid)</td>
</tr>
<tr class="description-tr">
<td class="description-td">Deactivate_Server_Set (fsid)</td>
</tr>
<tr class="description-tr">
<td class="description-td">6. Recovery Operations on a Filesystem Copy</td>
</tr>
<tr class="description-tr">
<td class="description-td">Construction</td>
</tr>
<tr class="description-tr">
<td class="description-td">Restoration</td>
</tr>
<tr class="description-tr">
<td class="description-td">NAS-FS-Copy</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Construction of Complete Copy</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Copy Method</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Special lnodes</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Locking</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Restoration of Complete Copy</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Data structures</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Modified-lnodes-list (IN-Mod)</td>
</tr>
<tr class="description-tr">
<td class="description-td">    Copy-lnodes-list (IN-Copy)</td>
</tr>
<tr class="description-tr">
<td class="description-td">    Copy progress</td>
</tr>
<tr class="description-tr">
<td class="description-td">    Copying lnodes</td>
</tr>
<tr class="description-tr">
<td class="description-td">    Construction case</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Restoration Case</td>
</tr>
<tr class="description-tr">
<td class="description-td">Examples - Set 1</td>
</tr>
<tr class="description-tr">
<td class="description-td">Examples - Set 2</td>
</tr>
<tr class="description-tr">
<td class="description-td">VIII. System Mediation Manager</td>
</tr>
<tr class="description-tr">
<td class="description-td">Components</td>
</tr>
<tr class="description-tr">
<td class="description-td">Storage Hierarchy</td>
</tr>
<tr class="description-tr">
<td class="description-td">Functional Specification</td>
</tr>
<tr class="description-tr">
<td class="description-td">Functional Requirement</td>
</tr>
<tr class="description-tr">
<td class="description-td">Design</td>
</tr>
<tr class="description-tr">
<td class="description-td">Data Structures</td>
</tr>
<tr class="description-tr">
<td class="description-td">Flow Chart</td>
</tr>
<tr class="description-tr">
<td class="description-td">X. Mediation Caching</td>
</tr>
<tr class="description-tr">
<td class="description-td">XI. Server Health Monitoring</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Operation with Network Access Server (NAS)</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Operation with iSCS/Mediation Devices</td>
</tr>
<tr class="description-tr">
<td class="description-td">Forwarding of NFS Traffic</td>
</tr>
<tr class="description-tr">
<td class="description-td">NFS Read Load Balancing Algorithms</td>
</tr>
<tr class="description-tr">
<td class="description-td">XII. Fast-Path: Description of Illustrated Embodiments</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Fast-Path Architecture</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Fast-Path Functions</td>
</tr>
<tr class="description-tr">
<td class="description-td">  LRC Processing</td>
</tr>
<tr class="description-tr">
<td class="description-td">  SRC processing</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Session creation/termination</td>
</tr>
<tr class="description-tr">
<td class="description-td">  Session Control Blocks</td>
</tr>
<tr class="description-tr">
<td class="description-td">IXP Services</td>
</tr>
<tr class="description-tr">
<td class="description-td">Further Fast Path Aspect</td>
</tr>
<tr class="description-tr">
<td align="center" class="description-td" colspan="1" nameend="1" namest="1" rowsep="1"> </td>
</tr>
</tbody></table>
</patent-tables>
</tables>
</div>
</div>
</div>
</section><section itemprop="claims" itemscope="">
<h2>Claims (<span itemprop="count">13</span>)</h2>
<div html="" itemprop="content"><div class="claims" lang="EN" load-source="patent-office" mxw-id="PCLM299705979">
<claim-statement>What is claimed is:</claim-statement>
<div class="claim"> <div class="claim" id="CLM-00001" num="00001">
<div class="claim-text">1. A digital processing system for processing data packets in at least one data network, comprising:
<div class="claim-text">a storage resource card;</div>
<div class="claim-text">wherein storage resource card includes a first stack for performing a first type of packet processing with a first number of processing steps on data packets received in the at least one network and</div>
<div class="claim-text">a second stack for performing a second type of packet processing that comprises a second number of processing steps on data packets received in the at least one network, wherein the second number of processing steps is less than the first number of processing steps;</div>
<div class="claim-text">wherein the storage resource card receives packets and determines whether the received packets correspond to the first type or second type of packet processing, wherein the storage resource card injects packets that correspond to the first type of packet processing into the first stack, and wherein the storage resource card processes packets that correspond to the second type of packet processing according to the second stack.</div>
</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00002" num="00002">
<div class="claim-text">2. The system of <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the storage resource card determines whether the received packets correspond to the first or second types of packet processing based on Session IDs associated with the received packets.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00003" num="00003">
<div class="claim-text">3. The system of <claim-ref idref="CLM-00002">claim 2</claim-ref>, wherein the packets requiring exceptions processing are injected into the first stack.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00004" num="00004">
<div class="claim-text">4. The system of <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the storage resource card determines whether the received packets correspond to the first or second types of packet processing based on TCP socket states associated with the received packets.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00005" num="00005">
<div class="claim-text">5. The system of <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the first stack is implemented by a first processor of the storage resource card and the second stack is implemented by a second processor of the storage resource card, and wherein the first and second processors exchange control messages to maintain state synchronization.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00006" num="00006">
<div class="claim-text">6. The system of <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the first stack and the second stack are implemented by a single processor disposed on the storage resource card.</div>
</div>
</div> <div class="claim"> <div class="claim" id="CLM-00007" num="00007">
<div class="claim-text">7. A method for processing data packets, comprising:
<div class="claim-text">receiving a data packet at a storage resource card that comprises a first stack for processing data packets according to a slow path and a second stack for processing data packets according to a fast path;</div>
<div class="claim-text">determining whether the data packet is eligible for processing by the second stack; and</div>
<div class="claim-text">routing the data packet to the second stack as a function of the packet being eligible for processing by the second stack or routing the data packet to the first stack as a function of the packet being ineligible for processing by the second stack.</div>
</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00008" num="00008">
<div class="claim-text">8. The method of <claim-ref idref="CLM-00007">claim 7</claim-ref>, wherein the determining comprises:
<div class="claim-text">extracting a Session ID from the data packet;</div>
<div class="claim-text">using the Session ID to look up socket and TCP control blocks corresponding to the data packet; and</div>
<div class="claim-text">examining the socket and TCP control blocks, a TCP header, and an associated Fast-Path connection entry to determine whether the data packet is eligible for processing by the second stack.</div>
</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00009" num="00009">
<div class="claim-text">9. The method of <claim-ref idref="CLM-00007">claim 7</claim-ref>, wherein the determining comprises assessing whether the data packet will require exception processing based on at least one of:
<div class="claim-text">an out of order sequence of the data packet in relation to other data packets;</div>
<div class="claim-text">a TCP-atypical flag corresponding to the data packet;</div>
<div class="claim-text">an option associated with the data packet;</div>
<div class="claim-text">an incorrect timestamp associated with the data packet;</div>
<div class="claim-text">data queued in a send buffer of a socket associated with the data packet; and</div>
<div class="claim-text">a retransmission requirement.</div>
</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00010" num="00010">
<div class="claim-text">10. The method of <claim-ref idref="CLM-00007">claim 7</claim-ref>, wherein the determining comprises sending the data packet directly to an inter-processor communication module, wherein receiving an error code at a socket send routine indicates that the data packet is ineligible for processing by the second stack.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00011" num="00011">
<div class="claim-text">11. The method of <claim-ref idref="CLM-00007">claim 7</claim-ref>, wherein the data packet is received from an internet exchange point.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00012" num="00012">
<div class="claim-text">12. The method of <claim-ref idref="CLM-00007">claim 7</claim-ref>, further comprising:
<div class="claim-text">establishing, using the first stack, a TCP connection; and</div>
<div class="claim-text">tearing down, using the first stack, the TCP connection.</div>
</div>
</div>
</div> <div class="claim"> <div class="claim" id="CLM-00013" num="00013">
<div class="claim-text">13. A digital processing system for processing data packets in at least one data network, comprising:
<div class="claim-text">a first stack for performing a first type of packet processing with a first number of processing steps on data packets received in the at least one network; and</div>
<div class="claim-text">a second stack for performing a second type of packet processing that comprises a second number of processing steps on data packets received in the at least one network;</div>
<div class="claim-text">wherein the second number of processing steps is less than the first number of processing steps, wherein the system receives packets and determines whether the received packets correspond to the first or second types of packet processing, wherein the system injects packets that correspond to the first type of packet processing into the first stack, wherein the system processes packets that correspond to the second type of packet processing according to the second stack, and wherein the data packets are transmitted from one or both of the first stack and the second stack to one or both of a first storage medium of a first type and a second storage medium of a second type via mediation.</div>
</div>
</div>
</div> </div>
</div>
</section>
                </article>
            </search-app>
        </body>
    </html>
    