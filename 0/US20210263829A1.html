
    <html>
        <body>
            <search-app>
                <article class="result" itemscope="" itemtype="http://schema.org/ScholarlyArticle">
    <h1 itemprop="pageTitle">US20210263829A1 - Virtualization of a central processing unit measurement facility 
      - Google Patents</h1><section itemprop="abstract" itemscope="">
<h2>Abstract</h2>
<div html="" itemprop="content"><abstract lang="EN" load-source="docdb" mxw-id="PA461850707" source="national office">
<div class="abstract">A central processing unit measurement facility is virtualized in order to support concurrent use of the facility by multiple guests executing within a virtual environment. Each guest of the environment has independent control over disablement/enablement of the facility for that guest.</div>
</abstract>
</div>
</section><section itemprop="description" itemscope="">
<h2>Description</h2>
<div html="" itemprop="content"><ul class="description" lang="EN" load-source="patent-office" mxw-id="PDES300533817">
<heading id="h-0001">TECHNICAL FIELD</heading>
<li> <para-num num="[0001]"> </para-num> <div class="description-line" id="p-0002" num="0001">This invention relates, in general, to measurement facilities, and in particular, to providing a virtualized measurement facility for a virtualized processing environment.</div>
</li> <heading id="h-0002">BACKGROUND OF THE INVENTION</heading>
<li> <para-num num="[0002]"> </para-num> <div class="description-line" id="p-0003" num="0002">Improved system performance and reduced errors are high priority goals of many processing environments, including those environments that support virtualization. In an effort to achieve these goals, diagnostic and tuning tools are employed. One such tool is a measurement facility that gathers data relating to processing that occurs within a processing environment.</div>
</li> <li> <para-num num="[0003]"> </para-num> <div class="description-line" id="p-0004" num="0003">Specifically, a measurement facility is used to accumulate activity counts of specific events that occur within the hardware (such as cycle count, instruction count, etc.) and/or to periodically take a snapshot of a central processing unit executing within the environment. The facility records state information associated with the central processing unit. This information is used for debugging and/or to improve system performance.</div>
</li> <li> <para-num num="[0004]"> </para-num> <div class="description-line" id="p-0005" num="0004">Today, at each measurement time, the data is collected, stored in a register, and an interrupt is provided to the control program. Upon interruption, the control program reads out the measurement data, resets the register and resumes the operation. This interruption at each measurement interval creates significant system overhead, and in some real-time environments, may even distort the measured data. This overhead problem causes users to limit the amount of measurement data to be collected, and thus, limit the practical use of the measurement facility.</div>
</li> <li> <para-num num="[0005]"> </para-num> <div class="description-line" id="p-0006" num="0005">Moreover, a problem exists in virtual environments because only one measurement facility is implemented in a central processing unit, but the facility may be shared by multiple guests. Such shared use can corrupt the collected data.</div>
</li> <heading id="h-0003">SUMMARY OF THE INVENTION</heading>
<li> <para-num num="[0006]"> </para-num> <div class="description-line" id="p-0007" num="0006">Based on the foregoing, a need exists for an enhanced measurement facility that is less disruptive and more effective than current measurement facilities. In particular, a need exists for a measurement facility that does not interrupt the control program at each sampling interval. Further, a need exists for a measurement facility that is virtualized in a flexible manner to support various configurations of a virtual environment, including concurrent execution of multiple guests. Moreover, a need exists for efficient virtualization of the facility so that it does not introduce too much system overhead, particularly when the measurement facility is not active on a particular CPU.</div>
</li> <li> <para-num num="[0007]"> </para-num> <div class="description-line" id="p-0008" num="0007">The shortcomings of the prior art are overcome and additional advantages are provided through the provision of a computer program product for managing a collection of data within a processing environment. The computer program product comprises a storage medium readable by a processing circuit and storing instructions for execution by a computer for performing a method. The method includes, for instance, controlling by one guest of the virtual processing environment enablement of measurement relating to activities of the one guest; controlling by another guest of the virtual processing environment enablement of measurement relating to activities of the another guest, wherein the controlling by the one guest is independent of the controlling by the another guest, and wherein measurement is concurrently enabled for the one guest and the another guest, or enabled for one of the one guest and the another guest and not for the other of the one guest and the another guest.</div>
</li> <li> <para-num num="[0008]"> </para-num> <div class="description-line" id="p-0009" num="0008">Methods and systems relating to one or more aspects of the present invention are also described and claimed herein. Further, services relating to one or more aspects of the present invention are also described and may be claimed herein.</div>
</li> <li> <para-num num="[0009]"> </para-num> <div class="description-line" id="p-0010" num="0009">Additional features and advantages are realized through the techniques of the present invention. Other embodiments and aspects of the invention are described in detail herein and are considered a part of the claimed invention.</div>
</li> <description-of-drawings>
<heading id="h-0004">BRIEF DESCRIPTION OF THE DRAWINGS</heading>
<li> <para-num num="[0010]"> </para-num> <div class="description-line" id="p-0011" num="0010">One or more aspects of the present invention are particularly pointed out and distinctly claimed as examples in the claims at the conclusion of the specification. The foregoing and other objects, features, and advantages of the invention are apparent from the following detailed description taken in conjunction with the accompanying drawings in which:</div>
</li> <li> <para-num num="[0011]"> </para-num> <div class="description-line" id="p-0012" num="0011"> <figref idrefs="DRAWINGS">FIG. 1</figref> depicts one embodiment of a processing environment to incorporate and use one or more aspects of the present invention;</div>
</li> <li> <para-num num="[0012]"> </para-num> <div class="description-line" id="p-0013" num="0012"> <figref idrefs="DRAWINGS">FIG. 2A</figref> depicts one example of various sampling control registers used in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0013]"> </para-num> <div class="description-line" id="p-0014" num="0013"> <figref idrefs="DRAWINGS">FIG. 2B</figref> depicts one example of the contents of a table entry address register of <figref idrefs="DRAWINGS">FIG. 2A</figref>, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0014]"> </para-num> <div class="description-line" id="p-0015" num="0014"> <figref idrefs="DRAWINGS">FIG. 2C</figref> depicts one example of the contents of a data entry address register of <figref idrefs="DRAWINGS">FIG. 2A</figref>, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0015]"> </para-num> <div class="description-line" id="p-0016" num="0015"> <figref idrefs="DRAWINGS">FIG. 2D</figref> depicts one embodiment of a format of a measurement authorization description bock, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0016]"> </para-num> <div class="description-line" id="p-0017" num="0016"> <figref idrefs="DRAWINGS">FIG. 2E</figref> depicts one embodiment of a format of a measurement enable description block, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0017]"> </para-num> <div class="description-line" id="p-0018" num="0017"> <figref idrefs="DRAWINGS">FIG. 2F</figref> depicts one embodiment of a format of a measurement activation description block, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0018]"> </para-num> <div class="description-line" id="p-0019" num="0018"> <figref idrefs="DRAWINGS">FIG. 2G</figref> depicts one embodiment of a format of a measurement block, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0019]"> </para-num> <div class="description-line" id="p-0020" num="0019"> <figref idrefs="DRAWINGS">FIG. 2H</figref> depicts one embodiment of the fields of a sampling control block of the measurement block depicted in <figref idrefs="DRAWINGS">FIG. 2G</figref>, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0020]"> </para-num> <div class="description-line" id="p-0021" num="0020"> <figref idrefs="DRAWINGS">FIG. 3</figref> depicts one embodiment of the structure of a sampling buffer used in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0021]"> </para-num> <div class="description-line" id="p-0022" num="0021"> <figref idrefs="DRAWINGS">FIG. 4A</figref> depicts one embodiment of the fields of a basic sampling data entry, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0022]"> </para-num> <div class="description-line" id="p-0023" num="0022"> <figref idrefs="DRAWINGS">FIG. 4B</figref> depicts one embodiment of the fields of a diagnostic sampling data entry, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0023]"> </para-num> <div class="description-line" id="p-0024" num="0023"> <figref idrefs="DRAWINGS">FIG. 4C</figref> depicts one embodiment of the fields of a trailer entry, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0024]"> </para-num> <div class="description-line" id="p-0025" num="0024"> <figref idrefs="DRAWINGS">FIGS. 5A-5B</figref> depict one embodiment of the logic associated with updating a sampling buffer, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0025]"> </para-num> <div class="description-line" id="p-0026" num="0025"> <figref idrefs="DRAWINGS">FIG. 5C</figref> depicts one embodiment of the logic associated with providing an interrupt to read the collected data from the buffer, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0026]"> </para-num> <div class="description-line" id="p-0027" num="0026"> <figref idrefs="DRAWINGS">FIGS. 6A-6B</figref> depict one embodiment of an overview of the logic associated with performing a sampling function, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0027]"> </para-num> <div class="description-line" id="p-0028" num="0027"> <figref idrefs="DRAWINGS">FIG. 6C</figref> depicts one embodiment of the logic used to determine if measurement is authorized when a guest is re-dispatched, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0028]"> </para-num> <div class="description-line" id="p-0029" num="0028"> <figref idrefs="DRAWINGS">FIG. 7A</figref> depicts one embodiment of the logic associated with processing performed asynchronous to execution of the sampling facility to enable the storing of identifiers with the collected data, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0029]"> </para-num> <div class="description-line" id="p-0030" num="0029"> <figref idrefs="DRAWINGS">FIG. 7B</figref> depicts one example of a format of a Set Program Parameters instruction used in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0030]"> </para-num> <div class="description-line" id="p-0031" num="0030"> <figref idrefs="DRAWINGS">FIG. 8A</figref> depicts one embodiment of a format of a Query Sampling Information instruction used in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0031]"> </para-num> <div class="description-line" id="p-0032" num="0031"> <figref idrefs="DRAWINGS">FIG. 8B</figref> depicts one embodiment of the fields associated with an information block associated with the Query Sampling Information instruction, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0032]"> </para-num> <div class="description-line" id="p-0033" num="0032"> <figref idrefs="DRAWINGS">FIG. 8C</figref> depicts one embodiment of a format of a Query Counter Information instruction used in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0033]"> </para-num> <div class="description-line" id="p-0034" num="0033"> <figref idrefs="DRAWINGS">FIG. 8D</figref> depicts one embodiment of the fields associated with an information block associated with the Query Counter Information instruction, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0034]"> </para-num> <div class="description-line" id="p-0035" num="0034"> <figref idrefs="DRAWINGS">FIG. 9A</figref> depicts one embodiment of a format of a Set Sampling Controls instruction used in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0035]"> </para-num> <div class="description-line" id="p-0036" num="0035"> <figref idrefs="DRAWINGS">FIG. 9B</figref> depicts one embodiment of a request block associated with the Set Sampling Controls instruction, in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0036]"> </para-num> <div class="description-line" id="p-0037" num="0036"> <figref idrefs="DRAWINGS">FIG. 9C</figref> depicts one embodiment of a format of a Set CPU Counter Set Controls instruction used in accordance with an aspect of the present invention;</div>
</li> <li> <para-num num="[0037]"> </para-num> <div class="description-line" id="p-0038" num="0037"> <figref idrefs="DRAWINGS">FIGS. 10A-10B</figref> depict one embodiment of the logic to deploy measurement logic on one or more processing units, in accordance with an aspect of the present invention; and</div>
</li> <li> <para-num num="[0038]"> </para-num> <div class="description-line" id="p-0039" num="0038"> <figref idrefs="DRAWINGS">FIG. 11</figref> depicts one embodiment of a computer program product incorporating one or more aspects of the present invention.</div>
</li> </description-of-drawings>
<heading id="h-0005">DETAILED DESCRIPTION OF THE INVENTION</heading>
<li> <para-num num="[0039]"> </para-num> <div class="description-line" id="p-0040" num="0039">In accordance with an aspect of the present invention, a CPU measurement facility is provided that measures activities of the central processing unit or shared peripheral processor on which it is executing (counter facility) and/or takes a snapshot of the central processing unit at specified sampling intervals to collect data regarding tasks (e.g., applications, modules, functions, instructions, etc.) executing on the central processing unit (sampling facility). This data is collected for statistical estimation of performance characteristics. The collected sampling data is stored in a buffer and at selected times, an interrupt is provided to remove data from the buffer to enable reuse thereof. The interrupt is not taken after each sample, but in sufficient time to remove data and minimize data loss.</div>
</li> <li> <para-num num="[0040]"> </para-num> <div class="description-line" id="p-0041" num="0040">In a further aspect of the present invention, the CPU measurement facility is virtualized in order to support concurrent use of the facility by multiple guests executing within a virtual environment. As an example, the measurement facility is virtualized such that a guest can independently control enablement/disablement of measurement, and multiple guests can be concurrently sampling and/or measuring activities (via, for instance, counters). In one particular example, each logical processor assigned to a guest is capable of executing the measurement facility.</div>
</li> <li> <para-num num="[0041]"> </para-num> <div class="description-line" id="p-0042" num="0041">One embodiment of a processing environment incorporating and using one or more aspects of the present invention is described with reference to <figref idrefs="DRAWINGS">FIG. 1</figref>. In one example, a processing environment 100 is based, for instance, on the z/Architecture® offered by International Business Machines Corporation, Armonk, N.Y. The z/Architecture is described in a publication entitled, “z/Architecture Principles of Operation,” IBM® Publication No. SA22-7832-06, Seventh Edition, February 2008, which is hereby incorporated herein by reference in its entirety. (z/Architecture® and IBM® are registered trademarks of International Business Machines Corporation, Armonk, N.Y., U.S.A. Other names used herein may be registered trademarks, trademarks or product names of International Business Machines Corporation or other companies.) In one example, a processing environment based on the z/Architecture® includes an eServer zSeries, offered by International Business Machines Corporation, Armonk, N.Y.</div>
</li> <li> <para-num num="[0042]"> </para-num> <div class="description-line" id="p-0043" num="0042">In this example, processing environment <b>100</b> includes a central processor complex (CPC) <b>102</b>. Central processor complex <b>102</b> includes, for instance, one or more partitions or zones <b>104</b> (e.g., logical partitions LP<b>1</b>-LPn), one or more central processors <b>106</b> (e.g., CP<b>1</b>-CPm), and a hypervisor <b>108</b> (e.g., a logical partition manager), each of which is described below.</div>
</li> <li> <para-num num="[0043]"> </para-num> <div class="description-line" id="p-0044" num="0043">Each logical partition <b>104</b> is capable of functioning as a separate system. That is, each logical partition can be independently reset, initially loaded with an operating system, if desired, and operate with different programs. An operating system or application program running in a logical partition appears to have access to a full and complete system, but only a portion of it is available. A combination of hardware and Licensed Internal Code (also referred to as microcode or millicode) keeps a program in a logical partition from interfering with a program in a different logical partition. This allows several different logical partitions to operate on a single or multiple physical processors in a time sliced manner. In this particular example, each logical partition has a resident operating system <b>110</b>, which may differ for one or more logical partitions. In one embodiment, operating system <b>110</b> is the z/OS® or z/Linux operating system, offered by International Business Machines Corporation, Armonk, N.Y. z/OS® is a registered trademark of International Business Machines Corporation.</div>
</li> <li> <para-num num="[0044]"> </para-num> <div class="description-line" id="p-0045" num="0044">Central processors <b>106</b> are physical processor resources that are allocated to the logical partitions. For instance, a logical partition <b>104</b> includes one or more logical processors <b>112</b>, each of which represents all or a share of a physical processor resource <b>106</b> allocated to the partition. The underlying processor resource may either be dedicated for that partition or shared with another partition.</div>
</li> <li> <para-num num="[0045]"> </para-num> <div class="description-line" id="p-0046" num="0045">Logical partitions <b>104</b> are managed by hypervisor <b>108</b> implemented by firmware running on processors <b>106</b>. Logical partitions <b>104</b> and hypervisor <b>108</b> each comprise one or more programs residing in respective portions of central storage associated with the central processors. One example of hypervisor <b>108</b> is the Processor Resource/Systems Manager (PRISM), offered by International Business Machines Corporation, Armonk, N.Y.</div>
</li> <li> <para-num num="[0046]"> </para-num> <div class="description-line" id="p-0047" num="0046">To provide information to facilitate processing within the processing environment, data is gathered on a regular basis. This data is used, for instance, for debugging purposes and/or to improve system performance. In a virtual processing environment, a measurement function (e.g., counters and/or sampling) <b>114</b> is executed on one or more logical processors <b>112</b>. For each logical processor on which it is executing, it accumulates activity counts of specific events that occur within the hardware (such as cycle count, instruction count, etc.) (counters), and/or provides a snapshot of the logical processor at each specified sampling interval, which is a processing time interval as seen by the processor (sampling). Each snapshot produces a set of sample data, which includes, for instance, the instruction address of an instruction being executed and some state information about the logical processor. This sample data is stored, for instance, in one or more sample data blocks of a buffer.</div>
</li> <li> <para-num num="[0047]"> </para-num> <div class="description-line" id="p-0048" num="0047">Similarly, in a processing environment that is not supporting virtualization (referred to herein as a non-virtual environment), a measurement function is executed on one or more physical CPUs and for each CPU on which it is executing, it accumulates activity counts of specific events that occur within the hardware (such as cycle count, instruction count, etc.), and/or provides a snapshot of the CPU at each specified sampling interval. One embodiment of a measurement facility for a non-virtual environment is described herein, as well as in U.S. Ser. No. ______ entitled “Central Processing Unit Measurement Facility,” Bartik, et al., filed herewith, (POU920080207US1), which is hereby incorporated herein by reference in its entirety.</div>
</li> <li> <para-num num="[0048]"> </para-num> <div class="description-line" id="p-0049" num="0048">In describing the measurement facility, reference is made to the CPU. For a non-virtual environment, the CPU is the physical CPU. However, for a virtual environment, the CPU is a logical CPU (a.k.a., logical processor) assigned to a guest. Since a physical CPU may be shared among a plurality of guests in a virtual environment, state information and controls associated with measurement are maintained for each logical processor. Thus, in the discussion that follows, the controls are described, and then any additions or changes for the virtual environment are provided. Further, both the counter facility and sampling facility of the measurement facility are described.</div>
</li> <li> <para-num num="[0049]"> </para-num> <div class="description-line" id="p-0050" num="0049">The CPU measurement counter facility includes, for instance, four counter sets, each having multiple counters; a local counter state control register; several external interruption events; and various instructions, including, for instance, a Query Counter Information instruction and a Set CPU Counter Set Controls instruction, described below.</div>
</li> <li> <para-num num="[0050]"> </para-num> <div class="description-line" id="p-0051" num="0050">In one example, the CPU counter sets include a basic counter set, a problem state counter state, a crypto-activity counter set and an extended counter set, each of which includes a plurality of counters incremented for the specific activities of the CPU, when the CPU is in the operating state and the counter set is active.</div>
</li> <li> <para-num num="[0051]"> </para-num> <div class="description-line" id="p-0052" num="0051">On each CPU, the CPU measurement counter facility provides a local counter state control register, which includes, for instance, a one bit authorization control, a one bit enable control, and a one bit activation control for each CPU counter set. It also includes a one bit authorization control for coprocessor group counter sets. Except for authorization controls, the contents of the local counter state control register are cleared by zeros by initial CPU reset, clear reset, or power-on reset. Authorization controls are set or reset by an external means.</div>
</li> <li> <para-num num="[0052]"> </para-num> <div class="description-line" id="p-0053" num="0052">The external interruption events include a counter authorization change alert and a loss of counter data alert.</div>
</li> <li> <para-num num="[0053]"> </para-num> <div class="description-line" id="p-0054" num="0053">In one example, the CPU measurement sampling facility includes two sampling functions, several sampling control registers, several external interruption events and various instructions, each of which is described below.</div>
</li> <li> <para-num num="[0054]"> </para-num> <div class="description-line" id="p-0055" num="0054">The two sampling functions include, for instance, basic sampling and diagnostic sampling. The basic sampling function provides a set of architected sample data. The sample data includes an instruction address, the primary address space number (PASN), and some state information about the CPU, as examples. This allows tooling programs to map instruction addresses into modules or tasks, and facilitates determination of hot spots. The diagnostic sampling function provides a set of non-architected sample data, and is intended for use by hardware design analysts, operating systems, sophisticated compilers, and internal subsystems. Since the sample data provided by the diagnostic sampling function may reveal detailed internal hardware design, a console with a controlled password may be used to authorize use of the function.</div>
</li> <li> <para-num num="[0055]"> </para-num> <div class="description-line" id="p-0056" num="0055">Both the basic sampling and diagnostic sampling functions use the same sampling control registers, the same sampling buffer structure, the same external interruption events, and the same instructions. The main difference between these two functions is the sample data.</div>
</li> <li> <para-num num="[0056]"> </para-num> <div class="description-line" id="p-0057" num="0056">The sample data size and format for each sampling function are model dependent and are determined by, for instance, a 16-bit data entry format code, which is stored in each sample data. The sample data provided by the basic sampling function is not included in the sample data provided by the diagnostic sampling function. To get meaningful diagnostic sampling data, both sampling functions should be activated. The state of each sampling function can be individually set by executing a Set Sampling Controls instruction, which is described below. Both sampling functions are disabled by initial CPU reset, clear reset or power-on reset.</div>
</li> <li> <para-num num="[0057]"> </para-num> <div class="description-line" id="p-0058" num="0057">In one example, the external interruption events include an invalid entry address alert, an incorrect sample data block table entry alert, a program request alert, a sampling authorization change alert, and a loss of sample data alert. These events are part of an external interruption subclass, called the measurement alert subclass. The subclass mask bit, e.g., bit <b>58</b> of control register zero, is provided. This bit is initialized to one, which enables the interruption.</div>
</li> <li> <para-num num="[0058]"> </para-num> <div class="description-line" id="p-0059" num="0058">The CPU measurement sampling facility provides a number of sampling control registers. Except for authorization controls, the contents of these control registers are cleared to zeros by initial CPU reset, clear reset or power-on reset; and may also be cleared to zeros by executing the Set Sampling Control instruction that disables all sampling functions. Authorization controls are set or reset by an external means.</div>
</li> <li> <para-num num="[0059]"> </para-num> <div class="description-line" id="p-0060" num="0059">Examples of sampling control registers are described with reference to <figref idrefs="DRAWINGS">FIG. 2A</figref>. In one example, these registers are hardware registers within the CPU. As shown, sampling control registers <b>200</b> include, for instance, a table entry address register (TEAR) <b>202</b>; a data entry address register (DEAR) <b>204</b>; a maximum buffer size indicator <b>206</b>; a sampling function state control register <b>208</b>; a sampling interval register <b>210</b>; and a host indicator <b>212</b>, each of which is described below.</div>
</li> <li> <para-num num="[0060]"> </para-num> <div class="description-line" id="p-0061" num="0060">As shown in <figref idrefs="DRAWINGS">FIG. 2B</figref>, table entry address register <b>202</b> is, for instance, 64 bits, and includes, an address of a current sample data block table entry <b>220</b>. It is unpredictable whether the address is real or absolute.</div>
</li> <li> <para-num num="[0061]"> </para-num> <div class="description-line" id="p-0062" num="0061">Referring to <figref idrefs="DRAWINGS">FIG. 2C</figref>, data entry address register <b>204</b> is, for instance, 64 bits, and includes an address of the next sample data block data entry <b>230</b>. Again, it is unpredictable whether the address is real or absolute.</div>
</li> <li> <para-num num="[0062]"> </para-num> <div class="description-line" id="p-0063" num="0062">In one example, maximum buffer size indicator <b>206</b> is one bit. When the indicator is zero, the maximum size of the sample data block tables and the size of the sample data blocks are 4K bytes. When the indicator is one, the maximum size of the sample data block tables and the size of the sample data blocks are 1M bytes.</div>
</li> <li> <para-num num="[0063]"> </para-num> <div class="description-line" id="p-0064" num="0063">Sampling function state control register <b>208</b> is, for instance, 6 bits, and three bits are assigned to the basic sampling function and the other three bits are assigned to the diagnostic sampling function. For each sampling function, there are, for instance, three state control indicators, including: authorization control (A), enable control (E), and activation control (C).</div>
</li> <li> <para-num num="[0064]"> </para-num> <div class="description-line" id="p-0065" num="0064">Sampling interval register <b>210</b> is, for instance, 64 bits, and the contents of the register specify the number of CPU cycles within each sampling interval.</div>
</li> <li> <para-num num="[0065]"> </para-num> <div class="description-line" id="p-0066" num="0065">Host indicator <b>212</b> is, for instance, one bit and is available to CPUs at the logical partition level. When the CPU is running at the logical partition level and if a sampling function is active, the host indicator when zero specifies that the contents of the program parameter register are stored into the guest program parameter field of the sample data blocks by the sample data block update process; the host indicator, when one, specifies that the contents of the program parameter register are stored into the host program parameter field.</div>
</li> <li> <para-num num="[0066]"> </para-num> <div class="description-line" id="p-0067" num="0066">When the CPU is in the operating state, each counter set or sampling function can be in any of the following four states, as examples: unauthorized, disabled, inactive, and active.</div>
</li> <li> <para-num num="[0067]"> </para-num> <div class="description-line" id="p-0068" num="0067">Unauthorized: When a counter set is in the unauthorized state, counters cannot be used and do not increment. When a sampling function is in the unauthorized state, the function cannot be used and no sample data is stored. An external means is provided to authorize or unauthorize the use of these functions.</div>
</li> <li> <para-num num="[0068]"> </para-num> <div class="description-line" id="p-0069" num="0068">Disabled: When a counter set or sampling function is in the disabled state, the counter set or sampling function is authorized for use, but the program has not enabled the counter set or sampling function. When a counter set is in this state, counters in the counter set do not increment and the counter contents cannot be extracted or set. When a sampling function is in this state, the function is authorized for use, but the control program has not enabled the function yet. In this state, no new sample data is stored, and the contents of the sample data blocks remain unchanged, and no sampling control, except for authorization controls, is preserved.</div>
</li> <li> <para-num num="[0069]"> </para-num> <div class="description-line" id="p-0070" num="0069">Inactive: When a counter set or sampling function is in the inactive state, the counter set or sampling function is authorized, enabled, and deactivated. When a counter set is in this state, counters in the counter set do not increment; the counter contents remain unchanged and can be extracted or set. When a sampling function is in this state, no new sample data is stored, the contents of the sample data blocks remain unchanged, and sampling controls are preserved and can be extracted.</div>
</li> <li> <para-num num="[0070]"> </para-num> <div class="description-line" id="p-0071" num="0070">Active: When a counter set or sampling function is in the active state, the counter set or sampling function is authorized, enabled and activated. When a counter set is in this state, each counter in the set increments for the defined activity; the counter contents can be extracted or set. When a sampling function is in this state, the function is authorized, enabled, and activated. In this state, new sampling data is stored during each sampling interval and sampling controls can be extracted.</div>
</li> <li> <para-num num="[0071]"> </para-num> <div class="description-line" id="p-0072" num="0071">When the CPU enters the stopped state from the operating state, active counter sets and sampling functions are stopped. When the CPU enters the operating state from the stopped state, counter sets and sampling functions resume the states they were in when they were last stopped.</div>
</li> <li> <para-num num="[0072]"> </para-num> <div class="description-line" id="p-0073" num="0072">The following table summarizes actions that cause state transitions of a counter set:</div>
</li> <li> <div class="description-line" id="p-0074" num="0000">
<tables id="TABLE-US-00001" num="00001">
<patent-tables colsep="0" frame="none" rowsep="0">
<table align="left" class="description-table" cols="2" colsep="0" rowsep="0" width="100%">
<tbody><tr class="description-tr">
<td align="center" class="description-td" colspan="2" nameend="2" namest="1" rowsep="1"> </td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td">To</td>
</tr>
</tbody></table>
<table align="left" class="description-table" cols="5" colsep="0" rowsep="0" width="100%">
<tbody><tr class="description-tr">
<td class="description-td">From</td>
<td class="description-td">Unauthorized</td>
<td class="description-td">Disabled</td>
<td class="description-td">Inactive</td>
<td class="description-td">Active</td>
</tr>
<tr class="description-tr">
<td align="center" class="description-td" colspan="5" nameend="5" namest="1" rowsep="1"> </td>
</tr>
<tr class="description-tr">
<td class="description-td">Unauthorized</td>
<td class="description-td">—*</td>
<td class="description-td">External</td>
<td class="description-td">Not applicable</td>
<td class="description-td">Not applicable</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">control</td>
<td class="description-td">for CPU</td>
<td class="description-td">for CPU</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">counter sets;</td>
<td class="description-td">counter sets;</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">external</td>
<td class="description-td">external</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">control for</td>
<td class="description-td">control for</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">coprocessor</td>
<td class="description-td">coprocessor</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">group counter</td>
<td class="description-td">group counter</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">sets.</td>
<td class="description-td">sets.</td>
</tr>
<tr class="description-tr">
<td class="description-td">Disabled</td>
<td class="description-td">External</td>
<td class="description-td">—*</td>
<td class="description-td">Enabled &amp;</td>
<td class="description-td">Enabled &amp;</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td">control</td>
<td class="description-td"> </td>
<td class="description-td">deactivated by</td>
<td class="description-td">activated by</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">SCCTL.</td>
<td class="description-td">SCCTL.</td>
</tr>
<tr class="description-tr">
<td class="description-td">Inactive</td>
<td class="description-td">External</td>
<td class="description-td">Disabled by</td>
<td class="description-td">—*</td>
<td class="description-td">Activated by</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td">control</td>
<td class="description-td">SCCTL or by</td>
<td class="description-td"> </td>
<td class="description-td">SCCTL.</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">reset<sup>1</sup>.</td>
<td class="description-td"> </td>
<td class="description-td"> </td>
</tr>
<tr class="description-tr">
<td class="description-td">Active</td>
<td class="description-td">External</td>
<td class="description-td">Disabled by</td>
<td class="description-td">Deactivated by</td>
<td class="description-td">—*</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td">control</td>
<td class="description-td">SCCTL or</td>
<td class="description-td">SCCTL or by</td>
<td class="description-td"> </td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">reset<sup>1</sup>.</td>
<td class="description-td">errors<sup>2</sup>.</td>
</tr>
<tr class="description-tr">
<td align="center" class="description-td" colspan="5" nameend="5" namest="1" rowsep="1"> </td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00001" nameend="5" namest="1">Explanation:</td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00002" nameend="5" namest="1"> <sup>1</sup>All CPU counter sets are disabled and contents in these sets are cleared to zeros by initial CPU reset, clear reset, or power-on reset.</td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00003" nameend="5" namest="1"> <sup>2</sup>Each active counter set is deactivated by a loss of counter data alert.</td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00004" nameend="5" namest="1">*When a counter set is in the unauthorized, disabled, inactive, or active state, if execution of SCCTL sets the state controls to the same state as the original state, the state controls are considered successfully set.</td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00005" nameend="5" namest="1">—No action required.</td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00006" nameend="5" namest="1">SCCTL The SET CPU COUNTER SET CONTROLS instruction.</td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00007" nameend="5" namest="1">Not applicable This state transition cannot occur.</td>
</tr>
</tbody></table>
</patent-tables>
</tables>
</div>
</li> <li> <para-num num="[0073]"> </para-num> <div class="description-line" id="p-0075" num="0073">The following table summarizes actions that cause state transitions of a sampling function:</div>
</li> <li> <div class="description-line" id="p-0076" num="0000">
<tables id="TABLE-US-00002" num="00002">
<patent-tables colsep="0" frame="none" rowsep="0">
<table align="left" class="description-table" cols="2" colsep="0" rowsep="0" width="100%">
<tbody><tr class="description-tr">
<td align="center" class="description-td" colspan="2" nameend="2" namest="1" rowsep="1"> </td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td">To</td>
</tr>
</tbody></table>
<table align="left" class="description-table" cols="5" colsep="0" rowsep="0" width="100%">
<tbody><tr class="description-tr">
<td class="description-td">From</td>
<td class="description-td">Unauthorized</td>
<td class="description-td">Disabled</td>
<td class="description-td">Inactive</td>
<td class="description-td">Active</td>
</tr>
<tr class="description-tr">
<td align="center" class="description-td" colspan="5" nameend="5" namest="1" rowsep="1"> </td>
</tr>
<tr class="description-tr">
<td class="description-td">Unauthorized</td>
<td class="description-td">—*</td>
<td class="description-td">External </td>
<td class="description-td">Not </td>
<td class="description-td">Not </td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">control</td>
<td class="description-td">applicable</td>
<td class="description-td">applicable</td>
</tr>
<tr class="description-tr">
<td class="description-td">Disabled</td>
<td class="description-td">External </td>
<td class="description-td">—*</td>
<td class="description-td">Enabled &amp;</td>
<td class="description-td">Enabled &amp;</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td">control</td>
<td class="description-td"> </td>
<td class="description-td">deactivated by</td>
<td class="description-td">activated by</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">SSCTL.</td>
<td class="description-td">SSCTL.</td>
</tr>
<tr class="description-tr">
<td class="description-td">Inactive</td>
<td class="description-td">External </td>
<td class="description-td">Disabled by</td>
<td class="description-td">—*</td>
<td class="description-td">Activated by</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td">control</td>
<td class="description-td">SSCTL, or by</td>
<td class="description-td"> </td>
<td class="description-td">SSCTL.</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">reset<sup>1</sup>.</td>
<td class="description-td"> </td>
<td class="description-td"> </td>
</tr>
<tr class="description-tr">
<td class="description-td">Active</td>
<td class="description-td">External </td>
<td class="description-td">Disabled by</td>
<td class="description-td">Deactivated by</td>
<td class="description-td">—*</td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td">control</td>
<td class="description-td">SSCTL, or</td>
<td class="description-td">SSCTL or by</td>
<td class="description-td"> </td>
</tr>
<tr class="description-tr">
<td class="description-td"> </td>
<td class="description-td"> </td>
<td class="description-td">reset<sup>1</sup>.</td>
<td class="description-td">errors<sup>2</sup>.</td>
</tr>
<tr class="description-tr">
<td align="center" class="description-td" colspan="5" nameend="5" namest="1" rowsep="1"> </td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00008" nameend="5" namest="1">Explanation:</td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00009" nameend="5" namest="1"> <sup>1</sup>Each enabled sampling function is disabled by initial CPU reset, clear reset or power-on reset.</td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00010" nameend="5" namest="1"> <sup>2</sup>Each active sampling function is deactivated by an invalid entry address alert, an incorrect sample data block table entry alert, or a loss of sample data alert.</td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00011" nameend="5" namest="1">*When a sampling function is in the unauthorized, disabled, inactive, or active state, if execution of SSCTL sets the state controls to the same state as the original state, the state controls are considered successfully set.</td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00012" nameend="5" namest="1">—No action required.</td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00013" nameend="5" namest="1">SSCTL The SET SAMPLING CONTROLS instruction.</td>
</tr>
<tr class="description-tr">
<td align="left" class="description-td" colspan="5" id="FOO-00014" nameend="5" namest="1">Not applicable This state transition cannot occur.</td>
</tr>
</tbody></table>
</patent-tables>
</tables>
</div>
</li> <li> <para-num num="[0074]"> </para-num> <div class="description-line" id="p-0077" num="0074">In a virtual environment, the authorization, enable and activation indicators are maintained in a state description (e.g., a control block associated with each guest or logical processor). For instance, stored within the state description for each logical processor is a set of control blocks used to maintain this information. Examples of these control blocks are described with reference to <figref idrefs="DRAWINGS">FIGS. 2D-2H</figref>.</div>
</li> <li> <para-num num="[0075]"> </para-num> <div class="description-line" id="p-0078" num="0075">Referring to <figref idrefs="DRAWINGS">FIG. 2D</figref>, a measurement authorization description (MAD) control block <b>240</b> is used to control whether the guest is allowed to use each specified measurement function. These functions include functions of the counter and sampling facilities of the measurement facility. In one example, measurement authorization description <b>240</b> includes the following controls:
</div> </li> <ul> <li id="ul0001-0001" num="0000"> <ul> <li id="ul0002-0001" num="0076">A<sub>g </sub> <b>242</b>: Coprocessor group counter sets authorization control—When A<sub>g </sub>is one, the guest is authorized to use the coprocessor group counter sets; when A<sub>g </sub>is zero, the guest is not authorized to use the counter sets.</li> <li id="ul0002-0002" num="0077">When the coprocessor group counter set is authorized, the counters are incremented for specific activities when the counter set is active.</li> <li id="ul0002-0003" num="0078">A<sub>s </sub> <b>244</b>: Basic sampling authorization control—When A<sub>s </sub>is one, the guest is authorized to use the basic sampling function; when A<sub>s </sub>is zero, the guest is not authorized to use the sampling function.</li> <li id="ul0002-0004" num="0079">A<sub>d </sub> <b>245</b>: Diagnostic sampling authorization control—When A<sub>d </sub>is one, the guest is authorized to use the diagnostic sampling function; when A<sub>d </sub>is zero, the guest is not authorized to use the diagnostic sampling function.</li> <li id="ul0002-0005" num="0080">A<sub>c </sub> <b>246</b>: Crypto-activity counter set authorization control—When A<sub>c </sub>is one, the guest is authorized to use the crypto-activity counter set; when A<sub>c </sub>is zero, the guest is not authorized to use the counter set.</li> <li id="ul0002-0006" num="0081">A<sub>p </sub> <b>247</b>: Problem state counter set authorization control—When A<sub>p </sub>is one, the guest is authorized to use the problem state counter set; when A<sub>p </sub>is zero, the guest is not authorized to use the counter set.</li> <li id="ul0002-0007" num="0082">A<sub>b </sub> <b>248</b>: Basic counter set authorization control—When A<sub>b </sub>is one, the guest is authorized to use the basic counter set; when A<sub>b </sub>is zero, the guest is not authorized to use the counter set.</li> <li id="ul0002-0008" num="0083">A<sub>e </sub> <b>249</b>: Extended counter set authorization control—When A<sub>e </sub>is one, the guest is authorized to use the extended counter set; when A<sub>e </sub>is zero, the guest is not authorized to use the counter set.</li> </ul> </li> </ul>
<li> <para-num num="[0084]"> </para-num> <div class="description-line" id="p-0079" num="0084">Another control block used is a measurement enable description (MED) block <b>250</b> (<figref idrefs="DRAWINGS">FIG. 2E</figref>), which specifies whether the guest has enabled each counter set and each sampling function. The following defines the status, in one example:
</div> </li> <ul> <li id="ul0003-0001" num="0000"> <ul> <li id="ul0004-0001" num="0085">E<sub>s </sub> <b>252</b>: Basic sampling enable control—When E<sub>s </sub>is one, the basic sampling function is enabled; when E<sub>s </sub>is zero, the basic sampling function is not enabled.</li> <li id="ul0004-0002" num="0086">E<sub>d </sub> <b>254</b>: Diagnostic sampling enable control—When E<sub>d </sub>is one, the diagnostic sampling function is enabled; when E<sub>d </sub>is zero, the diagnostic sampling function is not enabled.</li> <li id="ul0004-0003" num="0087">E<sub>e </sub> <b>256</b>: Crypto-activity counter set enable control—When E<sub>e </sub>is one, the crypto-activity counter set is enabled; when E<sub>e </sub>is zero, the counter set is not enabled.</li> <li id="ul0004-0004" num="0088">E<sub>p </sub> <b>257</b>: Problem state counter set enable control—When E<sub>p </sub>is one, the problem state counter set is enabled; when E<sub>p </sub>is zero, the counter set is not enabled.</li> <li id="ul0004-0005" num="0089">E<sub>b </sub> <b>258</b>: Basic counter set enable control—When E<sub>b </sub>is one, the basic counter set is enabled; when E<sub>b </sub>is zero, the counter set is not enabled.</li> <li id="ul0004-0006" num="0090">E<sub>e </sub> <b>259</b>: Extended counter set enable control—When E<sub>e </sub>is one, the extended counter set is enabled; when E<sub>e </sub>is zero, the counter set is not enabled.</li> </ul> </li> </ul>
<li> <para-num num="[0091]"> </para-num> <div class="description-line" id="p-0080" num="0091">A further control block employed is a measurement activation description (MCD) control block <b>260</b> (<figref idrefs="DRAWINGS">FIG. 2F</figref>), which specifies whether the guest activated each counter set and each sampling function. The following defines the controls, in one example:
</div> </li> <ul> <li id="ul0005-0001" num="0000"> <ul> <li id="ul0006-0001" num="0092">C<sub>s </sub> <b>261</b>: Basic sampling activation control—When C<sub>s </sub>is one, the basic sampling function is active, when C<sub>s </sub>is zero, the basic sampling function is not active.</li> <li id="ul0006-0002" num="0093">C<sub>d </sub> <b>262</b>: Diagnostic sampling activation control—When C<sub>d </sub>is one, the diagnostic sampling function is active; when C<sub>d </sub>is zero, the diagnostic sampling function is not active.</li> <li id="ul0006-0003" num="0094">C<sub>c </sub> <b>263</b>: Crypto-activity counter set activation control—When C<sub>c </sub>is one, the crypto-activity counter set is active; when C<sub>c </sub>is zero, the counter set is not active.</li> <li id="ul0006-0004" num="0095">When the crypto-activity counter set is active, the counters count the specified activities of a coprocessor group contributed by this logical CPU.</li> <li id="ul0006-0005" num="0096">C<sub>p </sub> <b>265</b>: Problem state counter set activation control—When C<sub>p </sub>is one, the problem state counter set is active; when C<sub>p </sub>is zero, the counter set is not active.</li> <li id="ul0006-0006" num="0097">When the problem state counter set is active, the counters count the specified activities when the CPU is in the problem state.</li> <li id="ul0006-0007" num="0098">C<sub>b </sub> <b>267</b>: Basic counter set activation control—When C<sub>b </sub>is one, the basic counter set is active; when C<sub>b </sub>is zero, the counter set is not active.</li> <li id="ul0006-0008" num="0099">When the basic counter set is active, the counters count the specified activities, regardless of whether the CPU is in the problem state or the supervisor state.</li> <li id="ul0006-0009" num="0100">C<sub>e </sub> <b>269</b>: Extended counter set activation control—When C<sub>e </sub>is one, the extended counter set is active; when C<sub>e </sub>is zero, the counter set is not active.</li> <li id="ul0006-0010" num="0101">When the extended counter set is active, the number and meaning of the counters are model dependent.</li> </ul> </li> </ul>
<li> <para-num num="[0102]"> </para-num> <div class="description-line" id="p-0081" num="0102">Further, a pending interruption parameter (PIP) of the state description includes the sources for the pending measurement alert external interruption, and is in the format of the external interruption parameter in the guest prefix area.</div>
</li> <li> <para-num num="[0103]"> </para-num> <div class="description-line" id="p-0082" num="0103">Moreover, a measurement block designation (MBD) of specified bytes of the state description includes an address that designates the origin of a measurement block in host real storage.</div>
</li> <li> <para-num num="[0104]"> </para-num> <div class="description-line" id="p-0083" num="0104">One example of a format of the measurement block is depicted in <figref idrefs="DRAWINGS">FIG. 2G</figref> and described below. The counters in each counter set are stored in the ascending order of the counter number, starting at the origin of the field assigned to the counter set.</div>
</li> <li> <para-num num="[0105]"> </para-num> <div class="description-line" id="p-0084" num="0105">Any access exception occurred during access to the measurement block is reported by means of a validity interception.</div>
</li> <li> <para-num num="[0106]"> </para-num> <div class="description-line" id="p-0085" num="0106">As one example, a measurement block <b>280</b> includes, for instance:
</div> </li> <ul> <li id="ul0007-0001" num="0000"> <ul> <li id="ul0008-0001" num="0107">Basic Counter Set <b>282</b>;</li> <li id="ul0008-0002" num="0108">Problem State Counter Set <b>284</b>;</li> <li id="ul0008-0003" num="0109">Crypto-Activity Counter Set <b>286</b>;</li> <li id="ul0008-0004" num="0110">Extended Counter Set <b>288</b>;</li> <li id="ul0008-0005" num="0111">Sampling Control Block <b>290</b>: The sampling control block is 128 bytes, and includes some of the guest sampling control registers and additional control information. One example of a format of the sampling control block is described with reference to <figref idrefs="DRAWINGS">FIG. 2H</figref>.</li> <li id="ul0008-0006" num="0112">In one example, sampling control block <b>290</b> includes, for instance:</li> <li id="ul0008-0007" num="0113">Maximum Buffer Size Indicator (S) <b>292</b>: This indicator includes the maximum buffer size indicator.</li> <li id="ul0008-0008" num="0114">Host Indicator (H) <b>294</b>: This indicator includes the host indicator.</li> <li id="ul0008-0009" num="0115">Sampling Interval <b>296</b>: This field includes the contents of the sampling interval register.</li> <li id="ul0008-0010" num="0116">Current Table Entry Address <b>297</b>: This field includes the contents of the table entry address register.</li> <li id="ul0008-0011" num="0117">Next Data Entry Address <b>298</b>: This field includes the contents of the data entry address register.</li> </ul> </li> </ul>
<li> <para-num num="[0118]"> </para-num> <div class="description-line" id="p-0086" num="0118">The sample data is stored in a buffer in, for instance, main memory. For example, a number of sample data blocks (that comprise a buffer) are allocated by the control program (e.g., the operating system running as a guest) for the machine to store sample data during each sampling interval. Each sample data block is designated by a block link entry in a sample data block table. The current entry of the sample data block table is designated by the contents of the table entry address register and the next data entry of the sample data block is designated by the contents of the data entry address register. One example of the structure of a sampling buffer, in accordance with an aspect of the present invention, is depicted in <figref idrefs="DRAWINGS">FIG. 3</figref>.</div>
</li> <li> <para-num num="[0119]"> </para-num> <div class="description-line" id="p-0087" num="0119">Referring to <figref idrefs="DRAWINGS">FIG. 3</figref>, a sampling buffer <b>300</b> includes one or more sample data block tables (SDBTs) <b>302</b> and one or more sample data blocks (SDB) <b>304</b>. In this particular example, three (3) sample data block tables are shown, which are coupled in a circular linked list. Further, in this example, there are a plurality of sample data blocks. It is understood that other examples of the sampling buffer can have more, less or the same number of SDBTs and/or more, less or the same number of SDBs, as shown in this particular example.</div>
</li> <li> <para-num num="[0120]"> </para-num> <div class="description-line" id="p-0088" num="0120">The contents of a table entry address register (TEAR) <b>306</b> point to the current entry of a sample data block table <b>302</b>. There are two kinds of entries in each sample data block table including, for instance: block link entries <b>308</b> and table link entries <b>310</b>. Each block link entry <b>308</b> includes a sample data block (SDB) origin, and each table link entry includes a sample data block table (SDBT) origin. In this particular embodiment, each sample data block table starts at an integral boundary of <b>16</b> bytes, and each entry is 8 bytes. Each sample data block table <b>302</b> includes a number of block link entries <b>308</b> and one table link entry <b>310</b>. A specified bit in each entry (e.g., bit <b>63</b>) distinguishes a block link entry from a table link entry. When bit <b>63</b> is zero, the entry is a block link entry; when bit <b>63</b> is one, the entry is a table link entry. A table link entry is the last entry in the sample data block table. The actual size of a sample data block table is determined by the location of the table link entry, and does not exceed the size specified in the maximum buffer size indicator. The origin and the table link entry of a sample data block table cannot be separated by an integral boundary of the maximum buffer size, in this embodiment.</div>
</li> <li> <para-num num="[0121]"> </para-num> <div class="description-line" id="p-0089" num="0121">When a maximum buffer size indicator <b>320</b> is zero, a specified portion (e.g., bits <b>0</b>-<b>51</b>) of a block link entry include the origin of a sample data block in real or absolute storage. When the sample data block origin is to be placed in the data entry address register, it is appended with zeros (e.g., 12 zeros) on the right to form a 64 bit address and the address is then placed in the register.</div>
</li> <li> <para-num num="[0122]"> </para-num> <div class="description-line" id="p-0090" num="0122">When maximum buffer size indicator <b>320</b> is one, specified bits (bits <b>0</b>-<b>43</b>) of a block link entry include the origin of a sample data block in real or absolute storage. When the sample data block origin is to be placed in the data entry address register, it is appended with a number of zeros (e.g., 20) on the right to form a 64 bit address and the address is then placed in the register.</div>
</li> <li> <para-num num="[0123]"> </para-num> <div class="description-line" id="p-0091" num="0123">In one example, bits <b>0</b>-<b>59</b> of table link entry <b>310</b> include the origin of a sample data block table in real or absolute storage. When the sample data block table origin is to be placed in the table entry address register, it is appended with a number of zeros (e.g., 4) on the right to form a 64 bit address and the address is then placed in the register.</div>
</li> <li> <para-num num="[0124]"> </para-num> <div class="description-line" id="p-0092" num="0124">Continuing to refer to <figref idrefs="DRAWINGS">FIG. 3</figref>, the contents of a data entry address register <b>330</b> designates the next data entry <b>332</b> of a sample data block <b>304</b>. Each sample data block starts at an integral boundary of the maximum buffer size. The size of a sample data block is equal to the size specified in the maximum buffer size indicator.</div>
</li> <li> <para-num num="[0125]"> </para-num> <div class="description-line" id="p-0093" num="0125">In one example, there are two kinds of entries in each sample data block, including, for instance, data entry <b>332</b> and a trailer entry <b>336</b>. The last number of bytes (e.g., 64) of a sample data block form the trailer entry; all other space in the block is used to form data entries.</div>
</li> <li> <para-num num="[0126]"> </para-num> <div class="description-line" id="p-0094" num="0126">When at least one sampling function is active, a data entry is stored during each sampling interval. If only the basic sampling function is active, the data entry stored is a basic sampling data entry; if only the diagnostic sampling function is active, the data entry stored is a diagnostic sampling data entry. If both sampling functions are active, the data entry stored is a combined data entry. Each of these data entries is explained in further detail below.</div>
</li> <li> <para-num num="[0127]"> </para-num> <div class="description-line" id="p-0095" num="0127">One example of the basic sampling data entry is described with reference to <figref idrefs="DRAWINGS">FIG. 4A</figref>. In one example, a basic sampling data entry <b>400</b> includes, for instance, the following fields:
</div> </li> <ul> <li id="ul0009-0001" num="0000"> <ul> <li id="ul0010-0001" num="0128">Data Entry Format Code <b>402</b>: Bits <b>0</b>-<b>15</b> of the data entry include the format code of the data entry.</li> <li id="ul0010-0002" num="0129">Number of Unique Instructions (U) <b>404</b>: Bits <b>20</b>-<b>23</b> of the data entry specify the number of unique, completed instructions that were executed simultaneously during the sampling cycle when the unique cycle indicator was on.</li> <li id="ul0010-0003" num="0130">A pipelined CPU can execute multiple instructions concurrently in an overlapped fashion: each of these instructions being executed concurrently is in a different pipeline stage. Furthermore, on some models, each stage of a pipelined CPU may execute multiple instructions simultaneously.</li> <li id="ul0010-0004" num="0131">During an instruction execution, a unique cycle indicator is turned on for one cycle at the sample point, that is the place in the CPU the sample data is taken from. The sampling point depends on the model, but is the same for all instructions executed on the same model. For a pipelined CPU, the sampling point is usually a particular pipeline stage. Depending on the model, it is unpredictable when the unique cycle indicator is turned on during an instruction execution. This field includes the number of instructions executed simultaneously at the sampling point when the unique cycle indicator is on.</li> <li id="ul0010-0005" num="0132">When a sampling time occurs and if the sampling point is not busy because either the CPU is in the wait state or because of delay in some other pipeline stage, the contents of this field are set to zero.</li> <li id="ul0010-0006" num="0133">The contents of this field can be used to estimate cycles per instruction when a sufficiently small sampling interval and an adequately larger number of samples are used.</li> <li id="ul0010-0007" num="0134">The cycles per instruction for a particular measurement can be estimated by dividing the number of busy samples, that is samples with the wait state bit (described below) being set to zero, by the total number of unique instructions in all busy samples.</li> <li id="ul0010-0008" num="0135">DAT Mode (T) <b>406</b>: Bit <b>26</b> of the data entry includes the data address translation (DAT) mode bit in the Program Status Word (PSW) of the CPU.</li> <li id="ul0010-0009" num="0136">Wait State (W) <b>408</b>: Bit <b>27</b> of the data entry includes the wait state bit in the PSW of the CPU.</li> <li id="ul0010-0010" num="0137">Problem State (P) <b>410</b>: Bit <b>28</b> of the data entry includes the problem state bit in the PSW of the CPU.</li> <li id="ul0010-0011" num="0138">Address Space Control (AS) <b>412</b>: Bits <b>29</b>-<b>30</b> of the data entry include the address space control in the PSW of the CPU.</li> <li id="ul0010-0012" num="0139">Invalid Indication (I) <b>414</b>: Bit <b>31</b> of the data entry indicates whether the entry is valid or invalid. When the bit is zero, the entry is valid; when the bit is one, the entry is invalid. An entry is set to invalid when sample data in the entry are not consistent.</li> <li id="ul0010-0013" num="0140">Primary ASN <b>416</b>: Byte offsets <b>6</b>-<b>7</b> of the data entry include the Primary Address Space Number (PASN) in bits <b>48</b>-<b>63</b> of control register <b>4</b> of the CPU.</li> <li id="ul0010-0014" num="0141">Instruction Address <b>418</b>: Byte offsets <b>8</b>-<b>15</b> of the data entry include the instruction address of an instruction that the CPU was executing during the sampling cycle.</li> <li id="ul0010-0015" num="0142">Instruction addresses are treated as real addresses in the real mode; as primary virtual addresses in the primary address mode, secondary space mode, or access register mode; and as home virtual addresses in the home space mode.</li> <li id="ul0010-0016" num="0143">When the sampling point is executing multiple instructions simultaneously during the sampling cycle, only the address of one instruction among these simultaneously executed instructions is reported. The selection of which instruction address to be reported is model dependent.</li> <li id="ul0010-0017" num="0144">On some models, the address of the target instruction of Execute is not reported in the same data. When the wait state bit is one, the contents of this field are unpredictable. When a sampling time occurs and if the sampling point is not executing any instruction because of delay in some other pipeline stage, it is unpredictable which address of the instructions being executed concurrently in the CPU is reported.</li> <li id="ul0010-0018" num="0145">Guest Program Parameter <b>420</b>: Byte offsets <b>16</b>-<b>23</b> of the data entry include the current program parameter register if the CPU is not running at the logical partition level or if it is running at the logical partition level and the host indicator is zero. If the CPU is running at the logical partition level and the host indicator is one, zero is stored in this field.</li> <li id="ul0010-0019" num="0146">Host Program Parameter <b>422</b>: Byte offsets <b>24</b>-<b>31</b> of the data entry include the current program parameter register if the CPU is running at the logical partition level and the host indicator is one. Otherwise, the contents of this field are unpredictable.</li> </ul> </li> </ul>
<li> <para-num num="[0147]"> </para-num> <div class="description-line" id="p-0096" num="0147">One example of a diagnostic sampling data entry <b>440</b> is described with reference to <figref idrefs="DRAWINGS">FIG. 4B</figref>. In one example, diagnostic sampling data entry <b>440</b> includes:
</div> </li> <ul> <li id="ul0011-0001" num="0000"> <ul> <li id="ul0012-0001" num="0148">A data entry format code <b>442</b>: Bits <b>0</b>-<b>15</b> of the data entry includes the format code of the data entry.</li> <li id="ul0012-0002" num="0149">Maximum buffer size <b>444</b>: Bit <b>19</b> is intended to indicate the maximum buffer size. Zero indicates 4K bytes, and one indicates 1 megabytes.</li> <li id="ul0012-0003" num="0150">Invalid Indication (I) <b>446</b>: Bit <b>31</b> of the data entry indicates whether the entry is valid or invalid. When the bit is zero, the entry is valid; when the bit is one, the entry is invalid. An entry is set to invalid when sample data in the entry are not consistent.</li> </ul> </li> </ul>
<li> <para-num num="[0151]"> </para-num> <div class="description-line" id="p-0097" num="0151">The rest of this entry includes non-architected sample data.</div>
</li> <li> <para-num num="[0152]"> </para-num> <div class="description-line" id="p-0098" num="0152">When both the basic sampling function and the diagnostic sampling function are active, the sample data stored during each sampling interval is a combined data entry, which includes a basic sampling data entry followed by a diagnostic sample data entry.</div>
</li> <li> <para-num num="[0153]"> </para-num> <div class="description-line" id="p-0099" num="0153">When a combined data entry is to be stored, it is completely stored in the current sample data block if there exists enough space. When there is not enough space in the current sample data block, if there is enough space in the next sample data block, then the entire combined sample data is stored in the next sample data block. The basic sampling data entry and the diagnostic sampling data entry of a combined data entry are not stored in different sample data blocks, in this example. When the combined sample data is discarded because of no space available, the sample overflow count of the current sample data block is incremented by one.</div>
</li> <li> <para-num num="[0154]"> </para-num> <div class="description-line" id="p-0100" num="0154">One embodiment of the fields associated with a trailer entry are described with reference to <figref idrefs="DRAWINGS">FIG. 4C</figref>. Each trailer entry is, for instance, 64 bytes and resides in the last 64 bytes of a sample data block. In one example, a trailer entry <b>450</b> includes, for instance:
</div> </li> <ul> <li id="ul0013-0001" num="0000"> <ul> <li id="ul0014-0001" num="0155">Block Full Indicator (F) <b>452</b>: Bit zero of byte offset <b>0</b> of the trailer entry is a block full indicator. When the indicator is one, the sample data block is full.</li> <li id="ul0014-0002" num="0156">Alert request control (A) <b>454</b>: Bit <b>1</b> of byte offset <b>0</b> of the trailer entry is the alert request indicator. When the indicator is one and the sample data block becomes full, a program request alert external interruption event is recognized at the completion of the sample data block update process. Herein, the sample data block is considered full when its block full indicator is set, regardless of whether it is entirely full. If the block has additional space, but not enough to store the next sample, the indicator is set and the block is considered full.</li> <li id="ul0014-0003" num="0157">The setting of the alert request control is selectable. For example, it can be set in every x (e.g., 10) data blocks. Thus, even if one data block of the buffer is full, there need not been an interrupt until a data block is reached with the indicator set, such as after the tenth full data block. The selection of 10 is only one example, any other desired number may be used. Thus, an interrupt is not taken after the sample interval or even after one data block is full.</li> <li id="ul0014-0004" num="0158">Sample overflow count <b>456</b>: Bytes offsets <b>8</b>-<b>15</b> of the trailer entry include the number of sample data entries that have been lost because the sample data block is full.</li> <li id="ul0014-0005" num="0159">Timestamp <b>458</b>: Byte offsets <b>16</b>-<b>31</b> of the trailer entry include the time-of-day (TOD) clock value at the time when the sample data block becomes full.</li> </ul> </li> </ul>
<li> <para-num num="[0160]"> </para-num> <div class="description-line" id="p-0101" num="0160">When a program request alert occurs, it is expected that the program (e.g., control program, such as an operating system running as a guest) reads out sample data from the sample data blocks that are full. To free up these blocks, the program shall reset the block full indicator (F) and the sample overflow count, and shall also reestablish an alert request control (A). Updating these fields in a sample data block shall be performed, in one example, as an interlocked update, using a Compare Double and Swap instruction. All of these reads and updates are performed while sampling functions remain active.</div>
</li> <li> <para-num num="[0161]"> </para-num> <div class="description-line" id="p-0102" num="0161">When the CPU is in the operating state and at least one sampling function is active, the sample data block update process is performed at each sampling time. The process locates space for the new data entry, forms the entry, and updates the contents of the data entry address register so that the register contents designate the location of the next data entry.</div>
</li> <li> <para-num num="[0162]"> </para-num> <div class="description-line" id="p-0103" num="0162">During the sample data block update process, if any address is formed through the addition of a value to another address, a carry out of bit position zero of the address, if any, is ignored. Similarly, when the contents of the sample overflow count field is incremented, a carry out of bit position zero of the count, if any, is ignored.</div>
</li> <li> <para-num num="[0163]"> </para-num> <div class="description-line" id="p-0104" num="0163">Accesses to a sample data block are not subject to key controlled protection; nor are they subject to low address protection.</div>
</li> <li> <para-num num="[0164]"> </para-num> <div class="description-line" id="p-0105" num="0164">When storage access to a sample data block entry or sample data block table entry is performed, if the address is invalid, a measurement alert external interruption event (invalid entry address) is recognized, and active sampling functions for that CPU are placed in the inactive state. An entry address is invalid if, for instance, the address is in the range 0-8191; if the designated sample data block entry is inside the trailer entry; or if the designated storage location is not available in the configuration.</div>
</li> <li> <para-num num="[0165]"> </para-num> <div class="description-line" id="p-0106" num="0165">When storage access to a sample data block table entry is performed, if any incorrect SDB table entry is detected, a measurement alert external interruption event (incorrect sample data block table entry) is recognized, and active sampling functions for that CPU are placed in the inactive state. A sample data block table entry is incorrect if the entry is a table link entry and it designates another table link entry, or if the last table entry is not a table link entry.</div>
</li> <li> <para-num num="[0166]"> </para-num> <div class="description-line" id="p-0107" num="0166">The contents of the data entry address register are used to locate the next data entry in the current sample data block. If the next data entry resides inside the trailer entry (e.g., last 64 bytes) of the sample data block, then a measurement alert external interruption event (invalid entry address alert) is recognized and sampling functions are placed in the inactive state.</div>
</li> <li> <para-num num="[0167]"> </para-num> <div class="description-line" id="p-0108" num="0167">One embodiment of the logic associated with updating a sampling buffer, in accordance with an aspect of the present invention, is described with reference to <figref idrefs="DRAWINGS">FIGS. 5A-5B</figref>. Referring to <figref idrefs="DRAWINGS">FIG. 5A</figref>, initially, sample data has been obtained during a sampling function and it is to be stored in the buffer, STEP <b>500</b>. A determination is made as to whether the block full indicator in the trailer entry of the current sample data block is set (e.g., equal to one), INQUIRY <b>502</b>. If the block full indicator is set, then at this point, it indicates that there is insufficient space in the buffer to store the data. The contents of the sample overflow count field of the trailer entry are incremented by one, STEP <b>504</b>, and the sample data to be stored is discarded, STEP <b>506</b>. This completes the update process, STEP <b>508</b>.</div>
</li> <li> <para-num num="[0168]"> </para-num> <div class="description-line" id="p-0109" num="0168">Returning to INQUIRY <b>502</b>, if, however, the block full indicator in the trailer entry of the current sample data block is zero, a determination is made as to whether there is enough space to store the sample data, INQUIRY <b>510</b>. If the block full indicator is zero and there exists enough space, then the sample data is stored in the next data entry, STEP <b>512</b>, and the contents of the data entry address register are incremented by the data entry size, STEP <b>514</b>. The update process is complete, STEP <b>508</b>.</div>
</li> <li> <para-num num="[0169]"> </para-num> <div class="description-line" id="p-0110" num="0169">On the other hand, returning to INQUIRY <b>510</b>, if the block full indicator is not set and there is not enough space to store the sample data in the next data entry, then the block full indicator in the trailer entry of the current sample data block is set to one, STEP <b>520</b> (<figref idrefs="DRAWINGS">FIG. 5B</figref>), and the time of day clock value is placed in the timestamp field of the trailer entry, STEP <b>522</b>.</div>
</li> <li> <para-num num="[0170]"> </para-num> <div class="description-line" id="p-0111" num="0170">Thereafter, a determination is made as to whether the alert request indicator in the trailer entry is one, INQUIRY <b>524</b>. If the alert request indicator in the trailer entry is one, a measurement alert external interruption event (program requested alert) is recognized at the end of the update process, STEP <b>526</b>. Thereafter, or if the alert request indicator is not set, the contents of the table entry address register are incremented by the SDB table entry size so that the next entry in the SDB table becomes the current SDB table entry, STEP <b>528</b>. The current SDB table entry is fetched and bit <b>63</b> of the entry is examined, STEP <b>530</b>. If bit <b>63</b> of the SDB table entry is zero, the entry is a block link entry and includes a sample data block (SDB) origin; if bit <b>63</b> is one, the entry is a table link entry and includes a sample data block table (SDBT) origin.</div>
</li> <li> <para-num num="[0171]"> </para-num> <div class="description-line" id="p-0112" num="0171">If the fetched entry is the last entry in the SDB table (i.e., the entry is the last entry before reaching the maximum buffer size), INQUIRY <b>532</b>, and if the entry is not a table link entry (i.e., bit <b>63</b> of the entry is zero), INQUIRY <b>534</b>, then a measurement alert external interruption event (incorrect SDB table entry alert) is recognized, STEP <b>536</b>. Active sampling functions are placed in the inactive state and the update process is complete, STEP <b>538</b>.</div>
</li> <li> <para-num num="[0172]"> </para-num> <div class="description-line" id="p-0113" num="0172">Returning to INQUIRY <b>534</b>, if it is the last entry and bit <b>63</b> is one, then the address of the origin of the SDB table specified in the entry is placed in the table entry address register so that the specified table becomes the current SDB table, STEP <b>540</b>. The current SDB table entry is fetched and bit <b>63</b> of the entry is examined, STEP <b>542</b>. If bit <b>63</b> is one, INQUIRY <b>544</b>, indicating that the SDB table entry pointed to by the table link entry is itself a table link entry, a measurement alert external interruption event (incorrect SDB table entry alert) is recognized, STEP <b>536</b>. Active sampling functions are placed in the inactive state and the update process is complete, STEP <b>538</b>.</div>
</li> <li> <para-num num="[0173]"> </para-num> <div class="description-line" id="p-0114" num="0173">However, if bit <b>63</b> is zero, INQUIRY <b>544</b>, then the address of the origin of the sample data block specified in the entry is placed in the data entry address register so that the block becomes the current sample data block, STEP <b>546</b>. Processing then continues at INQUIRY <b>502</b> (<figref idrefs="DRAWINGS">FIG. 5A</figref>), as described above.</div>
</li> <li> <para-num num="[0174]"> </para-num> <div class="description-line" id="p-0115" num="0174">Returning to INQUIRY <b>532</b> (<figref idrefs="DRAWINGS">FIG. 5B</figref>), if the fetched entry is not the last entry in the SDB table (i.e., not the last entry before reaching the boundary), and if bit <b>63</b> of the fetched table entry is zero, INQUIRY <b>550</b>, then processing continues at STEP <b>546</b>, as described herein. However, if bit <b>63</b> of the fetched entry is one, indicating there are no more entries in the table, even though the table has more space, then processing continues with STEP <b>540</b>, as described herein.</div>
</li> <li> <para-num num="[0175]"> </para-num> <div class="description-line" id="p-0116" num="0175">As indicated with reference to STEP <b>526</b>, in response to determining that an alert request is set in the trailer entry of a sample data block that is indicated as full, a measurement alert external interruption event is recognized at the end of the update process. One embodiment of this processing is described with reference to <figref idrefs="DRAWINGS">FIG. 5C</figref>.</div>
</li> <li> <para-num num="[0176]"> </para-num> <div class="description-line" id="p-0117" num="0176">Referring to <figref idrefs="DRAWINGS">FIG. 5C</figref>, an interruption is recognized at the end of the update process, STEP <b>580</b>. In response thereto, the control program (e.g., operating system running as a guest) reads the data stored in one or more sample data blocks (e.g., the blocks that are full, or all the blocks that have data or a subset thereof) and writes that data to DASD or another storage medium, STEP <b>582</b>. Additionally, in an interlocked update operation, the control program resets the block full indicator in the trailer entry of any of the blocks that were full, STEP <b>584</b>, and re-establishes an alert request control STEP <b>586</b>. In one example, the re-establishing includes setting (or leaving set) the same alert indicator that initiated the interrupt. In other examples, however, one or more other alert indicators can be set. An alert indicator can be set in one or more trailer entries, depending on how frequently the data is to be dumped.</div>
</li> <li> <para-num num="[0177]"> </para-num> <div class="description-line" id="p-0118" num="0177">The alert indicator is set, for instance, in at least one data block, which is selected to provide sufficient time to dump the data before the buffer is full, minimizing the loss of sample data. If, however, a small amount of data is lost, the collected data still continues to be useful. On the other hand, if a significant amount of data is lost, which is implementation dependent, then the collected sample data is ignored.</div>
</li> <li> <para-num num="[0178]"> </para-num> <div class="description-line" id="p-0119" num="0178">The buffer update process described with reference to <figref idrefs="DRAWINGS">FIGS. 5A-5C</figref> is part of an overall sampling process that takes place to capture sample data. The sampling process begins by an operator request, in response to which a sampling function is initiated. There may be one or more sampling functions initiated by one or more operators concurrently. A sampling process, including a buffer update process, may be performed in both non-virtual and virtual environments. One embodiment of an overview of a sampling process for a virtual environment is described with reference to <figref idrefs="DRAWINGS">FIGS. 6A-6C</figref>. Thereafter, an overview of processing for counters in a virtual environment is provided.</div>
</li> <li> <para-num num="[0179]"> </para-num> <div class="description-line" id="p-0120" num="0179">Referring to <figref idrefs="DRAWINGS">FIG. 6A</figref>, initially, an operator invokes a sampling function and specifies various parameters including, for instance, the sampling frequency, F, (e.g., the number of samples to be collected per minute), the duration of the sampling run in minutes, D, and the type of sampling (e.g., basic, diagnostic, or combined), STEP <b>600</b>.</div>
</li> <li> <para-num num="[0180]"> </para-num> <div class="description-line" id="p-0121" num="0180">Further, the host (e.g., LPAR) authorizes sampling by setting an authorization indicator for a particular guest for which sampling is to be performed, STEP <b>602</b>.</div>
</li> <li> <para-num num="[0181]"> </para-num> <div class="description-line" id="p-0122" num="0181">The guest (e.g., control program, such as an operating system) is dispatched, STEP <b>604</b>. Thereafter, the guest issues a Query Sampling Information (QSI) instruction, described below, that provides information about the sampling facility, STEP <b>606</b>. In one example, this information includes the basic sampling data entry size (BSDES) in bytes, the diagnostic sampling data entry size (DSDES) in bytes, and the CPU speed=C cycles/microseconds. With the obtained information, the control program calculates the sampling interval for each processor in the measurement=i cycles/sec, STEP <b>608</b>. For instance,</div>
</li> <li> <para-num num="[0182]"> </para-num> <div class="description-line" id="p-0123" num="0182">F=overall sampling frequency in samples/minute;</div>
</li> <li> <para-num num="[0183]"> </para-num> <div class="description-line" id="p-0124" num="0183">p=number of processors involved in the measurement;</div>
</li> <li> <para-num num="[0184]"> </para-num> <div class="description-line" id="p-0125" num="0184">f=(F/60)/p=individual sampling frequency for each processor in samples/second;</div>
</li> <li> <para-num num="[0185]"> </para-num> <div class="description-line" id="p-0126" num="0185">C=CPU speed in cycles/(10**−6) seconds;</div>
</li> <li> <para-num num="[0186]"> </para-num> <div class="description-line" id="p-0127" num="0186">i=(1/f)C=individual sampling interval for each processor in cycles/sample.</div>
</li> <li> <para-num num="[0187]"> </para-num> <div class="description-line" id="p-0128" num="0187">Further, the individual sampling frequency (defined above), f, the sample data entry size, L, and the specified duration of the sampling run, D, are used to calculate how large the data buffer for each processor needs to be, STEP <b>610</b>. The sample data entry size, L, is calculated using the specified sampling type and the size of each entry type (BSDES and DSDES) returned by the QSI instruction. For instance,</div>
</li> <li> <para-num num="[0188]"> </para-num> <div class="description-line" id="p-0129" num="0188">L=sampling data entry size in bytes;</div>
</li> <li> <para-num num="[0189]"> </para-num> <div class="description-line" id="p-0130" num="0189">if only basic sampling is used, L=BSDES;</div>
</li> <li> <para-num num="[0190]"> </para-num> <div class="description-line" id="p-0131" num="0190">if only diagnostic sampling is used, L=DSDES;</div>
</li> <li> <para-num num="[0191]"> </para-num> <div class="description-line" id="p-0132" num="0191">if both basic and diagnostic sampling are used, L=BDES+DSDES;</div>
</li> <li> <para-num num="[0192]"> </para-num> <div class="description-line" id="p-0133" num="0192">f=individual sampling frequency for each processor in samples/second;</div>
</li> <li> <para-num num="[0193]"> </para-num> <div class="description-line" id="p-0134" num="0193">D=intended duration of the run in minutes;</div>
</li> <li> <para-num num="[0194]"> </para-num> <div class="description-line" id="p-0135" num="0194">B=f *L*D*60=buffer size in bytes needed for all of the samples on an individual processor for the entire sampling run.</div>
</li> <li> <para-num num="[0195]"> </para-num> <div class="description-line" id="p-0136" num="0195">Based on the above information, the guest allocates storage for the buffer, STEP <b>612</b>. In accordance with an aspect of the present invention, the total buffer size need not be allocated. Instead, only a portion of the buffer is allocated and at specific times, an interrupt is initiated to remove data from the buffer and that same buffer may be reused. Storage is allocated for the desired buffer size and the storage is formulated into the form of the sampling data buffer described with reference to <figref idrefs="DRAWINGS">FIG. 3</figref>.</div>
</li> <li> <para-num num="[0196]"> </para-num> <div class="description-line" id="p-0137" num="0196">The buffer size allocated by the guest is to be large enough so that the guest can service the interruption before the allocated buffer is full. Allocating a buffer larger than this minimum value will require the guest to be interrupted less frequently. The time needed between guest interruptions is to guarantee servicing of each interrupt before the next is presented. The guest considers these factors when determining the portion of the needed buffer size to allocate.</div>
</li> <li> <para-num num="[0197]"> </para-num> <div class="description-line" id="p-0138" num="0197">The minimum size of the buffer to be allocated for each processor involved in the measurement, b, is calculated using the individual sampling frequency, f, the sample size, L, and the control program service interval, T. For instance,</div>
</li> <li> <para-num num="[0198]"> </para-num> <div class="description-line" id="p-0139" num="0198">T=time in sec between control program interrupts needed to service the buffer;</div>
</li> <li> <para-num num="[0199]"> </para-num> <div class="description-line" id="p-0140" num="0199">b=f *L*T=minimum allocated buffer size in bytes.</div>
</li> <li> <para-num num="[0200]"> </para-num> <div class="description-line" id="p-0141" num="0200">Once the minimum and maximum values have been calculated, the guest determines a practical buffer size, including a safety margin. For example, the minimum buffer size, b, is multiplied by a value of 4 to allow the asynchronous writing of the buffer to occur without losing samples being collected concurrent to the write operation; it is understood that the write operation takes a nontrivial amount of time to complete.</div>
</li> <li> <para-num num="[0201]"> </para-num> <div class="description-line" id="p-0142" num="0201">Thereafter, the guest issues a Set Sampling Controls instruction, described below, to activate the sampling function, STEP <b>614</b>. This instruction sets the appropriate enablement and activation bits in the sampling controls. In response to issuing this instruction, sampling is performed and the sampled data is handled in the manner described above with reference to <figref idrefs="DRAWINGS">FIGS. 5A-5C</figref>, STEP <b>616</b>.</div>
</li> <li> <para-num num="[0202]"> </para-num> <div class="description-line" id="p-0143" num="0202">At some point, the guest is suspended and control is returned to the host, STEP <b>620</b>. This can occur for a number of reasons including that the guest's time slice has expired. As part of suspension, a residual sampling interval indicator is updated, STEP <b>628</b> (<figref idrefs="DRAWINGS">FIG. 6B</figref>). This indicator is provided for each guest. When the guest time slice ends, this indicator is used to record the remaining time before the next sample is taken. For instance, if the sampling interval is <b>10</b>ms and the guest's last sample was taken <b>6</b>ms before being suspended, then <b>4</b>ms is saved in the residual sampling interval. This will be used as the time remaining in this sampling interval when this guest is redispatched. In one example, this indicator is stored in a measurement block associated with the guest, as described below.</div>
</li> <li> <para-num num="[0203]"> </para-num> <div class="description-line" id="p-0144" num="0203">Additionally, controls are saved, such as sampling controls, STEP <b>630</b>. Since this is a virtual environment, control blocks are provided to save the controls for each guest, as described herein. For example, the appropriate enablement and activation indicators are stored in the MAD and MCD in the state description. Moreover, the pending interruption parameter is saved in the state description.</div>
</li> <li> <para-num num="[0204]"> </para-num> <div class="description-line" id="p-0145" num="0204">Further, the sampling facility is placed in a disabled state by setting one or more hardware indicators, STEP <b>632</b>, and control returns to the host, STEP <b>634</b>.</div>
</li> <li> <para-num num="[0205]"> </para-num> <div class="description-line" id="p-0146" num="0205">In addition to the above in which sample data is captured and written to the buffer, counters may also be updated to reflect the activity of the guest. This processing is similar to the sampling processing described with reference to <figref idrefs="DRAWINGS">FIGS. 6A-6B</figref>. For example, an operator authorizes counters and specifies one or more parameters. Further, the host authorizes the counters facility by setting an authorization indicator for a particular guest for which counters is to be performed. The guest is dispatched, and thereafter, the guest issues a Query Counter Information (QCTRI) instruction, described below, that provides information about the counter facility. Further, the guest issues a Set CPU Counter Set Controls instruction, described below, to activate the counter function. This instruction sets the appropriate enablement and activation bits in the counter controls. In response to issuing this instruction, the counter function is performed.</div>
</li> <li> <para-num num="[0206]"> </para-num> <div class="description-line" id="p-0147" num="0206">When the guest is suspended, the counter controls are saved. For instance, the appropriate enablement and activation indicators are stored in the MAD and MCD, and the pending interrupt parameter is saved in the state description. Control returns to the host.</div>
</li> <li> <para-num num="[0207]"> </para-num> <div class="description-line" id="p-0148" num="0207">In one example, when the guest is redispatched, a check is made as to whether measurement is still authorized, INQUIRY <b>650</b> (<figref idrefs="DRAWINGS">FIG. 6C</figref>). This is accomplished, in one example, by the dispatch routine (e.g., millicode) checking the authorization indicator. If measurement is not authorized, the guest is notified via, for instance, a guest interruption, STEP <b>652</b>. Otherwise, measurement proceeds, as described herein, STEP <b>654</b>.</div>
</li> <li> <para-num num="[0208]"> </para-num> <div class="description-line" id="p-0149" num="0208">Asynchronous to the above, in accordance with an aspect of the present invention, a dispatcher of the control program issues a Set Program Parameter instruction <b>700</b> (<figref idrefs="DRAWINGS">FIG. 7A</figref>), each time the dispatcher dispatches a task. The Set Program Parameter instruction tags the task with an identifier identifying the specific task. This identifier is provided along with the sample data (e.g., identifier is retrieved from register and included with data) such that it is known for which task the data belongs. Since the dispatcher is performance critical, there is no test to determine if the measurement facility is activated. Instead, this instruction is issued each time the dispatcher dispatches a task. In one example, if the configuration is not configured for sampling, then the instruction is executed as a no operation.</div>
</li> <li> <para-num num="[0209]"> </para-num> <div class="description-line" id="p-0150" num="0209">One embodiment of the Set Program Parameter instruction is described with reference to <figref idrefs="DRAWINGS">FIG. 7B</figref>. As one example, a Set Program Parameter instruction <b>750</b> includes the following fields:
</div> </li> <ul> <li id="ul0015-0001" num="0000"> <ul> <li id="ul0016-0001" num="0210">Op code <b>752</b>: This field includes the operation code that specifies the Set Program Parameter instruction;</li> <li id="ul0016-0002" num="0211">B<sub>2 </sub> <b>754</b> and D<sub>2 </sub> <b>756</b>: The contents of the general register designated by the B<sub>2 </sub>field are added to the contents of the D<sub>2 </sub>field to form a second operand address.</li> </ul> </li> </ul>
<li> <para-num num="[0212]"> </para-num> <div class="description-line" id="p-0151" num="0212">In execution, the eight byte program parameter in storage locations designated by the second operand address is placed in a program parameter register. In one example, this register is a 64-bit register, and the contents of this register are cleared to zeros by initial CPU reset, clear reset or power-on reset. As one particular example, the program parameter register is included within a state description maintained in real storage.</div>
</li> <li> <para-num num="[0213]"> </para-num> <div class="description-line" id="p-0152" num="0213">The Query Sampling Information instruction, referred to above, is used to place information about the CPU measurement sampling facility in an information block designated by the second operand address of the instruction. In one example, a Query Sampling Information instruction <b>800</b> (<figref idrefs="DRAWINGS">FIG. 8A</figref>) includes, for instance:
</div> </li> <ul> <li id="ul0017-0001" num="0000"> <ul> <li id="ul0018-0001" num="0214">Op code <b>802</b>: This field includes the operation code that specifies the Query Sampling Information instruction;</li> <li id="ul0018-0002" num="0215">B<sub>2 </sub> <b>804</b> and D<sub>2 </sub> <b>806</b>: The contents of the general register designated by the B<sub>2 </sub>field are added to the contents of the D<sub>2 </sub>field to form a second operand address.</li> </ul> </li> </ul>
<li> <para-num num="[0216]"> </para-num> <div class="description-line" id="p-0153" num="0216">In one example, the information block <b>820</b> (<figref idrefs="DRAWINGS">FIG. 8B</figref>) is 64 bytes and includes the following:
</div> </li> <ul> <li id="ul0019-0001" num="0000"> <ul> <li id="ul0020-0001" num="0217">Sampling State Controls <b>822</b>: Byte offsets <b>0</b>-<b>3</b> of the information block include the state controls for the basic sampling and diagnostic sampling functions and have the following format, in one example:</li> </ul> </li> </ul>
<li> <div class="description-line" id="p-0154" num="0000">
<chemistry id="CHEM-US-00001" num="00001">
<div class="patent-image"><a href="https://patentimages.storage.googleapis.com/64/fb/a6/cb66114a3300f2/US20210263829A1-20210826-C00001.png"><img alt="Figure US20210263829A1-20210826-C00001" class="patent-full-image" file="US20210263829A1-20210826-C00001.TIF" he="62.06mm" height="248" id="EMI-C00001" img-content="chem" img-format="tif" inline="no" orientation="portrait" src="https://patentimages.storage.googleapis.com/64/fb/a6/cb66114a3300f2/US20210263829A1-20210826-C00001.png" wi="75.18mm" width="301"/></a></div>
<attachments>
<attachment attachment-type="cdx" file="US20210263829A1-20210826-C00001.CDX" idref="CHEM-US-00001"> </attachment>
<attachment attachment-type="mol" file="US20210263829A1-20210826-C00001.MOL" idref="CHEM-US-00001"> </attachment>
</attachments>
</chemistry>
</div> </li> <ul>
<li id="ul0021-0001" num="0000">
<ul>
<li id="ul0022-0001" num="0218">Basic Sampling Data Entry Size (BSDES) <b>824</b>: Byte offsets <b>4</b>-<b>5</b> of the information block include an unsigned binary integer, specifying the size in bytes of the basic sampling data entry. This information is hard-coded, in one example, in the machine.</li>
<li id="ul0022-0002" num="0219">Diagnostic Sampling Data Entry Size (DSDES) <b>826</b>: Byte offsets <b>6</b>-<b>7</b> include an unsigned binary integer, specifying the size in bytes of the diagnostic sampling data entry. This information is hard-coded, in one example, in the machine.</li>
<li id="ul0022-0003" num="0220">Minimum Sampling Interval <b>828</b>: Byte offsets <b>8</b>-<b>15</b> of the information block include the minimum sampling interval in number of CPU cycles. This information is hard-coded, in one example, in the machine.</li>
<li id="ul0022-0004" num="0221">Maximum Sampling Interval <b>830</b>: Byte offsets <b>16</b>-<b>23</b> include the maximum sampling interval in number of CPU cycles. This information is hard-coded, in one example, in the machine.</li>
<li id="ul0022-0005" num="0222">TEAR Contents <b>832</b>: When the basic sampling or diagnostic sampling function, or both, are enabled, byte offsets <b>24</b>-<b>31</b> of the information block include the contents of the table entry address register. When neither the basic sampling nor diagnostic sampling function is enabled, zeros are stored in byte offsets <b>24</b>-<b>31</b> of the information block.</li>
<li id="ul0022-0006" num="0223">DEAR Contents <b>834</b>: When the basic sampling or diagnostic sampling function, or both are enabled, byte offsets <b>32</b>-<b>39</b> of the information block include the contents of the data entry address register. When neither the basic sampling nor the diagnostic sampling function is enabled, zeros are stored in byte offsets <b>32</b>-<b>39</b> of the information block.</li>
<li id="ul0022-0007" num="0224">CPU Speed <b>836</b>: Byte offsets <b>44</b>-<b>47</b> include an unsigned binary integer, which specifies the CPU speed in number of CPU cycles per microsecond. This information is provided, in one example, by machine based on the model.</li>
</ul>
</li>
</ul>
<li> <para-num num="[0225]"> </para-num> <div class="description-line" id="p-0155" num="0225">The Query Counter Information instruction, referred to above, is used to place information about the CPU measurement counter facility in an information block designated by the second operand address of the instruction. In one example, a Query Counter Information instruction <b>850</b> (<figref idrefs="DRAWINGS">FIG. 8C</figref>) includes, for instance:
</div> </li> <ul> <li id="ul0023-0001" num="0000"> <ul> <li id="ul0024-0001" num="0226">Op Code <b>852</b>: This field includes the operation code that specifies the Query Counter Information instruction;</li> <li id="ul0024-0002" num="0227">B<sub>2 </sub> <b>854</b> and D<sub>2 </sub> <b>856</b>: The contents of the general register designated by the B<sub>2 </sub>field are added to the contents of the D<sub>2 </sub>field to form a second operand address.</li> </ul> </li> </ul>
<li> <para-num num="[0228]"> </para-num> <div class="description-line" id="p-0156" num="0228">In one example, the information block <b>870</b> (<figref idrefs="DRAWINGS">FIG. 8D</figref>) is 64 bytes and includes the following:
</div> </li> <ul> <li id="ul0025-0001" num="0000"> <ul> <li id="ul0026-0001" num="0229">Counter First Version Number (CFVN) <b>872</b>: Byte offsets <b>0</b>-<b>1</b> of the information block include the counter first version number;</li> <li id="ul0026-0002" num="0230">Authorization Controls <b>874</b>: Byte offsets <b>2</b>-<b>3</b> of the information block include the authorization controls and have the following format, in one example:</li> </ul> </li> </ul>
<li> <div class="description-line" id="p-0157" num="0000">
<chemistry id="CHEM-US-00002" num="00002">
<div class="patent-image"><a href="https://patentimages.storage.googleapis.com/7e/f3/06/64f59243c81b95/US20210263829A1-20210826-C00002.png"><img alt="Figure US20210263829A1-20210826-C00002" class="patent-full-image" file="US20210263829A1-20210826-C00002.TIF" he="59.18mm" height="237" id="EMI-C00002" img-content="chem" img-format="tif" inline="no" orientation="portrait" src="https://patentimages.storage.googleapis.com/7e/f3/06/64f59243c81b95/US20210263829A1-20210826-C00002.png" wi="75.18mm" width="301"/></a></div>
<attachments>
<attachment attachment-type="cdx" file="US20210263829A1-20210826-C00002.CDX" idref="CHEM-US-00002"> </attachment>
<attachment attachment-type="mol" file="US20210263829A1-20210826-C00002.MOL" idref="CHEM-US-00002"> </attachment>
</attachments>
</chemistry>
</div> </li> <ul>
<li id="ul0027-0001" num="0000">
<ul>
<li id="ul0028-0001" num="0231">Enable Controls <b>876</b>: Byte offsets <b>4</b>-<b>5</b> of the information block include the enable controls and have the following format, in one example:</li>
</ul>
</li>
</ul>
<li> <div class="description-line" id="p-0158" num="0000">
<chemistry id="CHEM-US-00003" num="00003">
<div class="patent-image"><a href="https://patentimages.storage.googleapis.com/d6/48/16/8ab0e437cdf8d3/US20210263829A1-20210826-C00003.png"><img alt="Figure US20210263829A1-20210826-C00003" class="patent-full-image" file="US20210263829A1-20210826-C00003.TIF" he="59.18mm" height="237" id="EMI-C00003" img-content="chem" img-format="tif" inline="no" orientation="portrait" src="https://patentimages.storage.googleapis.com/d6/48/16/8ab0e437cdf8d3/US20210263829A1-20210826-C00003.png" wi="75.18mm" width="301"/></a></div>
<attachments>
<attachment attachment-type="cdx" file="US20210263829A1-20210826-C00003.CDX" idref="CHEM-US-00003"> </attachment>
<attachment attachment-type="mol" file="US20210263829A1-20210826-C00003.MOL" idref="CHEM-US-00003"> </attachment>
</attachments>
</chemistry>
</div> </li> <ul>
<li id="ul0029-0001" num="0000">
<ul>
<li id="ul0030-0001" num="0232">Activation Controls <b>878</b>: Byte offsets <b>6</b>-<b>7</b> of the information block include the activation controls and have the following format, in one example:</li>
</ul>
</li>
</ul>
<li> <div class="description-line" id="p-0159" num="0000">
<chemistry id="CHEM-US-00004" num="00004">
<div class="patent-image"><a href="https://patentimages.storage.googleapis.com/7d/08/be/714bf0c3bfb093/US20210263829A1-20210826-C00004.png"><img alt="Figure US20210263829A1-20210826-C00004" class="patent-full-image" file="US20210263829A1-20210826-C00004.TIF" he="59.18mm" height="237" id="EMI-C00004" img-content="chem" img-format="tif" inline="no" orientation="portrait" src="https://patentimages.storage.googleapis.com/7d/08/be/714bf0c3bfb093/US20210263829A1-20210826-C00004.png" wi="75.18mm" width="301"/></a></div>
<attachments>
<attachment attachment-type="cdx" file="US20210263829A1-20210826-C00004.CDX" idref="CHEM-US-00004"> </attachment>
<attachment attachment-type="mol" file="US20210263829A1-20210826-C00004.MOL" idref="CHEM-US-00004"> </attachment>
</attachments>
</chemistry>
</div> </li> <ul>
<li id="ul0031-0001" num="0000">
<ul>
<li id="ul0032-0001" num="0233">Maximum CPU Address <b>880</b>: Byte offsets <b>8</b>-<b>9</b> of the information block include the maximum CPU address at the basic machine level.</li>
<li id="ul0032-0002" num="0234">Counter Second Version Number (CSVN) <b>882</b>: Byte offsets <b>10</b>-<b>11</b> include the counter second version number.</li>
</ul>
</li>
</ul>
<li> <para-num num="[0235]"> </para-num> <div class="description-line" id="p-0160" num="0235">The Set Sampling Controls instruction, an example of which is described with reference to <figref idrefs="DRAWINGS">FIG. 9A</figref>, is used to update the sampling controls. In one embodiment, a Set Sampling Controls instruction <b>900</b> includes the following format, in one example:
</div> </li> <ul> <li id="ul0033-0001" num="0000"> <ul> <li id="ul0034-0001" num="0236">Op Code <b>902</b>: This field includes the operation code that specifies the Set Sampling Controls instruction;</li> <li id="ul0034-0002" num="0237">B<sub>2 </sub> <b>904</b> and D<sub>2 </sub> <b>906</b>: The contents of the general register designated by the B<sub>2 </sub>field are added to the contents of the D<sub>2 </sub>field to form a second operand address.</li> </ul> </li> </ul>
<li> <para-num num="[0238]"> </para-num> <div class="description-line" id="p-0161" num="0238">During instruction execution, the sampling controls in the request block in storage locations designated by the second operand address are placed in the corresponding sampling control registers. The values of the controls in the request block are provided by the operator and/or the control program (e.g., operating system running as a guest), as indicated below.</div>
</li> <li> <para-num num="[0239]"> </para-num> <div class="description-line" id="p-0162" num="0239">In one example, the request block is 64 bytes and includes the following fields, as described with reference to <figref idrefs="DRAWINGS">FIG. 9B</figref>:
</div> </li> <ul> <li id="ul0035-0001" num="0000"> <ul> <li id="ul0036-0001" num="0240">S <b>922</b>: Bit <b>0</b>, S, of the request block specifies the maximum buffer size indicator, as specified by the operator.</li> <li id="ul0036-0002" num="0241">H <b>924</b>: When the CPU is running at the logical partition level, bit <b>1</b>, H, of the request block is the host indicator. When the CPU is not running at the logical partition level, bit <b>1</b> is ignored and treated as zero. This is specified by the control program.</li> <li id="ul0036-0003" num="0242">E<sub>s </sub> <b>926</b>: Bit <b>54</b>, E<sub>s</sub>, of the request block specifies the basic sampling enable control, which is set based on an input parameter from the operator;</li> <li id="ul0036-0004" num="0243">E<sub>d </sub> <b>928</b>: Bit <b>55</b>, E<sub>d</sub>, of the request block specifies the diagnostic sampling enable control, which is set based on an input parameter from the operator.</li> <li id="ul0036-0005" num="0244">C<sub>s </sub> <b>930</b>: Bit <b>62</b>, C<sub>s</sub>, of the request block specifies the basic sampling activation control, which is set based on an input parameter from the operator.</li> <li id="ul0036-0006" num="0245">C<sub>d </sub> <b>932</b>: Bit <b>63</b>, C<sub>d</sub>, of the requested block specifies the diagnostic sampling activation control, which is set based on an input parameter from the operator. Bits <b>2</b>-<b>53</b> (<b>925</b>) and <b>56</b>-<b>61</b> (<b>929</b>) of the request block are zeros.</li> </ul> </li> </ul>
<li> <para-num num="[0246]"> </para-num> <div class="description-line" id="p-0163" num="0246">The specified enable and activation controls of sampling functions are set only if both sampling functions can make a valid state transition. If a sampling function cannot make a valid state transition, the specified state controls are not set for any sampling function.</div>
</li> <li> <para-num num="[0247]"> </para-num> <div class="description-line" id="p-0164" num="0247">When a sampling function is set to the active state from the disabled, inactive, or active state, the additional controls, including the maximum buffer size indicator, the host indicator, sampling interval <b>934</b>, table entry address register contents <b>936</b>, and the data entry address register contents <b>938</b> are placed in the sampling control registers. When no sampling function is placed in the active state by the operation, the additional controls are ignored and are not placed in the sampling control registers.</div>
</li> <li> <para-num num="[0248]"> </para-num> <div class="description-line" id="p-0165" num="0248">When a sampling function is to be set to the active state from the disabled, inactive, or active state, and if the requested sampling interval is outside the supported range, no sampling control, including any state control, in the sampling control registers is changed and a specification exception is recognized. The supported sampling interval range is between the maximum and minimum sampling intervals, inclusively, provided by executing the Query Sampling Information instruction.</div>
</li> <li> <para-num num="[0249]"> </para-num> <div class="description-line" id="p-0166" num="0249">In one example, when the enable and activation controls for both sampling functions are set, condition code <b>0</b> is set. When the enable and activation controls are not set, condition code <b>3</b> is set.</div>
</li> <li> <para-num num="[0250]"> </para-num> <div class="description-line" id="p-0167" num="0250">The Set CPU Counter Set Controls instruction, an example of which is described with reference to <figref idrefs="DRAWINGS">FIG. 9C</figref>, is used to update the counter state controls. In one embodiment, a Set CPU Counter Set Controls instruction <b>950</b> includes the following format, in one example:
</div> </li> <ul> <li id="ul0037-0001" num="0000"> <ul> <li id="ul0038-0001" num="0251">Op Code <b>952</b>: This field includes the operation code that specifies the Set CPU Counter Set Controls instruction;</li> <li id="ul0038-0002" num="0252">B<sub>2 </sub> <b>954</b> and D<sub>2 </sub> <b>956</b>: The contents of the general register designated by the B<sub>2 </sub>field are added to the contents of the D<sub>2 </sub>field to form a second operand address.</li> </ul> </li> </ul>
<li> <para-num num="[0253]"> </para-num> <div class="description-line" id="p-0168" num="0253">During instruction execution, the CPU counter set state controls in storage locations designated by the second operand address are placed in the local counter state control register.</div>
</li> <li> <para-num num="[0254]"> </para-num> <div class="description-line" id="p-0169" num="0254">In one example, the second operand is 64 bits, and bits <b>44</b>-<b>47</b> and <b>60</b>-<b>63</b> of the second operand specify state controls for CPU counter sets. These bits include, for instance:
</div> </li> <ul> <li id="ul0039-0001" num="0000"> <ul> <li id="ul0040-0001" num="0255">Bit <b>44</b>, E<sub>c</sub>, of the second operand includes the enable control for the crypto-activity counter set.</li> <li id="ul0040-0002" num="0256">Bit <b>45</b>, E<sub>p</sub>, of the second operand includes the enable control for the problem counter set.</li> <li id="ul0040-0003" num="0257">Bit <b>46</b>, E<sub>b</sub>, of the second operand includes the enable control for the basic counter set.</li> <li id="ul0040-0004" num="0258">Bit <b>47</b>, E<sub>e</sub>, of the second operand includes the enable control for the extended counter set.</li> <li id="ul0040-0005" num="0259">Bit <b>60</b>, C<sub>c</sub>, of the second operand includes the activation control for the crypto-activity counter set.</li> <li id="ul0040-0006" num="0260">Bit <b>61</b>, C<sub>p</sub>, of the second operand includes the activation control for the problem counter set.</li> <li id="ul0040-0007" num="0261">Bit <b>62</b>, C<sub>b</sub>, of the second operand includes the activation control for the basic counter set.</li> <li id="ul0040-0008" num="0262">Bit <b>63</b>, C<sub>e</sub>, of the second operand includes the activation control for the extended counter set.</li> </ul> </li> </ul>
<li> <para-num num="[0263]"> </para-num> <div class="description-line" id="p-0170" num="0263">The specified state controls of the CPU counter sets are set if all CPU counter sets can make a valid state transition. If a counter set cannot make a valid state transition, the specified state controls are not set for any counter set, in one embodiment.</div>
</li> <li> <para-num num="[0264]"> </para-num> <div class="description-line" id="p-0171" num="0264">Described in detail above is a CPU measurement facility, which accumulates activity counts of specific events that occur within the hardware (such as cycle count, instruction count, etc.); and/or periodically takes a snapshot of the central processing unit on which it is executing, and records the CPU state information, including the instructions being executed (e.g., Op codes, whether there is a problem with an instruction, etc.) At each sampling time, the sample data is placed in a buffer. When the buffer has a defined amount of data, an interrupt is presented in order to remove data from the buffer.</div>
</li> <li> <para-num num="[0265]"> </para-num> <div class="description-line" id="p-0172" num="0265">In accordance with a further aspect of the present invention, the measurement facility is virtualized in order to support configurations of a virtual environment. In a virtual environment, the facility may be used by one or more guests independently and concurrently.</div>
</li> <li> <para-num num="[0266]"> </para-num> <div class="description-line" id="p-0173" num="0266">In yet a further aspect of the present invention, a technique is provided for deploying one or more aspects of the measurement logic on one or more processing units. One embodiment of the deployment logic is described with reference to <figref idrefs="DRAWINGS">FIGS. 10A-10B</figref>.</div>
</li> <li> <para-num num="[0267]"> </para-num> <div class="description-line" id="p-0174" num="0267">Referring to <figref idrefs="DRAWINGS">FIG. 10A</figref>, initially, a determination is made as to whether there are any programs that are to reside on one or more servers when the measurement logic is executed, INQUIRY <b>1000</b>. If so, then the one or more servers to include the executables are identified, STEP <b>1002</b>, and the measurement logic for the one or more servers is transferred directly to the servers' storage via, for instance, a File Transfer Protocol (FTP) or some other protocol or by copying through the use of a shared file system, STEP <b>1004</b>. The logic is then installed on the servers, STEP <b>1006</b>.</div>
</li> <li> <para-num num="[0268]"> </para-num> <div class="description-line" id="p-0175" num="0268">Thereafter, or if there are no executables, a further determination is made as to whether the measurement logic is to be deployed by having users access the logic on a server or servers, INQUIRY <b>1008</b>. If the users are to access the measurement logic on servers, then the server addresses that are to store the logic are identified, STEP <b>1010</b>. In one example, a determination is made as to whether a proxy server is to be built to store the measurement logic, INQUIRY <b>1012</b> (<figref idrefs="DRAWINGS">FIG. 10B</figref>). A proxy server is the server that sits between a client application, such as a web browser, and a real server. It intercepts the requests to the real server to see if it can fulfill the request itself. If not, it forwards the request to the real server. Two primary benefits of the proxy server are to improve performance and to filter requests. If a proxy server is to be built, then the proxy server is installed, STEP <b>1014</b>.</div>
</li> <li> <para-num num="[0269]"> </para-num> <div class="description-line" id="p-0176" num="0269">Thereafter, or if a proxy server is not to be built, the measurement logic is sent to the server either via a protocol, such as file transfer protocol (FTP), or it is copied directly from the source files to the server files via file sharing, STEP <b>1016</b>. As another example, a transaction is sent to the one or more servers that includes the measurement logic and the servers process the transaction, then receive and copy the logic to the servers' file systems.</div>
</li> <li> <para-num num="[0270]"> </para-num> <div class="description-line" id="p-0177" num="0270">After the measurement logic is stored at the servers, the users, via their client computers, access the logic on the servers and may copy at least a portion of the logic to their client computers' file systems, STEP <b>1018</b>. The user then executes the program that installs the logic on the client computer, STEP <b>1020</b>. In a further example, the servers automatically copy one or more aspects of the sampling logic to each client and then run the installation program for the logic at each client computer. This concludes one example of the deployment processing, STEP <b>1022</b>.</div>
</li> <li> <para-num num="[0271]"> </para-num> <div class="description-line" id="p-0178" num="0271">Returning to INQUIRY <b>1008</b> (<figref idrefs="DRAWINGS">FIG. 10A</figref>), if the logic is not to be deployed by having users access the logic on one or more servers, then processing continues with a determination as to whether the logic is to be deployed by sending the logic to users via e-mail, INQUIRY <b>1030</b>. If so, the set of users where the logic is to be deployed is identified together with the addresses of the user client computers, STEP <b>1032</b>. The measurement logic is sent via e-mail to each of the user's client computers, STEP <b>1034</b> (<figref idrefs="DRAWINGS">FIG. 10B</figref>). The users receive the e-mail, STEP <b>1036</b>, and detach the measurement logic from the e-mail to a directory on their client computers, STEP <b>1038</b>. The user executes the program that installs the logic on the client computer, STEP <b>1020</b>, and exits the process, STEP <b>1022</b>.</div>
</li> <li> <para-num num="[0272]"> </para-num> <div class="description-line" id="p-0179" num="0272">Returning to INQUIRY <b>1030</b> (<figref idrefs="DRAWINGS">FIG. 10A</figref>), if the measurement logic is not to be deployed via e-mail, then a further determination is made as to whether the logic is to be sent directly to user directories on their client computers, STEP <b>1040</b>. If so, the user directories are identified, STEP <b>1042</b>. The measurement logic is directly transferred to the user's client computer directory, STEP <b>1044</b> (<figref idrefs="DRAWINGS">FIG. 10B</figref>). This can be done in several ways, such as, but not limited to, sharing of the file system directories and then copying from the sender's file system to the recipient user's file system, or alternatively, using a transfer protocol, such as file transfer protocol (FTP). The users access the directories on their client file systems in preparation for installing the measurement logic, STEP <b>1046</b>. The user executes the program that installs the logic on the client computer, STEP <b>1020</b>, and exits the deployment process, STEP <b>1022</b>.</div>
</li> <li> <para-num num="[0273]"> </para-num> <div class="description-line" id="p-0180" num="0273">Returning to INQUIRY <b>1040</b> (<figref idrefs="DRAWINGS">FIG. 10A</figref>), if the logic is not to be sent directly to the users' directories, then processing ends, STEP <b>1050</b>.</div>
</li> <li> <para-num num="[0274]"> </para-num> <div class="description-line" id="p-0181" num="0274">Although an embodiment of deploying logic is provided, many variations can be made without departing from the spirit of the present invention.</div>
</li> <li> <para-num num="[0275]"> </para-num> <div class="description-line" id="p-0182" num="0275">One or more aspects of the present invention can be provided, offered, deployed, managed, serviced, etc. by a service provider who offers management of customer environments. For instance, the service provider can create, maintain, support, etc. computer code and/or a computer infrastructure that performs one or more aspects of the present invention for one or more customers. In return, the service provider can receive payment from the customer under a subscription and/or fee agreement, as examples. Additionally or alternatively, the service provider can receive payment from the sale of advertising content to one or more third parties.</div>
</li> <li> <para-num num="[0276]"> </para-num> <div class="description-line" id="p-0183" num="0276">In one aspect of the present invention, an application can be deployed for performing one or more aspects of the present invention, as described above. As one example, the deploying of an application comprises providing computer infrastructure operable to perform one or more aspects of the present invention.</div>
</li> <li> <para-num num="[0277]"> </para-num> <div class="description-line" id="p-0184" num="0277">As a further aspect of the present invention, a computing infrastructure can be deployed comprising integrating computer readable code into a computing system, in which the code in combination with the computing system is capable of performing one or more aspects of the present invention.</div>
</li> <li> <para-num num="[0278]"> </para-num> <div class="description-line" id="p-0185" num="0278">As yet a further aspect of the present invention, a process for integrating computing infrastructure, comprising integrating computer readable code into a computer system may be provided. The computer system comprises a computer usable medium, in which the computer usable medium comprises one or more aspects of the present invention. The code in combination with the computer system is capable of performing one or more aspects of the present invention.</div>
</li> <li> <para-num num="[0279]"> </para-num> <div class="description-line" id="p-0186" num="0279">One or more aspects of the present invention can be included in an article of manufacture (e.g., one or more computer program products) having, for instance, computer usable media. The media has therein, for instance, computer readable program code means or logic (e.g., instructions, code, commands, etc.) to provide and facilitate the capabilities of the present invention. The article of manufacture can be included as a part of a computer system or sold separately.</div>
</li> <li> <para-num num="[0280]"> </para-num> <div class="description-line" id="p-0187" num="0280">One example of an article of manufacture or a computer program product incorporating one or more aspects of the present invention is described with reference to <figref idrefs="DRAWINGS">FIG. 11</figref>. A computer program product <b>1100</b> includes, for instance, one or more computer usable media <b>1102</b> to store computer readable program code means or logic <b>1104</b> thereon to provide and facilitate one or more aspects of the present invention. The medium can be an electronic, magnetic, optical, electromagnetic, infrared, or semiconductor system (or apparatus or device) or a propagation medium. Examples of a computer readable medium include a semiconductor or solid state memory, magnetic tape, a removable computer diskette, a random access memory (RAM), a read-only memory (ROM), a rigid magnetic disk and an optical disk. Examples of optical disks include compact disk-read only memory (CD-ROM), compact disk-read/write (CD-R/W) and DVD.</div>
</li> <li> <para-num num="[0281]"> </para-num> <div class="description-line" id="p-0188" num="0281">A sequence of program instructions or a logical assembly of one or more interrelated modules defined by one or more computer readable program code means or logic direct the performance of one or more aspects of the present invention.</div>
</li> <li> <para-num num="[0282]"> </para-num> <div class="description-line" id="p-0189" num="0282">Advantageously, the measurement facility of one or more aspects of the present invention is concurrently usable by a plurality of guests of a virtual environment. Each guest has control over whether the facility is enabled for that guest. It can be enabled on a subset or all of the logical processors within the virtual environment. Controls are separately maintained to protect the integrity of the guest's data.</div>
</li> <li> <para-num num="[0283]"> </para-num> <div class="description-line" id="p-0190" num="0283">Advantageously, the measurement facility of one or more aspects of the present invention does not require an interrupt each time a measurement is performed. Instead, an interrupt is performed only when it is determined that a marked sample data block is approximately full (e.g., not enough space to store next data entry) or at a desired time. By decreasing the number of interrupts, system performance is enhanced. Further, by freeing the buffer, the same buffer is repeatedly used, therefore, decreasing the amount of buffer space needed.</div>
</li> <li> <para-num num="[0284]"> </para-num> <div class="description-line" id="p-0191" num="0284">Although various embodiments are described above, these are only examples. For instance, although various instructions are described herein, one or more aspects of the present invention can use other than instructions, such as commands, functions, etc. Further, the format of the instructions may be different, including different fields, different size fields, different positioning, etc. Yet further, the information of entities (e.g., request blocks, fields of entries, information blocks) described herein can have different information, the size of the fields can be different, as well as the positioning. Reserved fields or those with zeros may have been eliminated from the entities. Moreover, some of the information in the entities may not be used or needed for one or more aspects of the present invention. Many other variations can be made.</div>
</li> <li> <para-num num="[0285]"> </para-num> <div class="description-line" id="p-0192" num="0285">Although an example of a processing environment is provided herein, this is only one example. Many other examples of processing environments may incorporate and use one or more aspects of the present invention. For example, a processing environment may have only one CPU supporting one or more guests. In a further example, a processing environment may be executing different control programs than described herein. Yet further, a processing environment may be executing a virtual machine, such as z/VM®, offered by International Business Machines Corporation (z/VM® is a registered trademark of International Business Machines Corporation). In one example, when VM is running in a logical partition, if VM is collecting sample data for guests, then VM shall set the host indicator to one. This would cause the contents of the program parameter register set at the logical partition level to be stored in the host program parameter field of data entries in VM sample data blocks and cause the contents of the parameter-parameter register set at the virtual machine level to be stored in the guest program parameter field of data entries in VM sample data blocks. In this case, the contents of the program parameter register set at the virtual machine level are set by the guest and may specify a task ID; the contents of the program parameter register set at the logical partition level are set by VM and may specify a guest ID. The combination of these two uniquely identify a guest task that contributed to the sample data. Many other variations are also possible.</div>
</li> <li> <para-num num="[0286]"> </para-num> <div class="description-line" id="p-0193" num="0286">Further, other types of computing environments can benefit from one or more aspects of the present invention. As an example, an environment may include an emulator (e.g., software or other emulation mechanisms), in which a particular architecture (including, for instance, instruction execution, architected functions, such as address translation, and architected registers) or a subset thereof is emulated (e.g., on a native computer system having a processor and memory). In such an environment, one or more emulation functions of the emulator can implement one or more aspects of the present invention, even though a computer executing the emulator may have a different architecture than the capabilities being emulated. As one example, in emulation mode, the specific instruction or operation being emulated is decoded, and an appropriate emulation function is built to implement the individual instruction or operation.</div>
</li> <li> <para-num num="[0287]"> </para-num> <div class="description-line" id="p-0194" num="0287">In an emulation environment, a host computer includes, for instance, a memory to store instructions and data; an instruction fetch unit to fetch instructions from memory and to optionally, provide local buffering for the fetched instruction; an instruction decode unit to receive the instruction fetch unit and to determine the type of instructions that have been fetched; and an instruction execution unit to execute the instructions. Execution may include loading data into a register for memory; storing data back to memory from a register; or performing some type of arithmetic or logical operation, as determined by the decode unit. In one example, each unit is implemented in software. For instance, the operations being performed by the units are implemented as one or more subroutines within emulator software.</div>
</li> <li> <para-num num="[0288]"> </para-num> <div class="description-line" id="p-0195" num="0288">Further, a data processing system suitable for storing and/or executing program code is usable that includes at least one processor coupled directly or indirectly to memory elements through a system bus. The memory elements include, for instance, local memory employed during actual execution of the program code, bulk storage, and cache memory which provide temporary storage of at least some program code in order to reduce the number of times code must be retrieved from bulk storage during execution.</div>
</li> <li> <para-num num="[0289]"> </para-num> <div class="description-line" id="p-0196" num="0289">Input/Output or I/O devices (including, but not limited to, keyboards, displays, pointing devices, DASD, tape, CDs, DVDs, thumb drives and other memory media, etc.) can be coupled to the system either directly or through intervening I/O controllers. Network adapters may also be coupled to the system to enable the data processing system to become coupled to other data processing systems or remote printers or storage devices through intervening private or public networks. Modems, cable modems, and Ethernet cards are just a few of the available types of network adapters.</div>
</li> <li> <para-num num="[0290]"> </para-num> <div class="description-line" id="p-0197" num="0290">The capabilities of one or more aspects of the present invention can be implemented in software, firmware, hardware, or some combination thereof. At least one program storage device readable by a machine embodying at least one program of instructions executable by the machine to perform the capabilities of the present invention can be provided.</div>
</li> <li> <para-num num="[0291]"> </para-num> <div class="description-line" id="p-0198" num="0291">The flow diagrams depicted herein are just examples. There may be many variations to these diagrams or the steps (or operations) described therein without departing from the spirit of the invention. For instance, the steps may be performed in a differing order, or steps may be added, deleted, or modified. All of these variations are considered a part of the claimed invention.</div>
</li> <li> <para-num num="[0292]"> </para-num> <div class="description-line" id="p-0199" num="0292">As used herein, the term obtaining includes, but is not limited to, receiving, being provided, retrieving, determining, accessing, etc.</div>
</li> <li> <para-num num="[0293]"> </para-num> <div class="description-line" id="p-0200" num="0293">Although embodiments have been depicted and described in detail herein, it will be apparent to those skilled in the relevant art that various modifications, additions, substitutions and the like can be made without departing from the spirit of the invention and these are therefore considered to be within the scope of the invention as defined in the following claims.</div>
</li> </ul>
</div>
</section><section itemprop="claims" itemscope="">
<h2>Claims (<span itemprop="count">20</span>)</h2>
<div html="" itemprop="content"><div class="claims" lang="EN" load-source="patent-office" mxw-id="PCLM296734992">
<claim-statement>What is claimed is:</claim-statement>
<div class="claim"> <div class="claim" id="CLM-00001" num="00001">
<div class="claim-text"> <b>1</b>. A computer program product to facilitate collection of data in a virtual processing environment, the computer program product comprising:
<div class="claim-text">a storage medium readable by a processing circuit and storing instructions for execution by the processing circuit for performing a method comprising:
<div class="claim-text">controlling by one guest of the virtual processing environment enablement of measurement relating to activities of the one guest; and</div>
<div class="claim-text">controlling by another guest of the virtual processing environment enablement of measurement relating to activities of the another guest, wherein the controlling by the one guest is independent of the controlling by the another guest, and wherein measurement is concurrently enabled for the one guest and the another guest, or enabled for one of the one guest and the another guest and not for the other of the one guest and the another guest.</div>
</div> </div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00002" num="00002">
<div class="claim-text"> <b>2</b>. The computer program product of <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the controlling by the one guest comprises enabling measurement, wherein the enabling comprises enabling measurement on a logical processor of the one guest.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00003" num="00003">
<div class="claim-text"> <b>3</b>. The computer program product of <claim-ref idref="CLM-00002">claim 2</claim-ref>, wherein the enablement comprises enabling at least one of sampling and counters for the one guest.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00004" num="00004">
<div class="claim-text"> <b>4</b>. The computer program product of <claim-ref idref="CLM-00002">claim 2</claim-ref>, wherein a logical processor of the one guest has associated therewith a measurement block assigned to that logical processor to maintain sampling data for the logical processor.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00005" num="00005">
<div class="claim-text"> <b>5</b>. The computer program product of <claim-ref idref="CLM-00004">claim 4</claim-ref>, wherein the logical processor has one or more control blocks associated therewith to maintain a state of measurement for the logical processor.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00006" num="00006">
<div class="claim-text"> <b>6</b>. The computer program product of <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the one guest executes in one logical partition of the virtual processing environment and the another guest executes in another logical partition of the virtual processing environment.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00007" num="00007">
<div class="claim-text"> <b>7</b>. The computer program product of <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the one guest is suspended, and wherein the method further comprises recording in a residual interval an amount of time remaining before a next sample is to be taken for the one guest.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00008" num="00008">
<div class="claim-text"> <b>8</b>. The computer program product of <claim-ref idref="CLM-00007">claim 7</claim-ref>, wherein the resuming occurs in response to a redispatch of the one guest, and wherein in response to the redispatch:
<div class="claim-text">an authorization check is performed to determine if the one guest is still authorized to perform measurement; and</div> <div class="claim-text">notification is provided to the one guest if the authorization check indicates the one guest is not authorized.</div> </div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00009" num="00009">
<div class="claim-text"> <b>9</b>. The computer program product of <claim-ref idref="CLM-00007">claim 7</claim-ref>, wherein sample data is written to a buffer, in response to the sampling.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00010" num="00010">
<div class="claim-text"> <b>10</b>. The computer program product of <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the controlling by the one guest comprises disabling measurement for the one guest, and wherein the controlling by the another guest comprises enabling measurement for the another guest.</div>
</div>
</div> <div class="claim"> <div class="claim" id="CLM-00011" num="00011">
<div class="claim-text"> <b>11</b>. A computer-implemented method of facilitating collection of data in a virtual processing environment, said method comprising:
<div class="claim-text">controlling by one guest of the virtual processing environment enablement of measurement relating to activities of the one guest; and</div> <div class="claim-text">controlling by another guest of the virtual processing environment enablement of measurement relating to activities of the another guest, wherein the controlling by the one guest is independent of the controlling by the another guest, and wherein measurement is concurrently enabled for the one guest and the another guest, or enabled for one of the one guest and the another guest and not for the other of the one guest and the another guest.</div> </div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00012" num="00012">
<div class="claim-text"> <b>12</b>. The computer-implemented method of <claim-ref idref="CLM-00011">claim 11</claim-ref>, wherein the controlling by the one guest comprises enabling measurement, wherein the enabling comprises enabling measurement on a logical processor of the one guest.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00013" num="00013">
<div class="claim-text"> <b>13</b>. The computer-implemented method of <claim-ref idref="CLM-00011">claim 11</claim-ref>, wherein the one guest is suspended, and wherein the method further comprises recording in a residual interval an amount of time remaining before a next sample is to be taken for the one guest.</div>
</div>
</div> <div class="claim"> <div class="claim" id="CLM-00014" num="00014">
<div class="claim-text"> <b>14</b>. A computer system for facilitating collection of data in a virtual processing environment, said computer system comprising:
<div class="claim-text">a memory; and</div> <div class="claim-text">a processor in communications with the memory, wherein the computer system is capable of performing a method comprising:
<div class="claim-text">controlling by one guest of the virtual processing environment enablement of measurement relating to activities of the one guest; and</div>
<div class="claim-text">controlling by another guest of the virtual processing environment enablement of measurement relating to activities of the another guest, wherein the controlling by the one guest is independent of the controlling by the another guest, and wherein measurement is concurrently enabled for the one guest and the another guest, or enabled for one of the one guest and the another guest and not for the other of the one guest and the another guest.</div>
</div> </div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00015" num="00015">
<div class="claim-text"> <b>15</b>. The computer system of <claim-ref idref="CLM-00014">claim 14</claim-ref>, wherein the controlling by the one guest comprises enabling measurement, wherein the enabling comprises enabling measurement on a logical processor of the one guest.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00016" num="00016">
<div class="claim-text"> <b>16</b>. The computer system of <claim-ref idref="CLM-00015">claim 15</claim-ref>, wherein a logical processor of the one guest has associated therewith a measurement block assigned to that logical processor to maintain sampling data for the logical processor.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00017" num="00017">
<div class="claim-text"> <b>17</b>. The computer system of <claim-ref idref="CLM-00016">claim 16</claim-ref>, wherein the logical processor has one or more control blocks associated therewith to maintain a state of measurement for the logical processor.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00018" num="00018">
<div class="claim-text"> <b>18</b>. The computer system of <claim-ref idref="CLM-00014">claim 14</claim-ref>, wherein the one guest executes in one logical partition of the virtual processing environment and the another guest executes in another logical partition of the virtual processing environment.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00019" num="00019">
<div class="claim-text"> <b>19</b>. The computer system of <claim-ref idref="CLM-00014">claim 14</claim-ref>, wherein the one guest is suspended, and wherein the method further comprises recording in a residual interval an amount of time remaining before a next sample is to be taken for the one guest.</div>
</div>
</div> <div class="claim-dependent"> <div class="claim" id="CLM-00020" num="00020">
<div class="claim-text"> <b>20</b>. The computer system of <claim-ref idref="CLM-00019">claim 19</claim-ref>, wherein the resuming occurs in response to a redispatch of the one guest, and wherein in response to the redispatch:
<div class="claim-text">an authorization check is performed to determine if the one guest is still authorized to perform measurement; and</div> <div class="claim-text">notification is provided to the one guest if the authorization check indicates the one guest is not authorized.</div> </div>
</div>
</div> </div>
</div>
</section>
                </article>
            </search-app>
        </body>
    </html>
    